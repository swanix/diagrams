<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theme Creator - Swanix Diagrams</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="xdiagrams.js"></script>
    <link href="xdiagrams.css" rel="stylesheet">
    

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-color: #181c24;
            --bg-image: url("img/backgrounds/light-pattern.svg");
            --bg-opacity: 0.3;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            overflow: hidden;
            position: relative;
        }
        
        /* Overlay para controlar la opacidad del color de fondo */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            opacity: var(--bg-opacity);
            z-index: -2;
            pointer-events: none;
        }
        
        /* Contenedor principal del diagrama */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: var(--bg-color);
            height: 100vh;
            position: relative;
            z-index: 1;
            width: calc(100vw - 360px); /* Full width menos el sidebar */
        }
        
        /* Contenedor del diagrama con espacio para el topbar */
        .diagram-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: var(--bg-color);
            padding: 0;
            margin-top: 0;
            height: 100vh;
                width: 100%;
            min-height: 400px;
        }

        .theme-creator-container {
            display: flex;
            height: 100vh;
            background: transparent;
            width: 100vw;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }



        .sidebar-header {
            padding: 20px 20px 15px;
            background: #0f0f0f;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sidebar-header h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #ffffff;
        }

        .sidebar-header p {
            opacity: 0.8;
            font-size: 13px;
            color: #b0b0b0;
        }

        .sidebar-content {
            padding: 10px 20px;
            padding-bottom: 80px;
            height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .variable-group {
            margin-bottom: 15px;
        }
        
        .variable-group:first-child h3 {
            margin-top: 0;
        }

        .variable-group h3 {
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 10px;
            margin-top: 15px;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            text-align: left;
        }

        .variable-item {
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 90px 1fr 32px 28px;
            align-items: center;
            gap: 8px;
            min-height: 28px;
        }

        .variable-item:last-child {
            margin-bottom: 0;
        }

        .variable-label {
            font-size: 9px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #b0b0b0;
            width: 90px;
            flex-shrink: 0;
            line-height: 1.2;
        }



        .color-picker {
            width: 28px;
            height: 28px;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            background: var(--picker-color, #ffffff);
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .color-picker:hover {
            transform: scale(1.05);
            border-color: #666;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        .color-picker::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            pointer-events: none;
        }

        .color-picker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: var(--picker-color, #ffffff);
            border-radius: 2px;
            pointer-events: none;
            z-index: 1;
        }

        /* Estilos para el input de color nativo */
        .color-picker input[type="color"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0;
            z-index: 2;
        }

        .color-picker input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-picker input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 6px;
        }

        .color-picker input[type="color"]::-moz-color-swatch {
            border: none;
            border-radius: 6px;
        }



        .text-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 11px;
            font-family: 'Monaco', 'Menlo', monospace;
            background: #2a2a2a;
            color: #e0e0e0;
            height: 28px;
            max-width: 120px;
        }

        .text-input::placeholder {
            color: #888;
        }

        .text-input:focus {
            outline: none;
            border-color: #666;
            box-shadow: 0 0 0 2px rgba(102, 102, 102, 0.2);
        }



        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }

        .btn-primary {
            background: #333;
            color: #e0e0e0;
            border: 1px solid #444;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-secondary {
            background: #333;
            color: #e0e0e0;
            border: 1px solid #444;
        }

        .btn-danger {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
            color: #212529;
        }

        .filter-preview {
            width: 28px;
            height: 28px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            filter: var(--preview-filter, none);
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .filter-input {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }

        .bg-image-preview {
            width: 28px;
            height: 28px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            background: var(--preview-bg, none);
            background-size: cover;
            background-position: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            flex-shrink: 0;
            position: relative;
        }

        .bg-image-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }

        .bg-image-input {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }

        .opacity-preview {
            width: 28px;
            height: 28px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            opacity: var(--preview-opacity, 0.9);
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }



        .theme-name-input {
            padding: 6px 8px;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 11px;
            width: 100%;
            background: #2a2a2a;
            color: #e0e0e0;
            height: 28px;
        }

        .theme-name-input::placeholder {
            color: #888;
        }

        .theme-name-input:focus {
            outline: none;
            border-color: #666;
            box-shadow: 0 0 0 2px rgba(102, 102, 102, 0.2);
        }

        .theme-selector-input {
            padding: 6px 8px;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 11px;
            width: 100%;
            background: #2a2a2a;
            color: #e0e0e0;
            cursor: pointer;
            height: 28px;
        }

        .theme-selector-input option {
            background: #1a1a1a;
            color: #e0e0e0;
        }

        .theme-selector-input:focus {
            outline: none;
            border-color: #666;
            box-shadow: 0 0 0 2px rgba(102, 102, 102, 0.2);
        }





        .copy-feedback {
            position: fixed;
            top: 30px;
            right: 30px;
            background: #333333;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1000;
            font-weight: 600;
        }

        .copy-feedback.show {
            transform: translateX(0);
        }



        .diagram-container svg {
            width: 100% !important;
            height: 100% !important;
            display: block;
            min-height: 400px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #dc3545;
            text-align: center;
            padding: 20px;
        }

        .actions-section {
            padding: 15px 20px;
            background: #0f0f0f;
            border-top: 1px solid #333;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .actions-grid .btn {
            font-size: 11px;
            padding: 8px 12px;
        }

        /* Layout con panel lateral de altura completa */
        body {
            margin: 0;
            padding: 0;
        }
        
            .theme-creator-container {
            display: flex;
            height: 100vh;
            background: #fff;
            }
            
        /* Panel lateral con altura completa */
            .sidebar {
            width: 360px;
            background: #1a1a1a;
            color: #e0e0e0;
            overflow-y: auto;
            padding: 0;
            flex-shrink: 0;
            position: relative;
            height: 100vh;
        }
        
        /* Scroll minimalista para todos los paneles */
        .sidebar::-webkit-scrollbar,
        .side-panel::-webkit-scrollbar,
        .panel-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track,
        .side-panel::-webkit-scrollbar-track,
        .panel-content::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .sidebar::-webkit-scrollbar-thumb,
        .side-panel::-webkit-scrollbar-thumb,
        .panel-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            transition: background 0.3s ease;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover,
        .side-panel::-webkit-scrollbar-thumb:hover,
        .panel-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Scroll para Firefox */
        .sidebar,
        .side-panel,
        .panel-content {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
        }
        
        /* Topbar solo en el área del diagrama */
        .topbar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: var(--bg-color, #fff) !important;
            color: var(--text-color, #333) !important;
        }
        
        /* Asegurar que los elementos del topbar usen las variables CSS */
        .topbar {
            background: var(--topbar-bg, var(--bg-color, #fff)) !important;
            color: var(--topbar-text, var(--text-color, #333)) !important;
        }
        
        .topbar .control-item,
        .topbar .theme-selector {
            background: var(--control-bg, #fff) !important;
            color: var(--control-text, var(--text-color, #333)) !important;
            border-color: var(--control-border, #ddd) !important;
        }
        
        .topbar .diagram-title {
            color: var(--topbar-text, var(--text-color, #333)) !important;
        }
        
        /* Panel lateral del diagrama (el que se abre al hacer clic en nodos) */
        .side-panel {
            background: var(--sidepanel-bg, var(--bg-color, #fff)) !important;
            color: var(--sidepanel-text, var(--text-color, #333)) !important;
            border-left: 1px solid var(--sidepanel-border, var(--label-border, #ddd)) !important;
        }
        
        .side-panel .panel-header {
            background: var(--node-fill, #f8f9fa) !important;
            border-bottom: 1px solid var(--sidepanel-border, var(--label-border, #ddd)) !important;
            color: var(--sidepanel-text, var(--text-color, #333)) !important;
        }
        
        .side-panel .panel-content {
            background: var(--sidepanel-bg, var(--bg-color, #fff)) !important;
            color: var(--sidepanel-text, var(--text-color, #333)) !important;
        }
        

        


        /* Botón de reset individual */
        .reset-individual-btn {
            background: #333;
            color: #e0e0e0;
            font-size: 9px;
            padding: 4px 6px;
            border: 1px solid #444;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
            width: 32px;
            height: 28px;
            flex-shrink: 0;
        }

        .reset-individual-btn:hover {
            background: #444;
            transform: scale(1.05);
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }

        .reset-individual-btn:active {
            transform: scale(0.95);
        }
        
        /* Estilos para el contenedor xcanvas (template simple) */
        .xcanvas {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: var(--text-color);
            position: relative;
            height: 100vh;
            width: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        
        /* Pseudo-elemento para la imagen de fondo */
        .xcanvas::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            z-index: -2;
            pointer-events: none;
        }
        
        /* Pseudo-elemento para el overlay del color de fondo */
        .xcanvas::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            opacity: var(--bg-opacity);
            z-index: -1;
            pointer-events: none;
        }
        
        /* Asegurar que el contenedor tenga las mismas propiedades */
        .xcanvas,
        .xcanvas * {
            box-sizing: border-box;
        }
        
        /* Ajustar el SVG para que funcione dentro del contenedor */
        .xcanvas svg {
            width: 100%;
            height: 100vh;
            display: block;
        }
        
        /* Ajustar el topbar para que funcione dentro del contenedor */
        .xcanvas .topbar {
            position: relative;
            width: 100%;
            z-index: 10;
            margin: 0;
            padding: 0 20px;
        }
        
        /* Ajustar el loading para que funcione dentro del contenedor */
        .xcanvas #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
        }
        
        /* Ajustar el error message para que funcione dentro del contenedor */
        .xcanvas .error-message {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5;
        }
        
        /* Ajustar el side panel para que funcione dentro del contenedor */
        .xcanvas .side-panel {
            position: absolute;
            top: 0;
            right: -400px; /* Oculto por defecto */
            height: 100vh;
            z-index: 20;
            transition: right 0.3s ease-in-out;
        }
        
        .xcanvas .side-panel.open {
            right: 0;
        }
        
        /* Ajustar el side panel overlay para que funcione dentro del contenedor */
        .xcanvas .side-panel-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 15;
        }
    </style>
</head>
<body>




    <div class="theme-creator-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Theme Creator</h2>
                <p>Create and customize themes for your diagrams</p>
            </div>
            <div class="sidebar-content">
                <div class="variable-group">
                    <h3>Select Base Theme</h3>
                    <div class="variable-item">
                        <label class="variable-label">Preset Theme</label>
                        <select id="theme-selector-visible" class="theme-selector-input">
                            <option value="snow">Snow</option>
                            <option value="onyx">Onyx</option>
                            <option value="vintage">Vintage</option>
                            <option value="pastel">Pastel</option>
                            <option value="neon">Neon</option>
                        </select>
                    </div>
                </div>

            <div class="variable-group">
                <h3>Theme Information</h3>
                <div class="variable-item">
                    <label class="variable-label">Theme Name</label>
                    <input type="text" id="theme-name" class="theme-name-input" placeholder="my-custom-theme" value="custom-theme">
                </div>
            </div>

            <div class="variable-group">
                <h3>Base Colors</h3>
                <div class="variable-item">
                    <label class="variable-label">Background Color</label>
                    <input type="text" class="text-input" data-var="--bg-color" value="#ecf2fd">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--bg-color', '#ecf2fd')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--bg-color" data-color="#ecf2fd" style="--picker-color: #ecf2fd; background-color: #ecf2fd;">
                        <input type="color" value="#ecf2fd">
                    </div>
                </div>
                <div class="variable-item">
                    <label class="variable-label">Text Color</label>
                    <input type="text" class="text-input" data-var="--text-color" value="#222">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--text-color', '#222')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--text-color" data-color="#222" style="--picker-color: #222; background-color: #222;">
                        <input type="color" value="#222">
                    </div>
                </div>
            </div>

            <div class="variable-group">
                <h3>Nodes</h3>
                <div class="variable-item">
                    <label class="variable-label">Node Background</label>
                    <input type="text" class="text-input" data-var="--node-fill" value="#fff">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--node-fill', '#fff')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--node-fill" data-color="#fff" style="--picker-color: #fff; background-color: #fff;">
                        <input type="color" value="#fff">
                    </div>
                </div>
                <div class="variable-item">
                    <label class="variable-label">Node Border</label>
                    <input type="text" class="text-input" data-var="--label-border" value="#bdbdbd">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--label-border', '#bdbdbd')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--label-border" data-color="#bdbdbd" style="--picker-color: #bdbdbd; background-color: #bdbdbd;">
                        <input type="color" value="#bdbdbd">
                    </div>
                </div>
                <div class="variable-item">
                    <label class="variable-label">Selected Node</label>
                    <input type="text" class="text-input" data-var="--node-selection-focus" value="#1976d2">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--node-selection-focus', '#1976d2')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--node-selection-focus" data-color="#1976d2" style="--picker-color: #1976d2; background-color: #1976d2;">
                        <input type="color" value="#1976d2">
                    </div>
                </div>
            </div>

            <div class="variable-group">
                <h3>Links</h3>
                <div class="variable-item">
                    <label class="variable-label">Link Color</label>
                    <input type="text" class="text-input" data-var="--link-color" value="#999">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--link-color', '#999')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--link-color" data-color="#999" style="--picker-color: #999; background-color: #999;">
                        <input type="color" value="#999">
                    </div>
                </div>
            </div>



            <div class="variable-group">
                <h3>Image Filters</h3>
                <div class="variable-item" style="grid-template-columns: 90px 1fr 32px 28px;">
                    <label class="variable-label">Thumbnail Filter</label>
                    <input type="text" class="text-input filter-input" data-var="--image-filter" value="grayscale(30%)" placeholder="grayscale(30%)" style="max-width: none;">
                    <button class="reset-individual-btn" onclick="resetFilter()" title="Reset to original value">↺</button>
                    <div class="filter-preview" style="--preview-filter: grayscale(30%)"></div>
                    </div>
                </div>

            <div class="variable-group">
                <h3>Topbar</h3>
                <div class="variable-item">
                    <label class="variable-label">Topbar Background</label>
                    <input type="text" class="text-input" data-var="--topbar-bg" value="#ffffff">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--topbar-bg', '#ffffff')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--topbar-bg" data-color="#ffffff" style="--picker-color: #ffffff; background-color: #ffffff;">
                        <input type="color" value="#ffffff">
                    </div>
                </div>
                <div class="variable-item">
                    <label class="variable-label">Topbar Text</label>
                    <input type="text" class="text-input" data-var="--topbar-text" value="#333333">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--topbar-text', '#333333')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--topbar-text" data-color="#333333" style="--picker-color: #333333; background-color: #333333;">
                        <input type="color" value="#333333">
                    </div>
                </div>
            </div>

            <div class="variable-group">
                <h3>Diagram Side Panel</h3>
                <div class="variable-item">
                    <label class="variable-label">Panel Background</label>
                    <input type="text" class="text-input" data-var="--sidepanel-bg" value="#ffffff">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--sidepanel-bg', '#ffffff')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--sidepanel-bg" data-color="#ffffff" style="--picker-color: #ffffff; background-color: #ffffff;">
                        <input type="color" value="#ffffff">
                    </div>
                </div>
                <div class="variable-item">
                    <label class="variable-label">Panel Text</label>
                    <input type="text" class="text-input" data-var="--sidepanel-text" value="#333333">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--sidepanel-text', '#333333')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--sidepanel-text" data-color="#333333" style="--picker-color: #333333; background-color: #333333;">
                        <input type="color" value="#333333">
                    </div>
                </div>
                <div class="variable-item">
                    <label class="variable-label">Panel Border</label>
                    <input type="text" class="text-input" data-var="--sidepanel-border" value="#dddddd">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--sidepanel-border', '#dddddd')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--sidepanel-border" data-color="#dddddd" style="--picker-color: #dddddd; background-color: #dddddd;">
                        <input type="color" value="#dddddd">
                    </div>
                </div>
            </div>

            <div class="variable-group">
                <h3>Controls (Inputs, Dropdowns, Buttons)</h3>
                <div class="variable-item">
                    <label class="variable-label">Control Background</label>
                    <input type="text" class="text-input" data-var="--control-bg" value="#ffffff">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--control-bg', '#ffffff')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--control-bg" data-color="#ffffff" style="--picker-color: #ffffff; background-color: #ffffff;">
                        <input type="color" value="#ffffff">
                    </div>
                </div>
                <div class="variable-item">
                    <label class="variable-label">Control Text</label>
                    <input type="text" class="text-input" data-var="--control-text" value="#333333">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--control-text', '#333333')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--control-text" data-color="#333333" style="--picker-color: #333333; background-color: #333333;">
                        <input type="color" value="#333333">
                    </div>
                </div>
                <div class="variable-item">
                    <label class="variable-label">Control Border</label>
                    <input type="text" class="text-input" data-var="--control-border" value="#d1d5db">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--control-border', '#d1d5db')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--control-border" data-color="#d1d5db" style="--picker-color: #d1d5db; background-color: #d1d5db;">
                        <input type="color" value="#d1d5db">
            </div>
                </div>
                <div class="variable-item">
                    <label class="variable-label">Border Hover</label>
                    <input type="text" class="text-input" data-var="--control-border-hover" value="#9ca3af">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--control-border-hover', '#9ca3af')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--control-border-hover" data-color="#9ca3af" style="--picker-color: #9ca3af; background-color: #9ca3af;">
                        <input type="color" value="#9ca3af">
                    </div>
                </div>
                <div class="variable-item">
                    <label class="variable-label">Border Focus</label>
                    <input type="text" class="text-input" data-var="--control-border-focus" value="#1976d2">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--control-border-focus', '#1976d2')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--control-border-focus" data-color="#1976d2" style="--picker-color: #1976d2; background-color: #1976d2;">
                        <input type="color" value="#1976d2">
                    </div>
                </div>
                <div class="variable-item">
                    <label class="variable-label">Placeholder</label>
                    <input type="text" class="text-input" data-var="--control-placeholder" value="#9ca3af">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--control-placeholder', '#9ca3af')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--control-placeholder" data-color="#9ca3af" style="--picker-color: #9ca3af; background-color: #9ca3af;">
                        <input type="color" value="#9ca3af">
                    </div>
                </div>
            </div>

            <div class="variable-group">
                <h3>Background Image & Overlay</h3>
                <div class="variable-item" style="grid-template-columns: 90px 1fr 32px 28px;">
                    <label class="variable-label">Image URL</label>
                    <input type="text" class="text-input bg-image-input" data-var="--bg-image" value="none" placeholder="url('https://example.com/image.jpg')" style="max-width: none;">
                    <button class="reset-individual-btn" onclick="resetBgImage()" title="Reset to original value">↺</button>
                    <div class="bg-image-preview" style="--preview-bg: none"></div>
                </div>
                <div class="variable-item">
                    <label class="variable-label">Background Overlay Opacity</label>
                    <input type="text" class="text-input" data-var="--bg-opacity" value="0.9">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--bg-opacity', '0.9')" title="Reset to original value">↺</button>
                    <div class="opacity-preview" style="--preview-opacity: 0.9"></div>
            </div>
            <div class="variable-group">
                <h3>Clusters</h3>
                <div class="variable-item">
                    <label class="variable-label">Cluster Background</label>
                    <input type="text" class="text-input" data-var="--cluster-bg" value="rgba(0,0,0,0.05)">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--cluster-bg', 'rgba(0,0,0,0.05)')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--cluster-bg" data-color="rgba(0,0,0,0.05)" style="--picker-color: rgba(0,0,0,0.05); background-color: rgba(0,0,0,0.05);">
                        <input type="color" value="#000000">
                    </div>
                </div>
                <div class="variable-item">
                    <label class="variable-label">Cluster Border</label>
                    <input type="text" class="text-input" data-var="--cluster-stroke" value="rgba(0,0,0,0.1)">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--cluster-stroke', 'rgba(0,0,0,0.1)')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--cluster-stroke" data-color="rgba(0,0,0,0.1)" style="--picker-color: rgba(0,0,0,0.1); background-color: rgba(0,0,0,0.1);">
                        <input type="color" value="#000000">
                    </div>
                </div>
                <div class="variable-item">
                    <label class="variable-label">Cluster Title</label>
                    <input type="text" class="text-input" data-var="--cluster-title-color" value="#222">
                    <button class="reset-individual-btn" onclick="resetIndividualValue('--cluster-title-color', '#222')" title="Reset to original value">↺</button>
                    <div class="color-picker" data-var="--cluster-title-color" data-color="#222" style="--picker-color: #222; background-color: #222;">
                        <input type="color" value="#222222">
                    </div>
                </div>
            </div>
        </div>

            <div class="actions-section">
                <div class="actions-grid">
                    <button class="btn btn-secondary" onclick="resetToDefault()">Reset</button>
                    <button class="btn btn-primary" onclick="copyTheme()">Copy</button>
                    <button class="btn btn-danger" onclick="exportTheme()">Export</button>
            </div>
            </div>
        </div>
            </div>
    <div class="main-content">
            <div class="diagram-container">
                <!-- Contenedor usando template simple -->
                <div class="xcanvas">
                    <!-- El contenido se genera dinámicamente por xdiagrams.js -->
                </div>
            </div>
    </div>

    <div id="copy-feedback" class="copy-feedback">
        Theme copied to clipboard
    </div>

    <script>
        // Configuración de XDiagrams usando template simple
        window.$xDiagrams = {
            title: "Theme Creator - Swanix Diagrams",
            diagrams: [
                {
                    name: "Sample Diagram", 
                    url: "data/sample-diagram.csv"
                }
            ],
            options: {
                autoZoom: true,
                keyboardNavigation: true,
                sidePanel: true,
                tooltips: true,
                responsive: true
            }
        };

        // Inicializar el diagrama principal usando el primer diagrama de la configuración
        const firstDiagram = window.$xDiagrams.diagrams[0];
        if (firstDiagram) {
            initDiagram(firstDiagram.url);
        }

        // Variables CSS por defecto (usando las variables exactas del CSS)
        const defaultValues = {
            '--bg-color': '#ecf2fd',
            '--text-color': '#222',
            '--node-fill': '#fff',
            '--label-border': '#bdbdbd',
            '--node-selection-focus': '#1976d2',
            '--link-color': '#999',
            '--image-filter': 'grayscale(30%)',
            '--bg-image': 'none',
            '--bg-opacity': '0.9',
            '--topbar-bg': '#ffffff',
            '--topbar-text': '#333333',
            '--sidepanel-bg': '#ffffff',
            '--sidepanel-text': '#333333',
            '--sidepanel-border': '#dddddd',
            '--control-bg': '#ffffff',
            '--control-text': '#333333',
            '--control-border': '#d1d5db',
            '--control-border-hover': '#9ca3af',
            '--control-border-focus': '#1976d2',
            '--control-placeholder': '#9ca3af',
            '--control-shadow': 'rgba(0, 0, 0, 0.1)',
            '--control-shadow-focus': 'rgba(25, 118, 210, 0.2)',
            '--cluster-bg': 'rgba(0,0,0,0.05)',
            '--cluster-stroke': 'rgba(0,0,0,0.1)',
            '--cluster-title-color': '#222'
        };

        // Valores de los temas predefinidos
        const themeValues = {
            'snow': {
                '--bg-color': '#ecf2fd',
                '--text-color': '#222',
                '--node-fill': '#fff',
                '--node-stroke-focus': '#1976d2',
                '--label-border': '#bdbdbd',
                '--link-color': '#999',
                '--side-panel-bg': '#fff',
                '--side-panel-text': '#222',
                '--side-panel-header-bg': '#ecf2fd',
                '--side-panel-header-border': '#bdbdbd',
                '--side-panel-border': '#bdbdbd',
                '--side-panel-label': '#1976d2',
                '--side-panel-value': '#222',
                '--node-selection-border': '#bdbdbd',
                '--node-selection-focus': '#1976d2',
                '--node-selection-hover': '#1565c0',
                '--node-selection-selected': '#1976d2',
                '--image-filter': 'grayscale(30%)',
                '--loading-color': '#1976d2',
                '--loading-bg': '#ffffff',
                '--bg-image': 'url("img/backgrounds/light-pattern.svg")',
                '--bg-opacity': '0.9',
                '--control-bg': '#ffffff',
                '--control-text': '#333333',
                '--control-border': '#d1d5db',
                '--control-border-hover': '#9ca3af',
                '--control-border-focus': '#1976d2',
                '--control-placeholder': '#9ca3af',
                '--control-shadow': 'rgba(0, 0, 0, 0.1)',
                '--control-shadow-focus': 'rgba(25, 118, 210, 0.2)',
                '--topbar-bg': '#ffffff',
                '--topbar-text': '#333333',
                '--sidepanel-bg': '#ffffff',
                '--sidepanel-text': '#333333',
                '--sidepanel-border': '#dddddd',
                '--cluster-bg': 'rgba(0,0,0,0.05)',
                '--cluster-stroke': 'rgba(0,0,0,0.1)',
                '--cluster-title-color': '#222'
            },
            'onyx': {
                '--bg-color': '#181c24',
                '--text-color': '#f6f7f9',
                '--node-fill': '#23272f',
                '--node-stroke-focus': '#00eaff',
                '--label-border': '#444',
                '--link-color': '#666',
                '--side-panel-bg': '#23272f',
                '--side-panel-text': '#f6f7f9',
                '--side-panel-header-bg': '#23272f',
                '--side-panel-header-border': '#333',
                '--side-panel-border': '#333',
                '--side-panel-label': '#aaa',
                '--side-panel-value': '#fff',
                '--node-selection-border': '#444',
                '--node-selection-focus': '#00eaff',
                '--node-selection-hover': '#555',
                '--node-selection-selected': '#00eaff',
                '--image-filter': 'invert(100%) brightness(3.5) contrast(200%)',
                '--loading-color': '#00eaff',
                '--loading-bg': '#23272f',
                '--bg-image': 'url("img/backgrounds/dark-grid.svg")',
                '--bg-opacity': '0.9',
                '--control-bg': '#2d3748',
                '--control-text': '#e2e8f0',
                '--control-border': '#4a5568',
                '--control-border-hover': '#718096',
                '--control-border-focus': '#00eaff',
                '--control-placeholder': '#a0aec0',
                '--control-shadow': 'rgba(0, 0, 0, 0.3)',
                '--control-shadow-focus': 'rgba(0, 234, 255, 0.3)',
                '--topbar-bg': '#23272f',
                '--topbar-text': '#f6f7f9',
                '--sidepanel-bg': '#23272f',
                '--sidepanel-text': '#f6f7f9',
                '--sidepanel-border': '#333',
                '--cluster-bg': 'rgba(255,255,255,0.02)',
                '--cluster-stroke': 'rgba(255,255,255,0.1)',
                '--cluster-title-color': '#00eaff'
            },
            'vintage': {
                '--bg-color': '#f5e9da',
                '--text-color': '#7c4f20',
                '--node-fill': '#fffbe6',
                '--label-border': '#b97a56',
                '--node-selection-focus': '#8b4513',
                '--link-color': '#b97a56',
                '--image-filter': 'sepia(40%) brightness(1.1)',
                '--bg-image': 'url("img/backgrounds/vintage-texture.svg")',
                '--bg-opacity': '0.8',
                '--topbar-bg': '#fffbe6',
                '--topbar-text': '#7c4f20',
                '--sidepanel-bg': '#fffbe6',
                '--sidepanel-text': '#7c4f20',
                '--sidepanel-border': '#b97a56',
                '--control-bg': '#fef7e0',
                '--control-text': '#5d4037',
                '--control-border': '#d4a574',
                '--control-border-hover': '#b97a56',
                '--control-border-focus': '#8b4513',
                '--control-placeholder': '#a1887f',
                '--control-shadow': 'rgba(139, 69, 19, 0.2)',
                '--control-shadow-focus': 'rgba(139, 69, 19, 0.4)',
                '--cluster-bg': 'rgba(0,0,0,0.05)',
                '--cluster-stroke': 'rgba(0,0,0,0.1)',
                '--cluster-title-color': '#7c4f20'
            },
            'pastel': {
                '--bg-color': '#fdf6fb',
                '--text-color': '#7a7a7a',
                '--node-fill': '#fff',
                '--label-border': '#e0b1cb',
                '--node-selection-focus': '#b6b6f7',
                '--link-color': '#b6b6f7',
                '--image-filter': 'hue-rotate(15deg) saturate(0.8)',
                '--bg-image': 'url("img/backgrounds/pastel-dots.svg")',
                '--bg-opacity': '0.85',
                '--topbar-bg': '#fff',
                '--topbar-text': '#7a7a7a',
                '--sidepanel-bg': '#fff',
                '--sidepanel-text': '#7a7a7a',
                '--sidepanel-border': '#e0b1cb',
                '--control-bg': '#ffffff',
                '--control-text': '#7a7a7a',
                '--control-border': '#e8d5e0',
                '--control-border-hover': '#d4a5c0',
                '--control-border-focus': '#b6b6f7',
                '--control-placeholder': '#c4a8b8',
                '--control-shadow': 'rgba(182, 182, 247, 0.2)',
                '--control-shadow-focus': 'rgba(182, 182, 247, 0.4)',
                '--cluster-bg': 'rgba(0,0,0,0.05)',
                '--cluster-stroke': 'rgba(0,0,0,0.1)',
                '--cluster-title-color': '#b6b6f7'
            },
            'neon': {
                '--bg-color': '#0f0026',
                '--text-color': '#00ffe7',
                '--node-fill': '#1a0033',
                '--label-border': '#00ffe7',
                '--node-selection-focus': '#00ffe7',
                '--link-color': '#ff00c8',
                '--image-filter': 'invert(100%) brightness(3.5) contrast(200%)',
                '--bg-image': 'url("img/backgrounds/neon-grid.svg")',
                '--bg-opacity': '0.9',
                '--topbar-bg': '#1a0033',
                '--topbar-text': '#00ffe7',
                '--sidepanel-bg': '#1a0033',
                '--sidepanel-text': '#00ffe7',
                '--sidepanel-border': '#ff00c8',
                '--control-bg': '#2a0040',
                '--control-text': '#00ffe7',
                '--control-border': '#ff00c8',
                '--control-border-hover': '#ff33d6',
                '--control-border-focus': '#00ffe7',
                '--control-placeholder': '#7a4d8a',
                '--control-shadow': 'rgba(255, 0, 200, 0.3)',
                '--control-shadow-focus': 'rgba(0, 255, 231, 0.4)',
                '--cluster-bg': 'rgba(255,255,255,0.02)',
                '--cluster-stroke': 'rgba(255,255,255,0.1)',
                '--cluster-title-color': '#00ffe7'
            }
        };

        // Función para actualizar variable CSS
        function updateCSSVariable(varName, value) {
            document.documentElement.style.setProperty(varName, value);
            document.body.style.setProperty(varName, value);
            
            // Aplicar también al contenedor xcanvas del diagrama
            const container = document.querySelector('.xcanvas');
            if (container) {
                container.style.setProperty(varName, value);
            }
            
            // Aplicar también al topbar y sidebar para que reciban los estilos
            const topbar = document.querySelector('.topbar');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (topbar) topbar.style.setProperty(varName, value);
            if (sidebar) sidebar.style.setProperty(varName, value);
            if (mainContent) mainContent.style.setProperty(varName, value);
        }

        

        // Función para resetear filtro
        function resetFilter() {
            const filterInput = document.querySelector('[data-var="--image-filter"]');
            filterInput.value = 'none';
            updateCSSVariable('--image-filter', 'none');
        }

        // Función para resetear imagen de fondo
        function resetBgImage() {
            const bgImageInput = document.querySelector('[data-var="--bg-image"]');
            bgImageInput.value = 'none';
            updateCSSVariable('--bg-image', 'none');
        }

        // Función para resetear un valor individual
        async function resetIndividualValue(varName, originalValue) {
            // Obtener el tema actualmente seleccionado
            const selectedTheme = document.getElementById('theme-selector-visible').value;
            
            // Obtener el valor original del tema actual usando el sistema de temas de xdiagrams
            let themeValue = originalValue; // Valor por defecto
            
            try {
                if (window.getThemeVariables) {
                    const themeVariables = await window.getThemeVariables(selectedTheme);
                    if (themeVariables && themeVariables[varName]) {
                        themeValue = themeVariables[varName];
                    }
                }
            } catch (error) {
                console.warn('Error obteniendo variables del tema:', error);
            }
            
            console.log('Reseteando valor individual:', varName, 'a', themeValue, 'del tema:', selectedTheme);
            
            // Actualizar variable CSS
            updateCSSVariable(varName, themeValue);
                
            // Actualizar input de texto
            const textInput = document.querySelector('[data-var="' + varName + '"].text-input');
            if (textInput) {
                textInput.value = themeValue;
            }
                
            // Actualizar color picker si es un color
            if (varName !== '--image-filter' && varName !== '--bg-image' && varName !== '--bg-opacity') {
                const pickerElement = document.querySelector('[data-var="' + varName + '"].color-picker');
                const colorInput = pickerElement ? pickerElement.querySelector('input[type="color"]') : null;
                
                if (colorInput) {
                    colorInput.value = themeValue;
                }
                
                // Actualizar color del picker visual
                if (pickerElement) {
                    pickerElement.style.setProperty('--picker-color', themeValue);
                    pickerElement.style.backgroundColor = themeValue;
                }
            }
            
            // Limpiar el valor custom del localStorage
            const customValues = JSON.parse(localStorage.getItem('customThemeValues') || '{}');
            delete customValues[varName];
            localStorage.setItem('customThemeValues', JSON.stringify(customValues));
            
            // Actualizar SVG dinámicamente usando xdiagrams
            setTimeout(function() {
                if (window.updateSVGColors) {
                    window.updateSVGColors();
                }
            }, 50);
            
            console.log('Valor individual reseteado:', varName, '=', themeValue);
        }

        // Función para guardar un valor custom en localStorage
        function saveCustomValue(varName, value) {
            const customValues = JSON.parse(localStorage.getItem('customThemeValues') || '{}');
            customValues[varName] = value;
            localStorage.setItem('customThemeValues', JSON.stringify(customValues));
            console.log('Valor custom guardado:', varName, '=', value);
        }

        // Función para cargar valores custom desde localStorage
        function loadCustomValues() {
            const customValues = JSON.parse(localStorage.getItem('customThemeValues') || '{}');
            console.log('Valores custom cargados:', customValues);
            return customValues;
        }

        // Función para actualizar los atributos HTML de los color pickers
        function updateColorPickerAttributes(themeValues) {
            Object.keys(themeValues).forEach(function(varName) {
                const value = themeValues[varName];
                
                // Solo actualizar si es un color (no filtros ni imágenes)
                if (varName !== '--image-filter' && varName !== '--bg-image' && varName !== '--bg-opacity') {
                    const pickerElement = document.querySelector('[data-var="' + varName + '"].color-picker');
                    if (pickerElement) {
                        // Actualizar atributo data-color
                        pickerElement.setAttribute('data-color', value);
                        
                        // Actualizar el input de color
                        const colorInput = pickerElement.querySelector('input[type="color"]');
                        if (colorInput) {
                            colorInput.value = value;
                        }
                        
                        // Actualizar estilos visuales
                        pickerElement.style.setProperty('--picker-color', value);
                        pickerElement.style.backgroundColor = value;
                        
                        console.log('Color picker actualizado:', varName, '=', value);
                    }
                }
            });
        }

        // Función para aplicar valores custom de forma robusta
        function applyCustomValues() {
            const customValues = loadCustomValues();
            if (Object.keys(customValues).length > 0) {
                console.log('Aplicando valores custom guardados:', customValues);
                
                Object.keys(customValues).forEach(function(varName) {
                    const value = customValues[varName];
                    
                    // Aplicar variable CSS
                    document.documentElement.style.setProperty(varName, value);
                    document.body.style.setProperty(varName, value);
                    
                    // Aplicar también al contenedor xcanvas del diagrama
                    const container = document.querySelector('.xcanvas');
                    if (container) {
                        container.style.setProperty(varName, value);
                    }
                    
                    // Aplicar también al topbar y sidebar
                    const topbar = document.querySelector('.topbar');
                    const sidebar = document.querySelector('.sidebar');
                    const mainContent = document.querySelector('.main-content');
                    
                    if (topbar) topbar.style.setProperty(varName, value);
                    if (sidebar) sidebar.style.setProperty(varName, value);
                    if (mainContent) mainContent.style.setProperty(varName, value);
                    
                    // Actualizar controles
                    const textInput = document.querySelector('[data-var="' + varName + '"].text-input');
                    if (textInput) textInput.value = value;
                    
                    if (varName !== '--image-filter' && varName !== '--bg-image' && varName !== '--bg-opacity') {
                        const pickerElement = document.querySelector('[data-var="' + varName + '"].color-picker');
                        if (pickerElement) {
                            const colorInput = pickerElement.querySelector('input[type="color"]');
                            if (colorInput) colorInput.value = value;
                            pickerElement.style.setProperty('--picker-color', value);
                            pickerElement.style.backgroundColor = value;
                        }
                    }
                    
                    // Actualizar preview de imagen de fondo
                    if (varName === '--bg-image') {
                        const previewElement = document.querySelector('.bg-image-preview');
                        if (previewElement) {
                            previewElement.style.setProperty('--preview-bg', value);
                        }
                    }
                    
                    // Actualizar preview de opacidad
                    if (varName === '--bg-opacity') {
                        const previewElement = document.querySelector('.opacity-preview');
                        if (previewElement) {
                            previewElement.style.setProperty('--preview-opacity', value);
                        }
                    }
                });
                
                // Actualizar SVG dinámicamente
                setTimeout(function() {
                    if (window.updateSVGColors) {
                        window.updateSVGColors();
                    }
                }, 50);
            }
        }

        // Función para limpiar valores custom (usado en reset)
        function clearCustomValues() {
            localStorage.removeItem('customThemeValues');
            console.log('Valores custom limpiados');
        }

        // Función para resetear a valores del tema seleccionado usando xdiagrams
        async function resetToDefault() {
            // Obtener el tema seleccionado actualmente
            const selectedTheme = document.getElementById('theme-selector-visible').value;
            
            // Limpiar valores custom
            clearCustomValues();
            
            try {
                // Usar el sistema de temas de xdiagrams
                if (window.setTheme) {
                    await window.setTheme(selectedTheme);
                }

                // Obtener las variables del tema desde xdiagrams
                let themeToReset = {};
                if (window.getThemeVariables) {
                    themeToReset = await window.getThemeVariables(selectedTheme);
                }

                // Si no se pudo obtener el tema, usar el fallback local
                if (!themeToReset || Object.keys(themeToReset).length === 0) {
                    themeToReset = themeValues[selectedTheme] || defaultValues;
                    console.warn('Usando tema fallback local para reset:', selectedTheme);
                }
                
                Object.keys(themeToReset).forEach(function(varName) {
                    const value = themeToReset[varName];
                    updateCSSVariable(varName, value);
                    
                    // Actualizar controles
                    const textInput = document.querySelector('[data-var="' + varName + '"].text-input');
                    const pickerElement = document.querySelector('[data-var="' + varName + '"].color-picker');
                    const colorInput = pickerElement ? pickerElement.querySelector('input[type="color"]') : null;
                    
                    if (textInput) textInput.value = value;
                    if (colorInput) colorInput.value = value;
                    if (pickerElement && varName !== '--image-filter' && varName !== '--bg-image' && varName !== '--bg-opacity') {
                        pickerElement.style.setProperty('--picker-color', value);
                        pickerElement.style.backgroundColor = value;
                    }
                });

                // Actualizar atributos HTML de los color pickers
                updateColorPickerAttributes(themeToReset);
                
                // Actualizar SVG dinámicamente usando xdiagrams
                setTimeout(function() {
                    if (window.updateSVGColors) {
                        window.updateSVGColors();
                    }
                }, 50);
                
                console.log('Reseteado a valores del tema con xdiagrams:', selectedTheme);
            } catch (error) {
                console.error('Error reseteando tema con xdiagrams:', error);
                // Fallback al método anterior
                const themeToReset = themeValues[selectedTheme] || defaultValues;
                Object.keys(themeToReset).forEach(function(varName) {
                    const value = themeToReset[varName];
                    updateCSSVariable(varName, value);
                });
            }
        }

        // Función para copiar tema
        function copyTheme() {
            const themeName = document.getElementById('theme-name').value;
            const variables = {};
            
            document.querySelectorAll('[data-var]').forEach(function(element) {
                const varName = element.getAttribute('data-var');
                const value = element.value;
                if (!variables[varName]) {
                    variables[varName] = value;
                }
            });

            const cssCode = '/* Tema: ' + themeName + ' */\n' +
                'body.theme-' + themeName.replace(/[^a-zA-Z0-9]/g, '-') + ' {\n' +
                Object.keys(variables).map(function(varName) {
                    return '  ' + varName + ': ' + variables[varName] + ';';
                }).join('\n') + '\n}';

            navigator.clipboard.writeText(cssCode).then(function() {
                showCopyFeedback();
            });
        }

        // Función para mostrar feedback de copiado
        function showCopyFeedback() {
            const feedback = document.getElementById('copy-feedback');
            feedback.classList.add('show');
            setTimeout(function() {
                feedback.classList.remove('show');
            }, 3000);
        }

        // Función para aplicar tema
        function applyTheme(showFeedback = true) {
            const themeName = document.getElementById('theme-name').value;
            const themeClass = 'theme-' + themeName.replace(/[^a-zA-Z0-9]/g, '-');
            
            // Remover temas existentes
            document.body.classList.remove(
                'theme-light', 'theme-dark', 'theme-vintage', 
                'theme-pastel', 'theme-neon'
            );
            
            // Aplicar tema personalizado
            document.body.classList.add(themeClass);
            
            // Crear estilos dinámicamente
            const variables = {};
            document.querySelectorAll('[data-var]').forEach(function(element) {
                const varName = element.getAttribute('data-var');
                const value = element.value;
                if (!variables[varName]) {
                    variables[varName] = value;
                }
            });

            // Aplicar estilos directamente a todos los elementos principales
            Object.keys(variables).forEach(function(varName) {
                document.documentElement.style.setProperty(varName, variables[varName]);
                
                // Aplicar también al topbar y sidebar para que reciban los estilos
                const topbar = document.querySelector('.topbar');
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                
                if (topbar) topbar.style.setProperty(varName, variables[varName]);
                if (sidebar) sidebar.style.setProperty(varName, variables[varName]);
                if (mainContent) mainContent.style.setProperty(varName, variables[varName]);
                
                // Debug: Log de variables de imagen de fondo
                if (varName === '--bg-image' || varName === '--bg-opacity') {
                    console.log('Variable aplicada:', varName, '=', variables[varName]);
                    console.log('Body background-image:', document.body.style.backgroundImage);
                    console.log('Body background-color:', document.body.style.backgroundColor);
                    console.log('DocumentElement --bg-image:', getComputedStyle(document.documentElement).getPropertyValue('--bg-image'));
                    console.log('Body --bg-image:', getComputedStyle(document.body).getPropertyValue('--bg-image'));
                }
            });

            // Actualizar SVG dinámicamente
            if (window.updateSVGColors) {
                window.updateSVGColors();
            }

            // Solo mostrar feedback si se solicita explícitamente
            if (showFeedback) {
                showCopyFeedback();
            }
        }

        // Función para exportar tema
        function exportTheme() {
            const themeName = document.getElementById('theme-name').value;
            const variables = {};
            
            document.querySelectorAll('[data-var]').forEach(function(element) {
                const varName = element.getAttribute('data-var');
                const value = element.value;
                if (!variables[varName]) {
                    variables[varName] = value;
                }
            });

            // Crear modal para seleccionar formato
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: #1a1a1a;
                color: #e0e0e0;
                padding: 30px;
                border-radius: 8px;
                border: 1px solid #444;
                min-width: 300px;
                text-align: center;
            `;

            modalContent.innerHTML = `
                <h3 style="margin: 0 0 20px 0; font-size: 16px;">Seleccionar formato de exportación</h3>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="export-json" style="
                        background: #333;
                        color: #e0e0e0;
                        border: 1px solid #444;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                    ">JSON</button>
                    <button id="export-css" style="
                        background: #333;
                        color: #e0e0e0;
                        border: 1px solid #444;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                    ">CSS</button>
                    <button id="cancel-export" style="
                        background: #555;
                        color: #e0e0e0;
                        border: 1px solid #666;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                    ">Cancelar</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Event listeners
            document.getElementById('export-json').addEventListener('click', function() {
                exportAsJSON(themeName, variables);
                document.body.removeChild(modal);
            });

            document.getElementById('export-css').addEventListener('click', function() {
                exportAsCSS(themeName, variables);
                document.body.removeChild(modal);
            });

            document.getElementById('cancel-export').addEventListener('click', function() {
                document.body.removeChild(modal);
            });

            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // Función para exportar como JSON
        function exportAsJSON(themeName, variables) {
            const themeData = {
                name: themeName,
                variables: variables,
                timestamp: new Date().toISOString()
            };

            const dataStr = JSON.stringify(themeData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = themeName + '.json';
            link.click();
        }

        // Función para exportar como CSS
        function exportAsCSS(themeName, variables) {
            let cssContent = `/* Tema: ${themeName} */\n`;
            cssContent += `/* Generado el: ${new Date().toLocaleString()} */\n\n`;
            cssContent += `:root {\n`;
            
            Object.keys(variables).forEach(function(varName) {
                cssContent += `    ${varName}: ${variables[varName]};\n`;
            });
            
            cssContent += `}\n\n`;
            cssContent += `/* Para aplicar este tema, agrega la clase 'theme-${themeName}' al body */\n`;
            cssContent += `.theme-${themeName} {\n`;
            
            Object.keys(variables).forEach(function(varName) {
                cssContent += `    ${varName}: ${variables[varName]};\n`;
            });
            
            cssContent += `}\n`;

            const dataBlob = new Blob([cssContent], {type: 'text/css'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = themeName + '.css';
            link.click();
        }





        // Función para cargar un tema predefinido usando xdiagrams
        async function loadPredefinedTheme(themeName) {
            console.log('Cargando tema predefinido con xdiagrams:', themeName);

            try {
                // Usar el sistema de temas de xdiagrams
                if (window.setTheme) {
                    await window.setTheme(themeName);
                }

                // Obtener las variables del tema desde xdiagrams
                let theme = {};
                if (window.getThemeVariables) {
                    theme = await window.getThemeVariables(themeName);
                }

                // Si no se pudo obtener el tema, usar el fallback local
                if (!theme || Object.keys(theme).length === 0) {
                    theme = themeValues[themeName] || {};
                    console.warn('Usando tema fallback local para:', themeName);
                }

                // Aplicar variables CSS y actualizar TODOS los controles
                Object.keys(theme).forEach(function(varName) {
                    const value = theme[varName];
                    
                    // Aplicar variable CSS
                    document.documentElement.style.setProperty(varName, value);
                    
                    // Aplicar también al topbar y sidebar para que reciban los estilos
                    const topbar = document.querySelector('.topbar');
                    const sidebar = document.querySelector('.sidebar');
                    const mainContent = document.querySelector('.main-content');
                    
                    if (topbar) topbar.style.setProperty(varName, value);
                    if (sidebar) sidebar.style.setProperty(varName, value);
                    if (mainContent) mainContent.style.setProperty(varName, value);
                    
                    // Debug: Log de variables de imagen de fondo
                    if (varName === '--bg-image' || varName === '--bg-opacity') {
                        console.log('Variable aplicada:', varName, '=', value);
                    }
                        
                    // Actualizar input de texto
                    const textInput = document.querySelector('[data-var="' + varName + '"].text-input');
                    if (textInput) {
                        textInput.value = value;
                        console.log('Input de texto actualizado:', varName, '=', value);
                    }
                    
                    // Actualizar color picker (solo para colores, no para filtros)
                    if (varName !== '--image-filter' && varName !== '--bg-image' && varName !== '--bg-opacity') {
                        const pickerElement = document.querySelector('[data-var="' + varName + '"].color-picker');
                        if (pickerElement) {
                            const colorInput = pickerElement.querySelector('input[type="color"]');
                            if (colorInput) {
                                colorInput.value = value;
                            }
                            // Actualizar color visual del picker
                            pickerElement.style.setProperty('--picker-color', value);
                            pickerElement.style.backgroundColor = value;
                            // Actualizar también el atributo data-color
                            pickerElement.setAttribute('data-color', value);
                            console.log('Color picker actualizado:', varName, '=', value);
                        }
                    }
                    
                    // Actualizar botón de reset individual con el nuevo valor original
                    const resetBtn = document.querySelector('[onclick*="resetIndividualValue(\'' + varName + '\'"]');
                    if (resetBtn) {
                        resetBtn.setAttribute('onclick', 'resetIndividualValue(\'' + varName + '\', \'' + value + '\')');
                        console.log('Botón de reset actualizado para:', varName, '=', value);
                    }
                });

                // Actualizar nombre del tema
                document.getElementById('theme-name').value = themeName + '-custom';
                
                // Aplicar valores custom después de cargar el tema base
                applyCustomValues();
                
                // Actualizar atributos HTML de los color pickers
                updateColorPickerAttributes(theme);
                
                // Forzar la actualización del SVG con un pequeño delay
                setTimeout(function() {
                    if (window.updateSVGColors) {
                        window.updateSVGColors();
                    }
                    // Aplicar tema para asegurar que los color pickers funcionen
                    applyTheme(false); // Sin mostrar toast
                }, 100);
                
                console.log('Tema', themeName, 'cargado completamente con xdiagrams');
            } catch (error) {
                console.error('Error cargando tema con xdiagrams:', error);
                // Fallback al método anterior
                const theme = themeValues[themeName];
                if (theme) {
                    console.log('Usando fallback local para tema:', themeName);
                    // Aplicar tema usando el método anterior
                    Object.keys(theme).forEach(function(varName) {
                        const value = theme[varName];
                        updateCSSVariable(varName, value);
                    });
                }
            }
        }

        // Event listener para el selector de temas visible
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            // Función para inicializar color pickers nativos
            function initializeColorPickers() {
                console.log('Inicializando color pickers nativos...');
                
                const colorPickers = document.querySelectorAll('.color-picker');
                console.log('Encontrados', colorPickers.length, 'color pickers');
                
                colorPickers.forEach(function(pickerElement, index) {
                    console.log('Procesando color picker', index, ':', pickerElement);
                    const varName = pickerElement.getAttribute('data-var');
                    const initialColor = pickerElement.getAttribute('data-color');
                    const colorInput = pickerElement.querySelector('input[type="color"]');
                    const textInput = pickerElement.parentElement.querySelector('.text-input');
                    
                    if (!varName || !initialColor || !colorInput) {
                        console.warn('Color picker sin atributos requeridos:', pickerElement);
                        return;
                    }
                    
                    // Configurar el input de color
                    colorInput.value = initialColor;
                    
                    // Event listener para el input de color (input y change para máxima compatibilidad)
                    colorInput.addEventListener('input', function(e) {
                        const hexColor = e.target.value;
                        
                        // Actualizar variable CSS inmediatamente
                        document.documentElement.style.setProperty(varName, hexColor);
                        document.body.style.setProperty(varName, hexColor);
                        
                        // Aplicar también al contenedor xcanvas del diagrama
                        const container = document.querySelector('.xcanvas');
                        if (container) {
                            container.style.setProperty(varName, hexColor);
                        }
                        
                        // Aplicar también al topbar y sidebar
                        const topbar = document.querySelector('.topbar');
                        const sidebar = document.querySelector('.sidebar');
                        const mainContent = document.querySelector('.main-content');
                        
                        if (topbar) topbar.style.setProperty(varName, hexColor);
                        if (sidebar) sidebar.style.setProperty(varName, hexColor);
                        if (mainContent) mainContent.style.setProperty(varName, hexColor);
                        
                        // Actualizar input de texto
                        if (textInput) {
                            textInput.value = hexColor;
                        }
                        
                        // Actualizar color del picker visual
                        pickerElement.style.setProperty('--picker-color', hexColor);
                        pickerElement.style.backgroundColor = hexColor;
                        
                        // Guardar el valor custom en localStorage
                        saveCustomValue(varName, hexColor);
                        
                        // Actualizar SVG dinámicamente (con delay para evitar conflictos)
                        setTimeout(function() {
                            if (window.updateSVGColors) {
                                window.updateSVGColors();
                            }
                        }, 50);
                        
                        console.log('Color actualizado y guardado:', varName, '=', hexColor);
                    });
                    
                    // También escuchar el evento change para asegurar que se aplique
                    colorInput.addEventListener('change', function(e) {
                        const hexColor = e.target.value;
                        
                        // Actualizar variable CSS inmediatamente
                        document.documentElement.style.setProperty(varName, hexColor);
                        document.body.style.setProperty(varName, hexColor);
                        
                        // Aplicar también al contenedor xcanvas del diagrama
                        const container = document.querySelector('.xcanvas');
                        if (container) {
                            container.style.setProperty(varName, hexColor);
                        }
                        
                        // Aplicar también al topbar y sidebar
                        const topbar = document.querySelector('.topbar');
                        const sidebar = document.querySelector('.sidebar');
                        const mainContent = document.querySelector('.main-content');
                        
                        if (topbar) topbar.style.setProperty(varName, hexColor);
                        if (sidebar) sidebar.style.setProperty(varName, hexColor);
                        if (mainContent) mainContent.style.setProperty(varName, hexColor);
                        
                        // Actualizar input de texto
                        if (textInput) {
                            textInput.value = hexColor;
                        }
                        
                        // Actualizar color del picker visual
                        pickerElement.style.setProperty('--picker-color', hexColor);
                        pickerElement.style.backgroundColor = hexColor;
                        
                        // Guardar el valor custom en localStorage
                        saveCustomValue(varName, hexColor);
                        
                        // Actualizar SVG dinámicamente (con delay para evitar conflictos)
                        setTimeout(function() {
                            if (window.updateSVGColors) {
                                window.updateSVGColors();
                            }
                        }, 50);
                        
                        console.log('Color aplicado y guardado (change):', varName, '=', hexColor);
                    });
                    
                    // Event listener para el input de texto
                    if (textInput) {
                        textInput.addEventListener('input', function(e) {
                            const newColor = e.target.value;
                            if (/^#[0-9A-F]{6}$/i.test(newColor)) {
                                colorInput.value = newColor;
                                
                                // Actualizar variable CSS inmediatamente
                                document.documentElement.style.setProperty(varName, newColor);
                                document.body.style.setProperty(varName, newColor);
                                
                                // Aplicar también al contenedor xcanvas del diagrama
                                const container = document.querySelector('.xcanvas');
                                if (container) {
                                    container.style.setProperty(varName, newColor);
                                }
                                
                                // Actualizar color del picker visual
                                pickerElement.style.setProperty('--picker-color', newColor);
                                pickerElement.style.backgroundColor = newColor;
                                
                                // Guardar el valor custom en localStorage
                                saveCustomValue(varName, newColor);
                                
                                // Actualizar SVG dinámicamente (con delay para evitar conflictos)
                                setTimeout(function() {
                                    if (window.updateSVGColors) {
                                        window.updateSVGColors();
                                    }
                                }, 50);
                                
                                console.log('Color actualizado desde texto y guardado:', varName, '=', newColor);
                            }
                        });
                    }
                    
                    console.log('Color picker nativo inicializado para:', varName);
                });
            }
            
            // Función para limpiar y reinicializar color pickers
            function reinitializeColorPickers() {
                // Limpiar event listeners existentes
                document.querySelectorAll('.color-picker input[type="color"]').forEach(function(input) {
                    input.replaceWith(input.cloneNode(true));
                });
                
                // Reinicializar
                initializeColorPickers();
                
                // Mostrar feedback
                showCopyFeedback();
            }
            
            // Función para prevenir bloqueo de color pickers
            function preventColorPickerBlocking() {
                // Agregar event listener global para detectar cuando un color picker se abre
                document.addEventListener('click', function(e) {
                    if (e.target.type === 'color') {
                        // Limpiar cualquier estado bloqueado
                        setTimeout(function() {
                            if (e.target.style.pointerEvents === 'none') {
                                e.target.style.pointerEvents = 'auto';
                            }
                        }, 100);
                    }
                });
            }
            
            // Inicializar color pickers inmediatamente
            initializeColorPickers();
            
            // Activar prevención de bloqueo
            preventColorPickerBlocking();
            
            // Aplicar tema después de inicializar los color pickers
            setTimeout(function() {
                applyTheme(false); // Sin mostrar toast
                console.log('Tema aplicado después de inicializar color pickers');
            }, 300);
            
            // Event listeners para text inputs
            document.querySelectorAll('.text-input').forEach(function(input) {
                input.addEventListener('input', function() {
                    const varName = this.getAttribute('data-var');
                    const value = this.value;
                    
                    // Actualizar variable CSS inmediatamente
                    document.documentElement.style.setProperty(varName, value);
                    document.body.style.setProperty(varName, value);
                    
                    // Aplicar también al contenedor xcanvas del diagrama
                    const container = document.querySelector('.xcanvas');
                    if (container) {
                        container.style.setProperty(varName, value);
                    }
                    
                    // Aplicar también al topbar y sidebar
                    const topbar = document.querySelector('.topbar');
                    const sidebar = document.querySelector('.sidebar');
                    const mainContent = document.querySelector('.main-content');
                    
                    if (topbar) topbar.style.setProperty(varName, value);
                    if (sidebar) sidebar.style.setProperty(varName, value);
                    if (mainContent) mainContent.style.setProperty(varName, value);
                    
                    // Actualizar color picker si es un color
                    if (varName !== '--image-filter' && varName !== '--bg-image' && varName !== '--bg-opacity') {
                        const pickerElement = document.querySelector('[data-var="' + varName + '"].color-picker');
                        const colorInput = pickerElement ? pickerElement.querySelector('input[type="color"]') : null;
                        
                        if (colorInput && value.match(/^#[0-9A-F]{6}$/i)) {
                            colorInput.value = value;
                        }
                        
                        // Actualizar color del picker visual
                        if (pickerElement) {
                            pickerElement.style.setProperty('--picker-color', value);
                            pickerElement.style.backgroundColor = value;
                        }
                    }
                    
                    // Actualizar preview de imagen de fondo
                    if (varName === '--bg-image') {
                        const previewElement = document.querySelector('.bg-image-preview');
                        if (previewElement) {
                            previewElement.style.setProperty('--preview-bg', value);
                        }
                    }
                    
                    // Actualizar preview de opacidad
                    if (varName === '--bg-opacity') {
                        const previewElement = document.querySelector('.opacity-preview');
                        if (previewElement) {
                            previewElement.style.setProperty('--preview-opacity', value);
                        }
                    }
                    
                    // Guardar el valor custom en localStorage
                    saveCustomValue(varName, value);
                    
                    // Actualizar SVG dinámicamente (con delay para evitar conflictos)
                    setTimeout(function() {
                        if (window.updateSVGColors) {
                            window.updateSVGColors();
                        }
                    }, 50);
                    
                    console.log('Variable CSS actualizada y guardada:', varName, '=', value);
                });
                
                // Evento para cuando se presiona Enter
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur(); // Quitar el foco para disparar el evento change
                    }
                });
                
                // También escuchar el evento change para inputs de texto
                input.addEventListener('change', function() {
                    const varName = this.getAttribute('data-var');
                    const value = this.value;
                    
                    // Actualizar variable CSS inmediatamente
                    document.documentElement.style.setProperty(varName, value);
                    document.body.style.setProperty(varName, value);
                    
                    // Aplicar también al contenedor xcanvas del diagrama
                    const container = document.querySelector('.xcanvas');
                    if (container) {
                        container.style.setProperty(varName, value);
                    }
                    
                    // Aplicar también al topbar y sidebar
                    const topbar = document.querySelector('.topbar');
                    const sidebar = document.querySelector('.sidebar');
                    const mainContent = document.querySelector('.main-content');
                    
                    if (topbar) topbar.style.setProperty(varName, value);
                    if (sidebar) sidebar.style.setProperty(varName, value);
                    if (mainContent) mainContent.style.setProperty(varName, value);
                    
                    // Actualizar preview de imagen de fondo
                    if (varName === '--bg-image') {
                        const previewElement = document.querySelector('.bg-image-preview');
                        if (previewElement) {
                            previewElement.style.setProperty('--preview-bg', value);
                        }
                    }
                    
                    // Actualizar preview de opacidad
                    if (varName === '--bg-opacity') {
                        const previewElement = document.querySelector('.opacity-preview');
                        if (previewElement) {
                            previewElement.style.setProperty('--preview-opacity', value);
                        }
                    }
                    
                    // Actualizar SVG dinámicamente (con delay para evitar conflictos)
                    setTimeout(function() {
                        if (window.updateSVGColors) {
                            window.updateSVGColors();
                        }
                    }, 50);
                    
                    console.log('Variable CSS aplicada (change):', varName, '=', value);
                });
            });
            
            const themeSelector = document.getElementById('theme-selector-visible');
            const hiddenThemeSelector = document.getElementById('theme-selector');
            
            // Sincronizar selectores
            themeSelector.addEventListener('change', async function() {
                const selectedTheme = this.value;
                const previousTheme = hiddenThemeSelector.value;
                hiddenThemeSelector.value = selectedTheme;
                
                // Guardar el tema seleccionado en localStorage
                localStorage.setItem('selectedTheme', selectedTheme);
                console.log('Tema guardado en localStorage:', selectedTheme);
                
                // Usar el sistema de temas de xdiagrams
                try {
                    if (window.setTheme) {
                        await window.setTheme(selectedTheme);
                    }
                    
                    // Cargar el tema predefinido para asegurar que los color pickers se actualicen
                    await loadPredefinedTheme(selectedTheme);
                } catch (error) {
                    console.error('Error cambiando tema con xdiagrams:', error);
                    // Fallback al método anterior
                    await loadPredefinedTheme(selectedTheme);
                }
            });

            // Sincronizar con el selector oculto (para compatibilidad con xdiagrams.js)
            hiddenThemeSelector.addEventListener('change', async function() {
                const selectedTheme = this.value;
                const previousTheme = themeSelector.value;
                themeSelector.value = selectedTheme;
                
                // Guardar el tema seleccionado en localStorage
                localStorage.setItem('selectedTheme', selectedTheme);
                console.log('Tema guardado en localStorage:', selectedTheme);
                
                // Usar el sistema de temas de xdiagrams
                try {
                    if (window.setTheme) {
                        await window.setTheme(selectedTheme);
                    }
                    
                    // Cargar el tema predefinido para asegurar que los color pickers se actualicen
                    await loadPredefinedTheme(selectedTheme);
                } catch (error) {
                    console.error('Error cambiando tema con xdiagrams:', error);
                    // Fallback al método anterior
                    await loadPredefinedTheme(selectedTheme);
                }
            });

            // Inicializar con tema persistente después de que los color pickers estén listos
            setTimeout(async function() {
                // Restaurar tema guardado o usar snow por defecto
                const savedTheme = localStorage.getItem('selectedTheme') || 'snow';
                console.log('Tema guardado encontrado:', savedTheme);
                
                // Establecer el tema guardado como seleccionado
                themeSelector.value = savedTheme;
                hiddenThemeSelector.value = savedTheme;
                
                // Usar el sistema de temas de xdiagrams
                try {
                    if (window.setTheme) {
                        await window.setTheme(savedTheme);
                    }
                    
                    // Cargar el tema predefinido para asegurar que los color pickers se actualicen
                    await loadPredefinedTheme(savedTheme);
                } catch (error) {
                    console.error('Error inicializando tema con xdiagrams:', error);
                    // Fallback al método anterior
                    await loadPredefinedTheme(savedTheme);
                }
                
                // Aplicar tema inmediatamente para que los color pickers funcionen desde el inicio
                setTimeout(function() {
                    applyTheme(false); // Sin mostrar toast
                    // Aplicar valores custom después del tema
                    applyCustomValues();
                    console.log('Tema persistente aplicado automáticamente al cargar la página:', savedTheme);
                }, 200);
                
                console.log('Tema persistente cargado automáticamente al cargar la página:', savedTheme);
            }, 100);
        });


    </script>
</body>
</html> 