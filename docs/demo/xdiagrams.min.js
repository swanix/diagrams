/**
 * @swanix/diagrams v0.9.3
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).XDiagrams={})}(this,function(e){"use strict";var t="http://www.w3.org/1999/xhtml";const n={svg:"http://www.w3.org/2000/svg",xhtml:t,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function i(e){var t=e+="",i=t.indexOf(":");return i>=0&&"xmlns"!==(t=e.slice(0,i))&&(e=e.slice(i+1)),n.hasOwnProperty(t)?{space:n[t],local:e}:e}function r(e){return function(){var n=this.ownerDocument,i=this.namespaceURI;return i===t&&n.documentElement.namespaceURI===t?n.createElement(e):n.createElementNS(i,e)}}function o(e){return function(){return this.ownerDocument.createElementNS(e.space,e.local)}}function a(e){var t=i(e);return(t.local?o:r)(t)}function s(){}function l(e){return null==e?s:function(){return this.querySelector(e)}}function c(e){return null==e?[]:Array.isArray(e)?e:Array.from(e)}function u(){return[]}function h(e){return null==e?u:function(){return this.querySelectorAll(e)}}function d(e){return function(){return this.matches(e)}}function f(e){return function(t){return t.matches(e)}}var g=Array.prototype.find;function m(){return this.firstElementChild}var p=Array.prototype.filter;function y(){return Array.from(this.children)}function v(e){return new Array(e.length)}function w(e,t){this.ownerDocument=e.ownerDocument,this.namespaceURI=e.namespaceURI,this._next=null,this._parent=e,this.__data__=t}function x(e,t,n,i,r,o){for(var a,s=0,l=t.length,c=o.length;s<c;++s)(a=t[s])?(a.__data__=o[s],i[s]=a):n[s]=new w(e,o[s]);for(;s<l;++s)(a=t[s])&&(r[s]=a)}function b(e,t,n,i,r,o,a){var s,l,c,u=new Map,h=t.length,d=o.length,f=new Array(h);for(s=0;s<h;++s)(l=t[s])&&(f[s]=c=a.call(l,l.__data__,s,t)+"",u.has(c)?r[s]=l:u.set(c,l));for(s=0;s<d;++s)c=a.call(e,o[s],s,o)+"",(l=u.get(c))?(i[s]=l,l.__data__=o[s],u.delete(c)):n[s]=new w(e,o[s]);for(s=0;s<h;++s)(l=t[s])&&u.get(f[s])===l&&(r[s]=l)}function _(e){return e.__data__}function C(e){return"object"==typeof e&&"length"in e?e:Array.from(e)}function I(e,t){return e<t?-1:e>t?1:e>=t?0:NaN}function E(e){return function(){this.removeAttribute(e)}}function T(e){return function(){this.removeAttributeNS(e.space,e.local)}}function k(e,t){return function(){this.setAttribute(e,t)}}function M(e,t){return function(){this.setAttributeNS(e.space,e.local,t)}}function N(e,t){return function(){var n=t.apply(this,arguments);null==n?this.removeAttribute(e):this.setAttribute(e,n)}}function z(e,t){return function(){var n=t.apply(this,arguments);null==n?this.removeAttributeNS(e.space,e.local):this.setAttributeNS(e.space,e.local,n)}}function L(e){return e.ownerDocument&&e.ownerDocument.defaultView||e.document&&e||e.defaultView}function A(e){return function(){this.style.removeProperty(e)}}function S(e,t,n){return function(){this.style.setProperty(e,t,n)}}function D(e,t,n){return function(){var i=t.apply(this,arguments);null==i?this.style.removeProperty(e):this.style.setProperty(e,i,n)}}function P(e,t){return e.style.getPropertyValue(t)||L(e).getComputedStyle(e,null).getPropertyValue(t)}function R(e){return function(){delete this[e]}}function $(e,t){return function(){this[e]=t}}function O(e,t){return function(){var n=t.apply(this,arguments);null==n?delete this[e]:this[e]=n}}function B(e){return e.trim().split(/^|\s+/)}function F(e){return e.classList||new H(e)}function H(e){this._node=e,this._names=B(e.getAttribute("class")||"")}function j(e,t){for(var n=F(e),i=-1,r=t.length;++i<r;)n.add(t[i])}function U(e,t){for(var n=F(e),i=-1,r=t.length;++i<r;)n.remove(t[i])}function q(e){return function(){j(this,e)}}function W(e){return function(){U(this,e)}}function X(e,t){return function(){(t.apply(this,arguments)?j:U)(this,e)}}function Z(){this.textContent=""}function V(e){return function(){this.textContent=e}}function K(e){return function(){var t=e.apply(this,arguments);this.textContent=null==t?"":t}}function G(){this.innerHTML=""}function Y(e){return function(){this.innerHTML=e}}function J(e){return function(){var t=e.apply(this,arguments);this.innerHTML=null==t?"":t}}function Q(){this.nextSibling&&this.parentNode.appendChild(this)}function ee(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function te(){return null}function ne(){var e=this.parentNode;e&&e.removeChild(this)}function ie(){var e=this.cloneNode(!1),t=this.parentNode;return t?t.insertBefore(e,this.nextSibling):e}function re(){var e=this.cloneNode(!0),t=this.parentNode;return t?t.insertBefore(e,this.nextSibling):e}function oe(e){return function(){var t=this.__on;if(t){for(var n,i=0,r=-1,o=t.length;i<o;++i)n=t[i],e.type&&n.type!==e.type||n.name!==e.name?t[++r]=n:this.removeEventListener(n.type,n.listener,n.options);++r?t.length=r:delete this.__on}}}function ae(e,t,n){return function(){var i,r=this.__on,o=function(e){return function(t){e.call(this,t,this.__data__)}}(t);if(r)for(var a=0,s=r.length;a<s;++a)if((i=r[a]).type===e.type&&i.name===e.name)return this.removeEventListener(i.type,i.listener,i.options),this.addEventListener(i.type,i.listener=o,i.options=n),void(i.value=t);this.addEventListener(e.type,o,n),i={type:e.type,name:e.name,value:t,listener:o,options:n},r?r.push(i):this.__on=[i]}}function se(e,t,n){var i=L(e),r=i.CustomEvent;"function"==typeof r?r=new r(t,n):(r=i.document.createEvent("Event"),n?(r.initEvent(t,n.bubbles,n.cancelable),r.detail=n.detail):r.initEvent(t,!1,!1)),e.dispatchEvent(r)}function le(e,t){return function(){return se(this,e,t)}}function ce(e,t){return function(){return se(this,e,t.apply(this,arguments))}}w.prototype={constructor:w,appendChild:function(e){return this._parent.insertBefore(e,this._next)},insertBefore:function(e,t){return this._parent.insertBefore(e,t)},querySelector:function(e){return this._parent.querySelector(e)},querySelectorAll:function(e){return this._parent.querySelectorAll(e)}},H.prototype={add:function(e){this._names.indexOf(e)<0&&(this._names.push(e),this._node.setAttribute("class",this._names.join(" ")))},remove:function(e){var t=this._names.indexOf(e);t>=0&&(this._names.splice(t,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(e){return this._names.indexOf(e)>=0}};var ue=[null];function he(e,t){this._groups=e,this._parents=t}function de(){return new he([[document.documentElement]],ue)}function fe(e){return"string"==typeof e?new he([[document.querySelector(e)]],[document.documentElement]):new he([[e]],ue)}function ge(e,t){if(e=function(e){let t;for(;t=e.sourceEvent;)e=t;return e}(e),void 0===t&&(t=e.currentTarget),t){var n=t.ownerSVGElement||t;if(n.createSVGPoint){var i=n.createSVGPoint();return i.x=e.clientX,i.y=e.clientY,[(i=i.matrixTransform(t.getScreenCTM().inverse())).x,i.y]}if(t.getBoundingClientRect){var r=t.getBoundingClientRect();return[e.clientX-r.left-t.clientLeft,e.clientY-r.top-t.clientTop]}}return[e.pageX,e.pageY]}he.prototype=de.prototype={constructor:he,select:function(e){"function"!=typeof e&&(e=l(e));for(var t=this._groups,n=t.length,i=new Array(n),r=0;r<n;++r)for(var o,a,s=t[r],c=s.length,u=i[r]=new Array(c),h=0;h<c;++h)(o=s[h])&&(a=e.call(o,o.__data__,h,s))&&("__data__"in o&&(a.__data__=o.__data__),u[h]=a);return new he(i,this._parents)},selectAll:function(e){e="function"==typeof e?function(e){return function(){return c(e.apply(this,arguments))}}(e):h(e);for(var t=this._groups,n=t.length,i=[],r=[],o=0;o<n;++o)for(var a,s=t[o],l=s.length,u=0;u<l;++u)(a=s[u])&&(i.push(e.call(a,a.__data__,u,s)),r.push(a));return new he(i,r)},selectChild:function(e){return this.select(null==e?m:function(e){return function(){return g.call(this.children,e)}}("function"==typeof e?e:f(e)))},selectChildren:function(e){return this.selectAll(null==e?y:function(e){return function(){return p.call(this.children,e)}}("function"==typeof e?e:f(e)))},filter:function(e){"function"!=typeof e&&(e=d(e));for(var t=this._groups,n=t.length,i=new Array(n),r=0;r<n;++r)for(var o,a=t[r],s=a.length,l=i[r]=[],c=0;c<s;++c)(o=a[c])&&e.call(o,o.__data__,c,a)&&l.push(o);return new he(i,this._parents)},data:function(e,t){if(!arguments.length)return Array.from(this,_);var n,i=t?b:x,r=this._parents,o=this._groups;"function"!=typeof e&&(n=e,e=function(){return n});for(var a=o.length,s=new Array(a),l=new Array(a),c=new Array(a),u=0;u<a;++u){var h=r[u],d=o[u],f=d.length,g=C(e.call(h,h&&h.__data__,u,r)),m=g.length,p=l[u]=new Array(m),y=s[u]=new Array(m);i(h,d,p,y,c[u]=new Array(f),g,t);for(var v,w,I=0,E=0;I<m;++I)if(v=p[I]){for(I>=E&&(E=I+1);!(w=y[E])&&++E<m;);v._next=w||null}}return(s=new he(s,r))._enter=l,s._exit=c,s},enter:function(){return new he(this._enter||this._groups.map(v),this._parents)},exit:function(){return new he(this._exit||this._groups.map(v),this._parents)},join:function(e,t,n){var i=this.enter(),r=this,o=this.exit();return"function"==typeof e?(i=e(i))&&(i=i.selection()):i=i.append(e+""),null!=t&&(r=t(r))&&(r=r.selection()),null==n?o.remove():n(o),i&&r?i.merge(r).order():r},merge:function(e){for(var t=e.selection?e.selection():e,n=this._groups,i=t._groups,r=n.length,o=i.length,a=Math.min(r,o),s=new Array(r),l=0;l<a;++l)for(var c,u=n[l],h=i[l],d=u.length,f=s[l]=new Array(d),g=0;g<d;++g)(c=u[g]||h[g])&&(f[g]=c);for(;l<r;++l)s[l]=n[l];return new he(s,this._parents)},selection:function(){return this},order:function(){for(var e=this._groups,t=-1,n=e.length;++t<n;)for(var i,r=e[t],o=r.length-1,a=r[o];--o>=0;)(i=r[o])&&(a&&4^i.compareDocumentPosition(a)&&a.parentNode.insertBefore(i,a),a=i);return this},sort:function(e){function t(t,n){return t&&n?e(t.__data__,n.__data__):!t-!n}e||(e=I);for(var n=this._groups,i=n.length,r=new Array(i),o=0;o<i;++o){for(var a,s=n[o],l=s.length,c=r[o]=new Array(l),u=0;u<l;++u)(a=s[u])&&(c[u]=a);c.sort(t)}return new he(r,this._parents).order()},call:function(){var e=arguments[0];return arguments[0]=this,e.apply(null,arguments),this},nodes:function(){return Array.from(this)},node:function(){for(var e=this._groups,t=0,n=e.length;t<n;++t)for(var i=e[t],r=0,o=i.length;r<o;++r){var a=i[r];if(a)return a}return null},size:function(){let e=0;for(const t of this)++e;return e},empty:function(){return!this.node()},each:function(e){for(var t=this._groups,n=0,i=t.length;n<i;++n)for(var r,o=t[n],a=0,s=o.length;a<s;++a)(r=o[a])&&e.call(r,r.__data__,a,o);return this},attr:function(e,t){var n=i(e);if(arguments.length<2){var r=this.node();return n.local?r.getAttributeNS(n.space,n.local):r.getAttribute(n)}return this.each((null==t?n.local?T:E:"function"==typeof t?n.local?z:N:n.local?M:k)(n,t))},style:function(e,t,n){return arguments.length>1?this.each((null==t?A:"function"==typeof t?D:S)(e,t,null==n?"":n)):P(this.node(),e)},property:function(e,t){return arguments.length>1?this.each((null==t?R:"function"==typeof t?O:$)(e,t)):this.node()[e]},classed:function(e,t){var n=B(e+"");if(arguments.length<2){for(var i=F(this.node()),r=-1,o=n.length;++r<o;)if(!i.contains(n[r]))return!1;return!0}return this.each(("function"==typeof t?X:t?q:W)(n,t))},text:function(e){return arguments.length?this.each(null==e?Z:("function"==typeof e?K:V)(e)):this.node().textContent},html:function(e){return arguments.length?this.each(null==e?G:("function"==typeof e?J:Y)(e)):this.node().innerHTML},raise:function(){return this.each(Q)},lower:function(){return this.each(ee)},append:function(e){var t="function"==typeof e?e:a(e);return this.select(function(){return this.appendChild(t.apply(this,arguments))})},insert:function(e,t){var n="function"==typeof e?e:a(e),i=null==t?te:"function"==typeof t?t:l(t);return this.select(function(){return this.insertBefore(n.apply(this,arguments),i.apply(this,arguments)||null)})},remove:function(){return this.each(ne)},clone:function(e){return this.select(e?re:ie)},datum:function(e){return arguments.length?this.property("__data__",e):this.node().__data__},on:function(e,t,n){var i,r,o=function(e){return e.trim().split(/^|\s+/).map(function(e){var t="",n=e.indexOf(".");return n>=0&&(t=e.slice(n+1),e=e.slice(0,n)),{type:e,name:t}})}(e+""),a=o.length;if(!(arguments.length<2)){for(s=t?ae:oe,i=0;i<a;++i)this.each(s(o[i],t,n));return this}var s=this.node().__on;if(s)for(var l,c=0,u=s.length;c<u;++c)for(i=0,l=s[c];i<a;++i)if((r=o[i]).type===l.type&&r.name===l.name)return l.value},dispatch:function(e,t){return this.each(("function"==typeof t?ce:le)(e,t))},[Symbol.iterator]:function*(){for(var e=this._groups,t=0,n=e.length;t<n;++t)for(var i,r=e[t],o=0,a=r.length;o<a;++o)(i=r[o])&&(yield i)}};var me={value:()=>{}};function pe(){for(var e,t=0,n=arguments.length,i={};t<n;++t){if(!(e=arguments[t]+"")||e in i||/[\s.]/.test(e))throw new Error("illegal type: "+e);i[e]=[]}return new ye(i)}function ye(e){this._=e}function ve(e,t){for(var n,i=0,r=e.length;i<r;++i)if((n=e[i]).name===t)return n.value}function we(e,t,n){for(var i=0,r=e.length;i<r;++i)if(e[i].name===t){e[i]=me,e=e.slice(0,i).concat(e.slice(i+1));break}return null!=n&&e.push({name:t,value:n}),e}ye.prototype=pe.prototype={constructor:ye,on:function(e,t){var n,i,r=this._,o=(i=r,(e+"").trim().split(/^|\s+/).map(function(e){var t="",n=e.indexOf(".");if(n>=0&&(t=e.slice(n+1),e=e.slice(0,n)),e&&!i.hasOwnProperty(e))throw new Error("unknown type: "+e);return{type:e,name:t}})),a=-1,s=o.length;if(!(arguments.length<2)){if(null!=t&&"function"!=typeof t)throw new Error("invalid callback: "+t);for(;++a<s;)if(n=(e=o[a]).type)r[n]=we(r[n],e.name,t);else if(null==t)for(n in r)r[n]=we(r[n],e.name,null);return this}for(;++a<s;)if((n=(e=o[a]).type)&&(n=ve(r[n],e.name)))return n},copy:function(){var e={},t=this._;for(var n in t)e[n]=t[n].slice();return new ye(e)},call:function(e,t){if((n=arguments.length-2)>0)for(var n,i,r=new Array(n),o=0;o<n;++o)r[o]=arguments[o+2];if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(o=0,n=(i=this._[e]).length;o<n;++o)i[o].value.apply(t,r)},apply:function(e,t,n){if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(var i=this._[e],r=0,o=i.length;r<o;++r)i[r].value.apply(t,n)}};const xe={capture:!0,passive:!1};function be(e){e.preventDefault(),e.stopImmediatePropagation()}function _e(e,t,n){e.prototype=t.prototype=n,n.constructor=e}function Ce(e,t){var n=Object.create(e.prototype);for(var i in t)n[i]=t[i];return n}function Ie(){}var Ee=.7,Te=1/Ee,ke="\\s*([+-]?\\d+)\\s*",Me="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",Ne="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",ze=/^#([0-9a-f]{3,8})$/,Le=new RegExp(`^rgb\\(${ke},${ke},${ke}\\)$`),Ae=new RegExp(`^rgb\\(${Ne},${Ne},${Ne}\\)$`),Se=new RegExp(`^rgba\\(${ke},${ke},${ke},${Me}\\)$`),De=new RegExp(`^rgba\\(${Ne},${Ne},${Ne},${Me}\\)$`),Pe=new RegExp(`^hsl\\(${Me},${Ne},${Ne}\\)$`),Re=new RegExp(`^hsla\\(${Me},${Ne},${Ne},${Me}\\)$`),$e={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};function Oe(){return this.rgb().formatHex()}function Be(){return this.rgb().formatRgb()}function Fe(e){var t,n;return e=(e+"").trim().toLowerCase(),(t=ze.exec(e))?(n=t[1].length,t=parseInt(t[1],16),6===n?He(t):3===n?new qe(t>>8&15|t>>4&240,t>>4&15|240&t,(15&t)<<4|15&t,1):8===n?je(t>>24&255,t>>16&255,t>>8&255,(255&t)/255):4===n?je(t>>12&15|t>>8&240,t>>8&15|t>>4&240,t>>4&15|240&t,((15&t)<<4|15&t)/255):null):(t=Le.exec(e))?new qe(t[1],t[2],t[3],1):(t=Ae.exec(e))?new qe(255*t[1]/100,255*t[2]/100,255*t[3]/100,1):(t=Se.exec(e))?je(t[1],t[2],t[3],t[4]):(t=De.exec(e))?je(255*t[1]/100,255*t[2]/100,255*t[3]/100,t[4]):(t=Pe.exec(e))?Ge(t[1],t[2]/100,t[3]/100,1):(t=Re.exec(e))?Ge(t[1],t[2]/100,t[3]/100,t[4]):$e.hasOwnProperty(e)?He($e[e]):"transparent"===e?new qe(NaN,NaN,NaN,0):null}function He(e){return new qe(e>>16&255,e>>8&255,255&e,1)}function je(e,t,n,i){return i<=0&&(e=t=n=NaN),new qe(e,t,n,i)}function Ue(e,t,n,i){return 1===arguments.length?((r=e)instanceof Ie||(r=Fe(r)),r?new qe((r=r.rgb()).r,r.g,r.b,r.opacity):new qe):new qe(e,t,n,null==i?1:i);var r}function qe(e,t,n,i){this.r=+e,this.g=+t,this.b=+n,this.opacity=+i}function We(){return`#${Ke(this.r)}${Ke(this.g)}${Ke(this.b)}`}function Xe(){const e=Ze(this.opacity);return`${1===e?"rgb(":"rgba("}${Ve(this.r)}, ${Ve(this.g)}, ${Ve(this.b)}${1===e?")":`, ${e})`}`}function Ze(e){return isNaN(e)?1:Math.max(0,Math.min(1,e))}function Ve(e){return Math.max(0,Math.min(255,Math.round(e)||0))}function Ke(e){return((e=Ve(e))<16?"0":"")+e.toString(16)}function Ge(e,t,n,i){return i<=0?e=t=n=NaN:n<=0||n>=1?e=t=NaN:t<=0&&(e=NaN),new Je(e,t,n,i)}function Ye(e){if(e instanceof Je)return new Je(e.h,e.s,e.l,e.opacity);if(e instanceof Ie||(e=Fe(e)),!e)return new Je;if(e instanceof Je)return e;var t=(e=e.rgb()).r/255,n=e.g/255,i=e.b/255,r=Math.min(t,n,i),o=Math.max(t,n,i),a=NaN,s=o-r,l=(o+r)/2;return s?(a=t===o?(n-i)/s+6*(n<i):n===o?(i-t)/s+2:(t-n)/s+4,s/=l<.5?o+r:2-o-r,a*=60):s=l>0&&l<1?0:a,new Je(a,s,l,e.opacity)}function Je(e,t,n,i){this.h=+e,this.s=+t,this.l=+n,this.opacity=+i}function Qe(e){return(e=(e||0)%360)<0?e+360:e}function et(e){return Math.max(0,Math.min(1,e||0))}function tt(e,t,n){return 255*(e<60?t+(n-t)*e/60:e<180?n:e<240?t+(n-t)*(240-e)/60:t)}_e(Ie,Fe,{copy(e){return Object.assign(new this.constructor,this,e)},displayable(){return this.rgb().displayable()},hex:Oe,formatHex:Oe,formatHex8:function(){return this.rgb().formatHex8()},formatHsl:function(){return Ye(this).formatHsl()},formatRgb:Be,toString:Be}),_e(qe,Ue,Ce(Ie,{brighter(e){return e=null==e?Te:Math.pow(Te,e),new qe(this.r*e,this.g*e,this.b*e,this.opacity)},darker(e){return e=null==e?Ee:Math.pow(Ee,e),new qe(this.r*e,this.g*e,this.b*e,this.opacity)},rgb(){return this},clamp(){return new qe(Ve(this.r),Ve(this.g),Ve(this.b),Ze(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:We,formatHex:We,formatHex8:function(){return`#${Ke(this.r)}${Ke(this.g)}${Ke(this.b)}${Ke(255*(isNaN(this.opacity)?1:this.opacity))}`},formatRgb:Xe,toString:Xe})),_e(Je,function(e,t,n,i){return 1===arguments.length?Ye(e):new Je(e,t,n,null==i?1:i)},Ce(Ie,{brighter(e){return e=null==e?Te:Math.pow(Te,e),new Je(this.h,this.s,this.l*e,this.opacity)},darker(e){return e=null==e?Ee:Math.pow(Ee,e),new Je(this.h,this.s,this.l*e,this.opacity)},rgb(){var e=this.h%360+360*(this.h<0),t=isNaN(e)||isNaN(this.s)?0:this.s,n=this.l,i=n+(n<.5?n:1-n)*t,r=2*n-i;return new qe(tt(e>=240?e-240:e+120,r,i),tt(e,r,i),tt(e<120?e+240:e-120,r,i),this.opacity)},clamp(){return new Je(Qe(this.h),et(this.s),et(this.l),Ze(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const e=Ze(this.opacity);return`${1===e?"hsl(":"hsla("}${Qe(this.h)}, ${100*et(this.s)}%, ${100*et(this.l)}%${1===e?")":`, ${e})`}`}}));const nt=e=>()=>e;function it(e){return 1===(e=+e)?rt:function(t,n){return n-t?function(e,t,n){return e=Math.pow(e,n),t=Math.pow(t,n)-e,n=1/n,function(i){return Math.pow(e+i*t,n)}}(t,n,e):nt(isNaN(t)?n:t)}}function rt(e,t){var n=t-e;return n?function(e,t){return function(n){return e+n*t}}(e,n):nt(isNaN(e)?t:e)}const ot=function e(t){var n=it(t);function i(e,t){var i=n((e=Ue(e)).r,(t=Ue(t)).r),r=n(e.g,t.g),o=n(e.b,t.b),a=rt(e.opacity,t.opacity);return function(t){return e.r=i(t),e.g=r(t),e.b=o(t),e.opacity=a(t),e+""}}return i.gamma=e,i}(1);function at(e,t){return e=+e,t=+t,function(n){return e*(1-n)+t*n}}var st=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,lt=new RegExp(st.source,"g");function ct(e,t){var n,i,r,o=st.lastIndex=lt.lastIndex=0,a=-1,s=[],l=[];for(e+="",t+="";(n=st.exec(e))&&(i=lt.exec(t));)(r=i.index)>o&&(r=t.slice(o,r),s[a]?s[a]+=r:s[++a]=r),(n=n[0])===(i=i[0])?s[a]?s[a]+=i:s[++a]=i:(s[++a]=null,l.push({i:a,x:at(n,i)})),o=lt.lastIndex;return o<t.length&&(r=t.slice(o),s[a]?s[a]+=r:s[++a]=r),s.length<2?l[0]?function(e){return function(t){return e(t)+""}}(l[0].x):function(e){return function(){return e}}(t):(t=l.length,function(e){for(var n,i=0;i<t;++i)s[(n=l[i]).i]=n.x(e);return s.join("")})}var ut,ht=180/Math.PI,dt={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function ft(e,t,n,i,r,o){var a,s,l;return(a=Math.sqrt(e*e+t*t))&&(e/=a,t/=a),(l=e*n+t*i)&&(n-=e*l,i-=t*l),(s=Math.sqrt(n*n+i*i))&&(n/=s,i/=s,l/=s),e*i<t*n&&(e=-e,t=-t,l=-l,a=-a),{translateX:r,translateY:o,rotate:Math.atan2(t,e)*ht,skewX:Math.atan(l)*ht,scaleX:a,scaleY:s}}function gt(e,t,n,i){function r(e){return e.length?e.pop()+" ":""}return function(o,a){var s=[],l=[];return o=e(o),a=e(a),function(e,i,r,o,a,s){if(e!==r||i!==o){var l=a.push("translate(",null,t,null,n);s.push({i:l-4,x:at(e,r)},{i:l-2,x:at(i,o)})}else(r||o)&&a.push("translate("+r+t+o+n)}(o.translateX,o.translateY,a.translateX,a.translateY,s,l),function(e,t,n,o){e!==t?(e-t>180?t+=360:t-e>180&&(e+=360),o.push({i:n.push(r(n)+"rotate(",null,i)-2,x:at(e,t)})):t&&n.push(r(n)+"rotate("+t+i)}(o.rotate,a.rotate,s,l),function(e,t,n,o){e!==t?o.push({i:n.push(r(n)+"skewX(",null,i)-2,x:at(e,t)}):t&&n.push(r(n)+"skewX("+t+i)}(o.skewX,a.skewX,s,l),function(e,t,n,i,o,a){if(e!==n||t!==i){var s=o.push(r(o)+"scale(",null,",",null,")");a.push({i:s-4,x:at(e,n)},{i:s-2,x:at(t,i)})}else 1===n&&1===i||o.push(r(o)+"scale("+n+","+i+")")}(o.scaleX,o.scaleY,a.scaleX,a.scaleY,s,l),o=a=null,function(e){for(var t,n=-1,i=l.length;++n<i;)s[(t=l[n]).i]=t.x(e);return s.join("")}}}var mt=gt(function(e){const t=new("function"==typeof DOMMatrix?DOMMatrix:WebKitCSSMatrix)(e+"");return t.isIdentity?dt:ft(t.a,t.b,t.c,t.d,t.e,t.f)},"px, ","px)","deg)"),pt=gt(function(e){return null==e?dt:(ut||(ut=document.createElementNS("http://www.w3.org/2000/svg","g")),ut.setAttribute("transform",e),(e=ut.transform.baseVal.consolidate())?ft((e=e.matrix).a,e.b,e.c,e.d,e.e,e.f):dt)},", ",")",")");function yt(e){return((e=Math.exp(e))+1/e)/2}const vt=function e(t,n,i){function r(e,r){var o,a,s=e[0],l=e[1],c=e[2],u=r[0],h=r[1],d=r[2],f=u-s,g=h-l,m=f*f+g*g;if(m<1e-12)a=Math.log(d/c)/t,o=function(e){return[s+e*f,l+e*g,c*Math.exp(t*e*a)]};else{var p=Math.sqrt(m),y=(d*d-c*c+i*m)/(2*c*n*p),v=(d*d-c*c-i*m)/(2*d*n*p),w=Math.log(Math.sqrt(y*y+1)-y),x=Math.log(Math.sqrt(v*v+1)-v);a=(x-w)/t,o=function(e){var i,r=e*a,o=yt(w),u=c/(n*p)*(o*(i=t*r+w,((i=Math.exp(2*i))-1)/(i+1))-function(e){return((e=Math.exp(e))-1/e)/2}(w));return[s+u*f,l+u*g,c*o/yt(t*r+w)]}}return o.duration=1e3*a*t/Math.SQRT2,o}return r.rho=function(t){var n=Math.max(.001,+t),i=n*n;return e(n,i,i*i)},r}(Math.SQRT2,2,4);var wt,xt,bt=0,_t=0,Ct=0,It=0,Et=0,Tt=0,kt="object"==typeof performance&&performance.now?performance:Date,Mt="object"==typeof window&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(e){setTimeout(e,17)};function Nt(){return Et||(Mt(zt),Et=kt.now()+Tt)}function zt(){Et=0}function Lt(){this._call=this._time=this._next=null}function At(e,t,n){var i=new Lt;return i.restart(e,t,n),i}function St(){Et=(It=kt.now())+Tt,bt=_t=0;try{!function(){Nt(),++bt;for(var e,t=wt;t;)(e=Et-t._time)>=0&&t._call.call(void 0,e),t=t._next;--bt}()}finally{bt=0,function(){var e,t,n=wt,i=1/0;for(;n;)n._call?(i>n._time&&(i=n._time),e=n,n=n._next):(t=n._next,n._next=null,n=e?e._next=t:wt=t);xt=e,Pt(i)}(),Et=0}}function Dt(){var e=kt.now(),t=e-It;t>1e3&&(Tt-=t,It=e)}function Pt(e){bt||(_t&&(_t=clearTimeout(_t)),e-Et>24?(e<1/0&&(_t=setTimeout(St,e-kt.now()-Tt)),Ct&&(Ct=clearInterval(Ct))):(Ct||(It=kt.now(),Ct=setInterval(Dt,1e3)),bt=1,Mt(St)))}function Rt(e,t,n){var i=new Lt;return t=null==t?0:+t,i.restart(n=>{i.stop(),e(n+t)},t,n),i}Lt.prototype=At.prototype={constructor:Lt,restart:function(e,t,n){if("function"!=typeof e)throw new TypeError("callback is not a function");n=(null==n?Nt():+n)+(null==t?0:+t),this._next||xt===this||(xt?xt._next=this:wt=this,xt=this),this._call=e,this._time=n,Pt()},stop:function(){this._call&&(this._call=null,this._time=1/0,Pt())}};var $t=pe("start","end","cancel","interrupt"),Ot=[];function Bt(e,t,n,i,r,o){var a=e.__transition;if(a){if(n in a)return}else e.__transition={};!function(e,t,n){var i,r=e.__transition;function o(e){n.state=1,n.timer.restart(a,n.delay,n.time),n.delay<=e&&a(e-n.delay)}function a(o){var c,u,h,d;if(1!==n.state)return l();for(c in r)if((d=r[c]).name===n.name){if(3===d.state)return Rt(a);4===d.state?(d.state=6,d.timer.stop(),d.on.call("interrupt",e,e.__data__,d.index,d.group),delete r[c]):+c<t&&(d.state=6,d.timer.stop(),d.on.call("cancel",e,e.__data__,d.index,d.group),delete r[c])}if(Rt(function(){3===n.state&&(n.state=4,n.timer.restart(s,n.delay,n.time),s(o))}),n.state=2,n.on.call("start",e,e.__data__,n.index,n.group),2===n.state){for(n.state=3,i=new Array(h=n.tween.length),c=0,u=-1;c<h;++c)(d=n.tween[c].value.call(e,e.__data__,n.index,n.group))&&(i[++u]=d);i.length=u+1}}function s(t){for(var r=t<n.duration?n.ease.call(null,t/n.duration):(n.timer.restart(l),n.state=5,1),o=-1,a=i.length;++o<a;)i[o].call(e,r);5===n.state&&(n.on.call("end",e,e.__data__,n.index,n.group),l())}function l(){for(var i in n.state=6,n.timer.stop(),delete r[t],r)return;delete e.__transition}r[t]=n,n.timer=At(o,0,n.time)}(e,n,{name:t,index:i,group:r,on:$t,tween:Ot,time:o.time,delay:o.delay,duration:o.duration,ease:o.ease,timer:null,state:0})}function Ft(e,t){var n=jt(e,t);if(n.state>0)throw new Error("too late; already scheduled");return n}function Ht(e,t){var n=jt(e,t);if(n.state>3)throw new Error("too late; already running");return n}function jt(e,t){var n=e.__transition;if(!n||!(n=n[t]))throw new Error("transition not found");return n}function Ut(e,t){var n,i,r,o=e.__transition,a=!0;if(o){for(r in t=null==t?null:t+"",o)(n=o[r]).name===t?(i=n.state>2&&n.state<5,n.state=6,n.timer.stop(),n.on.call(i?"interrupt":"cancel",e,e.__data__,n.index,n.group),delete o[r]):a=!1;a&&delete e.__transition}}function qt(e,t){var n,i;return function(){var r=Ht(this,e),o=r.tween;if(o!==n)for(var a=0,s=(i=n=o).length;a<s;++a)if(i[a].name===t){(i=i.slice()).splice(a,1);break}r.tween=i}}function Wt(e,t,n){var i,r;if("function"!=typeof n)throw new Error;return function(){var o=Ht(this,e),a=o.tween;if(a!==i){r=(i=a).slice();for(var s={name:t,value:n},l=0,c=r.length;l<c;++l)if(r[l].name===t){r[l]=s;break}l===c&&r.push(s)}o.tween=r}}function Xt(e,t,n){var i=e._id;return e.each(function(){var e=Ht(this,i);(e.value||(e.value={}))[t]=n.apply(this,arguments)}),function(e){return jt(e,i).value[t]}}function Zt(e,t){var n;return("number"==typeof t?at:t instanceof Fe?ot:(n=Fe(t))?(t=n,ot):ct)(e,t)}function Vt(e){return function(){this.removeAttribute(e)}}function Kt(e){return function(){this.removeAttributeNS(e.space,e.local)}}function Gt(e,t,n){var i,r,o=n+"";return function(){var a=this.getAttribute(e);return a===o?null:a===i?r:r=t(i=a,n)}}function Yt(e,t,n){var i,r,o=n+"";return function(){var a=this.getAttributeNS(e.space,e.local);return a===o?null:a===i?r:r=t(i=a,n)}}function Jt(e,t,n){var i,r,o;return function(){var a,s,l=n(this);if(null!=l)return(a=this.getAttribute(e))===(s=l+"")?null:a===i&&s===r?o:(r=s,o=t(i=a,l));this.removeAttribute(e)}}function Qt(e,t,n){var i,r,o;return function(){var a,s,l=n(this);if(null!=l)return(a=this.getAttributeNS(e.space,e.local))===(s=l+"")?null:a===i&&s===r?o:(r=s,o=t(i=a,l));this.removeAttributeNS(e.space,e.local)}}function en(e,t){var n,i;function r(){var r=t.apply(this,arguments);return r!==i&&(n=(i=r)&&function(e,t){return function(n){this.setAttributeNS(e.space,e.local,t.call(this,n))}}(e,r)),n}return r._value=t,r}function tn(e,t){var n,i;function r(){var r=t.apply(this,arguments);return r!==i&&(n=(i=r)&&function(e,t){return function(n){this.setAttribute(e,t.call(this,n))}}(e,r)),n}return r._value=t,r}function nn(e,t){return function(){Ft(this,e).delay=+t.apply(this,arguments)}}function rn(e,t){return t=+t,function(){Ft(this,e).delay=t}}function on(e,t){return function(){Ht(this,e).duration=+t.apply(this,arguments)}}function an(e,t){return t=+t,function(){Ht(this,e).duration=t}}var sn=de.prototype.constructor;function ln(e){return function(){this.style.removeProperty(e)}}var cn=0;function un(e,t,n,i){this._groups=e,this._parents=t,this._name=n,this._id=i}function hn(){return++cn}var dn=de.prototype;un.prototype={constructor:un,select:function(e){var t=this._name,n=this._id;"function"!=typeof e&&(e=l(e));for(var i=this._groups,r=i.length,o=new Array(r),a=0;a<r;++a)for(var s,c,u=i[a],h=u.length,d=o[a]=new Array(h),f=0;f<h;++f)(s=u[f])&&(c=e.call(s,s.__data__,f,u))&&("__data__"in s&&(c.__data__=s.__data__),d[f]=c,Bt(d[f],t,n,f,d,jt(s,n)));return new un(o,this._parents,t,n)},selectAll:function(e){var t=this._name,n=this._id;"function"!=typeof e&&(e=h(e));for(var i=this._groups,r=i.length,o=[],a=[],s=0;s<r;++s)for(var l,c=i[s],u=c.length,d=0;d<u;++d)if(l=c[d]){for(var f,g=e.call(l,l.__data__,d,c),m=jt(l,n),p=0,y=g.length;p<y;++p)(f=g[p])&&Bt(f,t,n,p,g,m);o.push(g),a.push(l)}return new un(o,a,t,n)},selectChild:dn.selectChild,selectChildren:dn.selectChildren,filter:function(e){"function"!=typeof e&&(e=d(e));for(var t=this._groups,n=t.length,i=new Array(n),r=0;r<n;++r)for(var o,a=t[r],s=a.length,l=i[r]=[],c=0;c<s;++c)(o=a[c])&&e.call(o,o.__data__,c,a)&&l.push(o);return new un(i,this._parents,this._name,this._id)},merge:function(e){if(e._id!==this._id)throw new Error;for(var t=this._groups,n=e._groups,i=t.length,r=n.length,o=Math.min(i,r),a=new Array(i),s=0;s<o;++s)for(var l,c=t[s],u=n[s],h=c.length,d=a[s]=new Array(h),f=0;f<h;++f)(l=c[f]||u[f])&&(d[f]=l);for(;s<i;++s)a[s]=t[s];return new un(a,this._parents,this._name,this._id)},selection:function(){return new sn(this._groups,this._parents)},transition:function(){for(var e=this._name,t=this._id,n=hn(),i=this._groups,r=i.length,o=0;o<r;++o)for(var a,s=i[o],l=s.length,c=0;c<l;++c)if(a=s[c]){var u=jt(a,t);Bt(a,e,n,c,s,{time:u.time+u.delay+u.duration,delay:0,duration:u.duration,ease:u.ease})}return new un(i,this._parents,e,n)},call:dn.call,nodes:dn.nodes,node:dn.node,size:dn.size,empty:dn.empty,each:dn.each,on:function(e,t){var n=this._id;return arguments.length<2?jt(this.node(),n).on.on(e):this.each(function(e,t,n){var i,r,o=function(e){return(e+"").trim().split(/^|\s+/).every(function(e){var t=e.indexOf(".");return t>=0&&(e=e.slice(0,t)),!e||"start"===e})}(t)?Ft:Ht;return function(){var a=o(this,e),s=a.on;s!==i&&(r=(i=s).copy()).on(t,n),a.on=r}}(n,e,t))},attr:function(e,t){var n=i(e),r="transform"===n?pt:Zt;return this.attrTween(e,"function"==typeof t?(n.local?Qt:Jt)(n,r,Xt(this,"attr."+e,t)):null==t?(n.local?Kt:Vt)(n):(n.local?Yt:Gt)(n,r,t))},attrTween:function(e,t){var n="attr."+e;if(arguments.length<2)return(n=this.tween(n))&&n._value;if(null==t)return this.tween(n,null);if("function"!=typeof t)throw new Error;var r=i(e);return this.tween(n,(r.local?en:tn)(r,t))},style:function(e,t,n){var i="transform"==(e+="")?mt:Zt;return null==t?this.styleTween(e,function(e,t){var n,i,r;return function(){var o=P(this,e),a=(this.style.removeProperty(e),P(this,e));return o===a?null:o===n&&a===i?r:r=t(n=o,i=a)}}(e,i)).on("end.style."+e,ln(e)):"function"==typeof t?this.styleTween(e,function(e,t,n){var i,r,o;return function(){var a=P(this,e),s=n(this),l=s+"";return null==s&&(this.style.removeProperty(e),l=s=P(this,e)),a===l?null:a===i&&l===r?o:(r=l,o=t(i=a,s))}}(e,i,Xt(this,"style."+e,t))).each(function(e,t){var n,i,r,o,a="style."+t,s="end."+a;return function(){var l=Ht(this,e),c=l.on,u=null==l.value[a]?o||(o=ln(t)):void 0;c===n&&r===u||(i=(n=c).copy()).on(s,r=u),l.on=i}}(this._id,e)):this.styleTween(e,function(e,t,n){var i,r,o=n+"";return function(){var a=P(this,e);return a===o?null:a===i?r:r=t(i=a,n)}}(e,i,t),n).on("end.style."+e,null)},styleTween:function(e,t,n){var i="style."+(e+="");if(arguments.length<2)return(i=this.tween(i))&&i._value;if(null==t)return this.tween(i,null);if("function"!=typeof t)throw new Error;return this.tween(i,function(e,t,n){var i,r;function o(){var o=t.apply(this,arguments);return o!==r&&(i=(r=o)&&function(e,t,n){return function(i){this.style.setProperty(e,t.call(this,i),n)}}(e,o,n)),i}return o._value=t,o}(e,t,null==n?"":n))},text:function(e){return this.tween("text","function"==typeof e?function(e){return function(){var t=e(this);this.textContent=null==t?"":t}}(Xt(this,"text",e)):function(e){return function(){this.textContent=e}}(null==e?"":e+""))},textTween:function(e){var t="text";if(arguments.length<1)return(t=this.tween(t))&&t._value;if(null==e)return this.tween(t,null);if("function"!=typeof e)throw new Error;return this.tween(t,function(e){var t,n;function i(){var i=e.apply(this,arguments);return i!==n&&(t=(n=i)&&function(e){return function(t){this.textContent=e.call(this,t)}}(i)),t}return i._value=e,i}(e))},remove:function(){return this.on("end.remove",(e=this._id,function(){var t=this.parentNode;for(var n in this.__transition)if(+n!==e)return;t&&t.removeChild(this)}));var e},tween:function(e,t){var n=this._id;if(e+="",arguments.length<2){for(var i,r=jt(this.node(),n).tween,o=0,a=r.length;o<a;++o)if((i=r[o]).name===e)return i.value;return null}return this.each((null==t?qt:Wt)(n,e,t))},delay:function(e){var t=this._id;return arguments.length?this.each(("function"==typeof e?nn:rn)(t,e)):jt(this.node(),t).delay},duration:function(e){var t=this._id;return arguments.length?this.each(("function"==typeof e?on:an)(t,e)):jt(this.node(),t).duration},ease:function(e){var t=this._id;return arguments.length?this.each(function(e,t){if("function"!=typeof t)throw new Error;return function(){Ht(this,e).ease=t}}(t,e)):jt(this.node(),t).ease},easeVarying:function(e){if("function"!=typeof e)throw new Error;return this.each(function(e,t){return function(){var n=t.apply(this,arguments);if("function"!=typeof n)throw new Error;Ht(this,e).ease=n}}(this._id,e))},end:function(){var e,t,n=this,i=n._id,r=n.size();return new Promise(function(o,a){var s={value:a},l={value:function(){0===--r&&o()}};n.each(function(){var n=Ht(this,i),r=n.on;r!==e&&((t=(e=r).copy())._.cancel.push(s),t._.interrupt.push(s),t._.end.push(l)),n.on=t}),0===r&&o()})},[Symbol.iterator]:dn[Symbol.iterator]};var fn={time:null,delay:0,duration:250,ease:function(e){return((e*=2)<=1?e*e*e:(e-=2)*e*e+2)/2}};function gn(e,t){for(var n;!(n=e.__transition)||!(n=n[t]);)if(!(e=e.parentNode))throw new Error(`transition ${t} not found`);return n}de.prototype.interrupt=function(e){return this.each(function(){Ut(this,e)})},de.prototype.transition=function(e){var t,n;e instanceof un?(t=e._id,e=e._name):(t=hn(),(n=fn).time=Nt(),e=null==e?null:e+"");for(var i=this._groups,r=i.length,o=0;o<r;++o)for(var a,s=i[o],l=s.length,c=0;c<l;++c)(a=s[c])&&Bt(a,e,t,c,s,n||gn(a,t));return new un(i,this._parents,e,t)};const mn=e=>()=>e;function pn(e,{sourceEvent:t,target:n,transform:i,dispatch:r}){Object.defineProperties(this,{type:{value:e,enumerable:!0,configurable:!0},sourceEvent:{value:t,enumerable:!0,configurable:!0},target:{value:n,enumerable:!0,configurable:!0},transform:{value:i,enumerable:!0,configurable:!0},_:{value:r}})}function yn(e,t,n){this.k=e,this.x=t,this.y=n}yn.prototype={constructor:yn,scale:function(e){return 1===e?this:new yn(this.k*e,this.x,this.y)},translate:function(e,t){return 0===e&0===t?this:new yn(this.k,this.x+this.k*e,this.y+this.k*t)},apply:function(e){return[e[0]*this.k+this.x,e[1]*this.k+this.y]},applyX:function(e){return e*this.k+this.x},applyY:function(e){return e*this.k+this.y},invert:function(e){return[(e[0]-this.x)/this.k,(e[1]-this.y)/this.k]},invertX:function(e){return(e-this.x)/this.k},invertY:function(e){return(e-this.y)/this.k},rescaleX:function(e){return e.copy().domain(e.range().map(this.invertX,this).map(e.invert,e))},rescaleY:function(e){return e.copy().domain(e.range().map(this.invertY,this).map(e.invert,e))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var vn=new yn(1,0,0);function wn(e){for(;!e.__zoom;)if(!(e=e.parentNode))return vn;return e.__zoom}function xn(e){e.stopImmediatePropagation()}function bn(e){e.preventDefault(),e.stopImmediatePropagation()}function _n(e){return!(e.ctrlKey&&"wheel"!==e.type||e.button)}function Cn(){var e=this;return e instanceof SVGElement?(e=e.ownerSVGElement||e).hasAttribute("viewBox")?[[(e=e.viewBox.baseVal).x,e.y],[e.x+e.width,e.y+e.height]]:[[0,0],[e.width.baseVal.value,e.height.baseVal.value]]:[[0,0],[e.clientWidth,e.clientHeight]]}function In(){return this.__zoom||vn}function En(e){return-e.deltaY*(1===e.deltaMode?.05:e.deltaMode?1:.002)*(e.ctrlKey?10:1)}function Tn(){return navigator.maxTouchPoints||"ontouchstart"in this}function kn(e,t,n){var i=e.invertX(t[0][0])-n[0][0],r=e.invertX(t[1][0])-n[1][0],o=e.invertY(t[0][1])-n[0][1],a=e.invertY(t[1][1])-n[1][1];return e.translate(r>i?(i+r)/2:Math.min(0,i)||Math.max(0,r),a>o?(o+a)/2:Math.min(0,o)||Math.max(0,a))}function Mn(e){var t=0,n=e.children,i=n&&n.length;if(i)for(;--i>=0;)t+=n[i].value;else t=1;e.value=t}function Nn(e,t){e instanceof Map?(e=[void 0,e],void 0===t&&(t=Ln)):void 0===t&&(t=zn);for(var n,i,r,o,a,s=new Dn(e),l=[s];n=l.pop();)if((r=t(n.data))&&(a=(r=Array.from(r)).length))for(n.children=r,o=a-1;o>=0;--o)l.push(i=r[o]=new Dn(r[o])),i.parent=n,i.depth=n.depth+1;return s.eachBefore(Sn)}function zn(e){return e.children}function Ln(e){return Array.isArray(e)?e[1]:null}function An(e){void 0!==e.data.value&&(e.value=e.data.value),e.data=e.data.data}function Sn(e){var t=0;do{e.height=t}while((e=e.parent)&&e.height<++t)}function Dn(e){this.data=e,this.depth=this.height=0,this.parent=null}function Pn(e,t){return e.parent===t.parent?1:2}function Rn(e){var t=e.children;return t?t[0]:e.t}function $n(e){var t=e.children;return t?t[t.length-1]:e.t}function On(e,t,n){var i=n/(t.i-e.i);t.c-=i,t.s+=n,e.c+=i,t.z+=n,t.m+=n}function Bn(e,t,n){return e.a.parent===t.parent?e.a:n}function Fn(e,t){this._=e,this.parent=null,this.children=null,this.A=null,this.a=this,this.z=0,this.m=0,this.c=0,this.s=0,this.t=null,this.i=t}let Hn;if(wn.prototype=yn.prototype,Dn.prototype=Nn.prototype={constructor:Dn,count:function(){return this.eachAfter(Mn)},each:function(e,t){let n=-1;for(const i of this)e.call(t,i,++n,this);return this},eachAfter:function(e,t){for(var n,i,r,o=this,a=[o],s=[],l=-1;o=a.pop();)if(s.push(o),n=o.children)for(i=0,r=n.length;i<r;++i)a.push(n[i]);for(;o=s.pop();)e.call(t,o,++l,this);return this},eachBefore:function(e,t){for(var n,i,r=this,o=[r],a=-1;r=o.pop();)if(e.call(t,r,++a,this),n=r.children)for(i=n.length-1;i>=0;--i)o.push(n[i]);return this},find:function(e,t){let n=-1;for(const i of this)if(e.call(t,i,++n,this))return i},sum:function(e){return this.eachAfter(function(t){for(var n=+e(t.data)||0,i=t.children,r=i&&i.length;--r>=0;)n+=i[r].value;t.value=n})},sort:function(e){return this.eachBefore(function(t){t.children&&t.children.sort(e)})},path:function(e){for(var t=this,n=function(e,t){if(e===t)return e;var n=e.ancestors(),i=t.ancestors(),r=null;e=n.pop(),t=i.pop();for(;e===t;)r=e,e=n.pop(),t=i.pop();return r}(t,e),i=[t];t!==n;)t=t.parent,i.push(t);for(var r=i.length;e!==n;)i.splice(r,0,e),e=e.parent;return i},ancestors:function(){for(var e=this,t=[e];e=e.parent;)t.push(e);return t},descendants:function(){return Array.from(this)},leaves:function(){var e=[];return this.eachBefore(function(t){t.children||e.push(t)}),e},links:function(){var e=this,t=[];return e.each(function(n){n!==e&&t.push({source:n.parent,target:n})}),t},copy:function(){return Nn(this).eachBefore(An)},[Symbol.iterator]:function*(){var e,t,n,i,r=this,o=[r];do{for(e=o.reverse(),o=[];r=e.pop();)if(yield r,t=r.children)for(n=0,i=t.length;n<i;++n)o.push(t[n])}while(o.length)}},Fn.prototype=Object.create(Dn.prototype),"undefined"!=typeof window&&window.d3)Hn=window.d3;else try{Hn={select:fe,selectAll:function(e){return"string"==typeof e?new he([document.querySelectorAll(e)],[document.documentElement]):new he([c(e)],ue)},zoom:function(){var e,t,n,i=_n,r=Cn,o=kn,a=En,s=Tn,l=[0,1/0],c=[[-1/0,-1/0],[1/0,1/0]],u=250,h=vt,d=pe("start","zoom","end"),f=0,g=10;function m(e){e.property("__zoom",In).on("wheel.zoom",_,{passive:!1}).on("mousedown.zoom",C).on("dblclick.zoom",I).filter(s).on("touchstart.zoom",E).on("touchmove.zoom",T).on("touchend.zoom touchcancel.zoom",k).style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function p(e,t){return(t=Math.max(l[0],Math.min(l[1],t)))===e.k?e:new yn(t,e.x,e.y)}function y(e,t,n){var i=t[0]-n[0]*e.k,r=t[1]-n[1]*e.k;return i===e.x&&r===e.y?e:new yn(e.k,i,r)}function v(e){return[(+e[0][0]+ +e[1][0])/2,(+e[0][1]+ +e[1][1])/2]}function w(e,t,n,i){e.on("start.zoom",function(){x(this,arguments).event(i).start()}).on("interrupt.zoom end.zoom",function(){x(this,arguments).event(i).end()}).tween("zoom",function(){var e=this,o=arguments,a=x(e,o).event(i),s=r.apply(e,o),l=null==n?v(s):"function"==typeof n?n.apply(e,o):n,c=Math.max(s[1][0]-s[0][0],s[1][1]-s[0][1]),u=e.__zoom,d="function"==typeof t?t.apply(e,o):t,f=h(u.invert(l).concat(c/u.k),d.invert(l).concat(c/d.k));return function(e){if(1===e)e=d;else{var t=f(e),n=c/t[2];e=new yn(n,l[0]-t[0]*n,l[1]-t[1]*n)}a.zoom(null,e)}})}function x(e,t,n){return!n&&e.__zooming||new b(e,t)}function b(e,t){this.that=e,this.args=t,this.active=0,this.sourceEvent=null,this.extent=r.apply(e,t),this.taps=0}function _(e,...t){if(i.apply(this,arguments)){var n=x(this,t).event(e),r=this.__zoom,s=Math.max(l[0],Math.min(l[1],r.k*Math.pow(2,a.apply(this,arguments)))),u=ge(e);if(n.wheel)n.mouse[0][0]===u[0]&&n.mouse[0][1]===u[1]||(n.mouse[1]=r.invert(n.mouse[0]=u)),clearTimeout(n.wheel);else{if(r.k===s)return;n.mouse=[u,r.invert(u)],Ut(this),n.start()}bn(e),n.wheel=setTimeout(function(){n.wheel=null,n.end()},150),n.zoom("mouse",o(y(p(r,s),n.mouse[0],n.mouse[1]),n.extent,c))}}function C(e,...t){if(!n&&i.apply(this,arguments)){var r,a,s,l=e.currentTarget,u=x(this,t,!0).event(e),h=fe(e.view).on("mousemove.zoom",function(e){if(bn(e),!u.moved){var t=e.clientX-g,n=e.clientY-m;u.moved=t*t+n*n>f}u.event(e).zoom("mouse",o(y(u.that.__zoom,u.mouse[0]=ge(e,l),u.mouse[1]),u.extent,c))},!0).on("mouseup.zoom",function(e){var t,n,i,r;h.on("mousemove.zoom mouseup.zoom",null),t=e.view,n=u.moved,i=t.document.documentElement,r=fe(t).on("dragstart.drag",null),n&&(r.on("click.drag",be,xe),setTimeout(function(){r.on("click.drag",null)},0)),"onselectstart"in i?r.on("selectstart.drag",null):(i.style.MozUserSelect=i.__noselect,delete i.__noselect),bn(e),u.event(e).end()},!0),d=ge(e,l),g=e.clientX,m=e.clientY;a=(r=e.view).document.documentElement,s=fe(r).on("dragstart.drag",be,xe),"onselectstart"in a?s.on("selectstart.drag",be,xe):(a.__noselect=a.style.MozUserSelect,a.style.MozUserSelect="none"),xn(e),u.mouse=[d,this.__zoom.invert(d)],Ut(this),u.start()}}function I(e,...t){if(i.apply(this,arguments)){var n=this.__zoom,a=ge(e.changedTouches?e.changedTouches[0]:e,this),s=n.invert(a),l=n.k*(e.shiftKey?.5:2),h=o(y(p(n,l),a,s),r.apply(this,t),c);bn(e),u>0?fe(this).transition().duration(u).call(w,h,a,e):fe(this).call(m.transform,h,a,e)}}function E(n,...r){if(i.apply(this,arguments)){var o,a,s,l,c=n.touches,u=c.length,h=x(this,r,n.changedTouches.length===u).event(n);for(xn(n),a=0;a<u;++a)l=[l=ge(s=c[a],this),this.__zoom.invert(l),s.identifier],h.touch0?h.touch1||h.touch0[2]===l[2]||(h.touch1=l,h.taps=0):(h.touch0=l,o=!0,h.taps=1+!!e);e&&(e=clearTimeout(e)),o&&(h.taps<2&&(t=l[0],e=setTimeout(function(){e=null},500)),Ut(this),h.start())}}function T(e,...t){if(this.__zooming){var n,i,r,a,s=x(this,t).event(e),l=e.changedTouches,u=l.length;for(bn(e),n=0;n<u;++n)r=ge(i=l[n],this),s.touch0&&s.touch0[2]===i.identifier?s.touch0[0]=r:s.touch1&&s.touch1[2]===i.identifier&&(s.touch1[0]=r);if(i=s.that.__zoom,s.touch1){var h=s.touch0[0],d=s.touch0[1],f=s.touch1[0],g=s.touch1[1],m=(m=f[0]-h[0])*m+(m=f[1]-h[1])*m,v=(v=g[0]-d[0])*v+(v=g[1]-d[1])*v;i=p(i,Math.sqrt(m/v)),r=[(h[0]+f[0])/2,(h[1]+f[1])/2],a=[(d[0]+g[0])/2,(d[1]+g[1])/2]}else{if(!s.touch0)return;r=s.touch0[0],a=s.touch0[1]}s.zoom("touch",o(y(i,r,a),s.extent,c))}}function k(e,...i){if(this.__zooming){var r,o,a=x(this,i).event(e),s=e.changedTouches,l=s.length;for(xn(e),n&&clearTimeout(n),n=setTimeout(function(){n=null},500),r=0;r<l;++r)o=s[r],a.touch0&&a.touch0[2]===o.identifier?delete a.touch0:a.touch1&&a.touch1[2]===o.identifier&&delete a.touch1;if(a.touch1&&!a.touch0&&(a.touch0=a.touch1,delete a.touch1),a.touch0)a.touch0[1]=this.__zoom.invert(a.touch0[0]);else if(a.end(),2===a.taps&&(o=ge(o,this),Math.hypot(t[0]-o[0],t[1]-o[1])<g)){var c=fe(this).on("dblclick.zoom");c&&c.apply(this,arguments)}}}return m.transform=function(e,t,n,i){var r=e.selection?e.selection():e;r.property("__zoom",In),e!==r?w(e,t,n,i):r.interrupt().each(function(){x(this,arguments).event(i).start().zoom(null,"function"==typeof t?t.apply(this,arguments):t).end()})},m.scaleBy=function(e,t,n,i){m.scaleTo(e,function(){return this.__zoom.k*("function"==typeof t?t.apply(this,arguments):t)},n,i)},m.scaleTo=function(e,t,n,i){m.transform(e,function(){var e=r.apply(this,arguments),i=this.__zoom,a=null==n?v(e):"function"==typeof n?n.apply(this,arguments):n,s=i.invert(a),l="function"==typeof t?t.apply(this,arguments):t;return o(y(p(i,l),a,s),e,c)},n,i)},m.translateBy=function(e,t,n,i){m.transform(e,function(){return o(this.__zoom.translate("function"==typeof t?t.apply(this,arguments):t,"function"==typeof n?n.apply(this,arguments):n),r.apply(this,arguments),c)},null,i)},m.translateTo=function(e,t,n,i,a){m.transform(e,function(){var e=r.apply(this,arguments),a=this.__zoom,s=null==i?v(e):"function"==typeof i?i.apply(this,arguments):i;return o(vn.translate(s[0],s[1]).scale(a.k).translate("function"==typeof t?-t.apply(this,arguments):-t,"function"==typeof n?-n.apply(this,arguments):-n),e,c)},i,a)},b.prototype={event:function(e){return e&&(this.sourceEvent=e),this},start:function(){return 1===++this.active&&(this.that.__zooming=this,this.emit("start")),this},zoom:function(e,t){return this.mouse&&"mouse"!==e&&(this.mouse[1]=t.invert(this.mouse[0])),this.touch0&&"touch"!==e&&(this.touch0[1]=t.invert(this.touch0[0])),this.touch1&&"touch"!==e&&(this.touch1[1]=t.invert(this.touch1[0])),this.that.__zoom=t,this.emit("zoom"),this},end:function(){return 0===--this.active&&(delete this.that.__zooming,this.emit("end")),this},emit:function(e){var t=fe(this.that).datum();d.call(e,this.that,new pn(e,{sourceEvent:this.sourceEvent,target:m,transform:this.that.__zoom,dispatch:d}),t)}},m.wheelDelta=function(e){return arguments.length?(a="function"==typeof e?e:mn(+e),m):a},m.filter=function(e){return arguments.length?(i="function"==typeof e?e:mn(!!e),m):i},m.touchable=function(e){return arguments.length?(s="function"==typeof e?e:mn(!!e),m):s},m.extent=function(e){return arguments.length?(r="function"==typeof e?e:mn([[+e[0][0],+e[0][1]],[+e[1][0],+e[1][1]]]),m):r},m.scaleExtent=function(e){return arguments.length?(l[0]=+e[0],l[1]=+e[1],m):[l[0],l[1]]},m.translateExtent=function(e){return arguments.length?(c[0][0]=+e[0][0],c[1][0]=+e[1][0],c[0][1]=+e[0][1],c[1][1]=+e[1][1],m):[[c[0][0],c[0][1]],[c[1][0],c[1][1]]]},m.constrain=function(e){return arguments.length?(o=e,m):o},m.duration=function(e){return arguments.length?(u=+e,m):u},m.interpolate=function(e){return arguments.length?(h=e,m):h},m.on=function(){var e=d.on.apply(d,arguments);return e===d?m:e},m.clickDistance=function(e){return arguments.length?(f=(e=+e)*e,m):Math.sqrt(f)},m.tapDistance=function(e){return arguments.length?(g=+e,m):g},m},zoomIdentity:vn,zoomTransform:wn,hierarchy:Nn,tree:function(){var e=Pn,t=1,n=1,i=null;function r(r){var l=function(e){for(var t,n,i,r,o,a=new Fn(e,0),s=[a];t=s.pop();)if(i=t._.children)for(t.children=new Array(o=i.length),r=o-1;r>=0;--r)s.push(n=t.children[r]=new Fn(i[r],r)),n.parent=t;return(a.parent=new Fn(null,0)).children=[a],a}(r);if(l.eachAfter(o),l.parent.m=-l.z,l.eachBefore(a),i)r.eachBefore(s);else{var c=r,u=r,h=r;r.eachBefore(function(e){e.x<c.x&&(c=e),e.x>u.x&&(u=e),e.depth>h.depth&&(h=e)});var d=c===u?1:e(c,u)/2,f=d-c.x,g=t/(u.x+d+f),m=n/(h.depth||1);r.eachBefore(function(e){e.x=(e.x+f)*g,e.y=e.depth*m})}return r}function o(t){var n=t.children,i=t.parent.children,r=t.i?i[t.i-1]:null;if(n){!function(e){for(var t,n=0,i=0,r=e.children,o=r.length;--o>=0;)(t=r[o]).z+=n,t.m+=n,n+=t.s+(i+=t.c)}(t);var o=(n[0].z+n[n.length-1].z)/2;r?(t.z=r.z+e(t._,r._),t.m=t.z-o):t.z=o}else r&&(t.z=r.z+e(t._,r._));t.parent.A=function(t,n,i){if(n){for(var r,o=t,a=t,s=n,l=o.parent.children[0],c=o.m,u=a.m,h=s.m,d=l.m;s=$n(s),o=Rn(o),s&&o;)l=Rn(l),(a=$n(a)).a=t,(r=s.z+h-o.z-c+e(s._,o._))>0&&(On(Bn(s,t,i),t,r),c+=r,u+=r),h+=s.m,c+=o.m,d+=l.m,u+=a.m;s&&!$n(a)&&(a.t=s,a.m+=h-u),o&&!Rn(l)&&(l.t=o,l.m+=c-d,i=t)}return i}(t,r,t.parent.A||i[0])}function a(e){e._.x=e.z+e.parent.m,e.m+=e.parent.m}function s(e){e.x*=t,e.y=e.depth*n}return r.separation=function(t){return arguments.length?(e=t,r):e},r.size=function(e){return arguments.length?(i=!1,t=+e[0],n=+e[1],r):i?null:[t,n]},r.nodeSize=function(e){return arguments.length?(i=!0,t=+e[0],n=+e[1],r):i?[t,n]:null},r},easeCubicOut:function(e){return--e*e*e+1}}}catch(Ti){throw console.error(" Error cargando D3:",Ti),new Error("D3 no est disponible ni globalmente ni como mdulo ES6")}"undefined"!=typeof window&&(window.d3=Hn);"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function jn(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Un={exports:{}};
/* @license
  Papa Parse
  v5.5.3
  https://github.com/mholt/PapaParse
  License: MIT
  */Un.exports=function e(){var t,n="undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==n?n:{},i=!n.document&&!!n.postMessage,r=n.IS_PAPA_WORKER||!1,o={},a=0,s={};function l(e){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},function(e){var t=w(e);t.chunkSize=parseInt(t.chunkSize),e.step||e.chunk||(t.chunkSize=null),this._handle=new f(t),(this._handle.streamer=this)._config=t}.call(this,e),this.parseChunk=function(e,t){var i=parseInt(this._config.skipFirstNLines)||0;if(this.isFirstChunk&&0<i){let t=this._config.newline;t||(o=this._config.quoteChar||'"',t=this._handle.guessLineEndings(e,o)),e=[...e.split(t).slice(i)].join(t)}this.isFirstChunk&&b(this._config.beforeFirstChunk)&&void 0!==(o=this._config.beforeFirstChunk(e))&&(e=o),this.isFirstChunk=!1,this._halted=!1,i=this._partialLine+e;var o=(this._partialLine="",this._handle.parse(i,this._baseIndex,!this._finished));if(!this._handle.paused()&&!this._handle.aborted()){if(e=o.meta.cursor,this._finished||(this._partialLine=i.substring(e-this._baseIndex),this._baseIndex=e),o&&o.data&&(this._rowCount+=o.data.length),i=this._finished||this._config.preview&&this._rowCount>=this._config.preview,r)n.postMessage({results:o,workerId:s.WORKER_ID,finished:i});else if(b(this._config.chunk)&&!t){if(this._config.chunk(o,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);this._completeResults=o=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(o.data),this._completeResults.errors=this._completeResults.errors.concat(o.errors),this._completeResults.meta=o.meta),this._completed||!i||!b(this._config.complete)||o&&o.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),i||o&&o.meta.paused||this._nextChunk(),o}this._halted=!0},this._sendError=function(e){b(this._config.error)?this._config.error(e):r&&this._config.error&&n.postMessage({workerId:s.WORKER_ID,error:e,finished:!1})}}function c(e){var t;(e=e||{}).chunkSize||(e.chunkSize=s.RemoteChunkSize),l.call(this,e),this._nextChunk=i?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(e){this._input=e,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(t=new XMLHttpRequest,this._config.withCredentials&&(t.withCredentials=this._config.withCredentials),i||(t.onload=x(this._chunkLoaded,this),t.onerror=x(this._chunkError,this)),t.open(this._config.downloadRequestBody?"POST":"GET",this._input,!i),this._config.downloadRequestHeaders){var e,n=this._config.downloadRequestHeaders;for(e in n)t.setRequestHeader(e,n[e])}var r;this._config.chunkSize&&(r=this._start+this._config.chunkSize-1,t.setRequestHeader("Range","bytes="+this._start+"-"+r));try{t.send(this._config.downloadRequestBody)}catch(o){this._chunkError(o.message)}i&&0===t.status&&this._chunkError()}},this._chunkLoaded=function(){var e;4===t.readyState&&(t.status<200||400<=t.status?this._chunkError():(this._start+=this._config.chunkSize||t.responseText.length,this._finished=!this._config.chunkSize||this._start>=(null!==(e=(e=t).getResponseHeader("Content-Range"))?parseInt(e.substring(e.lastIndexOf("/")+1)):-1),this.parseChunk(t.responseText)))},this._chunkError=function(e){e=t.statusText||e,this._sendError(new Error(e))}}function u(e){(e=e||{}).chunkSize||(e.chunkSize=s.LocalChunkSize),l.call(this,e);var t,n,i="undefined"!=typeof FileReader;this.stream=function(e){this._input=e,n=e.slice||e.webkitSlice||e.mozSlice,i?((t=new FileReader).onload=x(this._chunkLoaded,this),t.onerror=x(this._chunkError,this)):t=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var e=this._input,r=(this._config.chunkSize&&(r=Math.min(this._start+this._config.chunkSize,this._input.size),e=n.call(e,this._start,r)),t.readAsText(e,this._config.encoding));i||this._chunkLoaded({target:{result:r}})},this._chunkLoaded=function(e){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(e.target.result)},this._chunkError=function(){this._sendError(t.error)}}function h(e){var t;l.call(this,e=e||{}),this.stream=function(e){return t=e,this._nextChunk()},this._nextChunk=function(){var e,n;if(!this._finished)return e=this._config.chunkSize,t=e?(n=t.substring(0,e),t.substring(e)):(n=t,""),this._finished=!t,this.parseChunk(n)}}function d(e){l.call(this,e=e||{});var t=[],n=!0,i=!1;this.pause=function(){l.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){l.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(e){this._input=e,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){i&&1===t.length&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),t.length?this.parseChunk(t.shift()):n=!0},this._streamData=x(function(e){try{t.push("string"==typeof e?e:e.toString(this._config.encoding)),n&&(n=!1,this._checkIsFinished(),this.parseChunk(t.shift()))}catch(i){this._streamError(i)}},this),this._streamError=x(function(e){this._streamCleanUp(),this._sendError(e)},this),this._streamEnd=x(function(){this._streamCleanUp(),i=!0,this._streamData("")},this),this._streamCleanUp=x(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function f(e){var t,n,i,r,o=Math.pow(2,53),a=-o,l=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,c=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,u=this,h=0,d=0,f=!1,p=!1,y=[],v={data:[],errors:[],meta:{}};function x(t){return"greedy"===e.skipEmptyLines?""===t.join("").trim():1===t.length&&0===t[0].length}function _(){if(v&&i&&(I("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+s.DefaultDelimiter+"'"),i=!1),e.skipEmptyLines&&(v.data=v.data.filter(function(e){return!x(e)})),C()){let n=function(t,n){b(e.transformHeader)&&(t=e.transformHeader(t,n)),y.push(t)};if(v)if(Array.isArray(v.data[0])){for(var t=0;C()&&t<v.data.length;t++)v.data[t].forEach(n);v.data.splice(0,1)}else v.data.forEach(n)}function n(t,n){for(var i=e.header?{}:[],r=0;r<t.length;r++){var s=r,u=t[r];u=((t,n)=>{return i=t,e.dynamicTypingFunction&&void 0===e.dynamicTyping[i]&&(e.dynamicTyping[i]=e.dynamicTypingFunction(i)),!0===(e.dynamicTyping[i]||e.dynamicTyping)?"true"===n||"TRUE"===n||"false"!==n&&"FALSE"!==n&&((e=>{if(l.test(e)&&(e=parseFloat(e),a<e&&e<o))return 1})(n)?parseFloat(n):c.test(n)?new Date(n):""===n?null:n):n;var i})(s=e.header?r>=y.length?"__parsed_extra":y[r]:s,u=e.transform?e.transform(u,s):u),"__parsed_extra"===s?(i[s]=i[s]||[],i[s].push(u)):i[s]=u}return e.header&&(r>y.length?I("FieldMismatch","TooManyFields","Too many fields: expected "+y.length+" fields but parsed "+r,d+n):r<y.length&&I("FieldMismatch","TooFewFields","Too few fields: expected "+y.length+" fields but parsed "+r,d+n)),i}var r;v&&(e.header||e.dynamicTyping||e.transform)&&(r=1,!v.data.length||Array.isArray(v.data[0])?(v.data=v.data.map(n),r=v.data.length):v.data=n(v.data,0),e.header&&v.meta&&(v.meta.fields=y),d+=r)}function C(){return e.header&&0===y.length}function I(e,t,n,i){e={type:e,code:t,message:n},void 0!==i&&(e.row=i),v.errors.push(e)}b(e.step)&&(r=e.step,e.step=function(t){v=t,C()?_():(_(),0!==v.data.length&&(h+=t.data.length,e.preview&&h>e.preview?n.abort():(v.data=v.data[0],r(v,u))))}),this.parse=function(r,o,a){var l=e.quoteChar||'"';return e.newline||(e.newline=this.guessLineEndings(r,l)),i=!1,e.delimiter?b(e.delimiter)&&(e.delimiter=e.delimiter(r),v.meta.delimiter=e.delimiter):((l=((t,n,i,r,o)=>{var a,l,c,u;o=o||[",","\t","|",";",s.RECORD_SEP,s.UNIT_SEP];for(var h=0;h<o.length;h++){for(var d,f=o[h],g=0,p=0,y=0,v=(c=void 0,new m({comments:r,delimiter:f,newline:n,preview:10}).parse(t)),w=0;w<v.data.length;w++)i&&x(v.data[w])?y++:(p+=d=v.data[w].length,void 0===c?c=d:0<d&&(g+=Math.abs(d-c),c=d));0<v.data.length&&(p/=v.data.length-y),(void 0===l||g<=l)&&(void 0===u||u<p)&&1.99<p&&(l=g,a=f,u=p)}return{successful:!!(e.delimiter=a),bestDelimiter:a}})(r,e.newline,e.skipEmptyLines,e.comments,e.delimitersToGuess)).successful?e.delimiter=l.bestDelimiter:(i=!0,e.delimiter=s.DefaultDelimiter),v.meta.delimiter=e.delimiter),l=w(e),e.preview&&e.header&&l.preview++,t=r,n=new m(l),v=n.parse(t,o,a),_(),f?{meta:{paused:!0}}:v||{meta:{paused:!1}}},this.paused=function(){return f},this.pause=function(){f=!0,n.abort(),t=b(e.chunk)?"":t.substring(n.getCharIndex())},this.resume=function(){u.streamer._halted?(f=!1,u.streamer.parseChunk(t,!0)):setTimeout(u.resume,3)},this.aborted=function(){return p},this.abort=function(){p=!0,n.abort(),v.meta.aborted=!0,b(e.complete)&&e.complete(v),t=""},this.guessLineEndings=function(e,t){e=e.substring(0,1048576),t=new RegExp(g(t)+"([^]*?)"+g(t),"gm");var n=(e=e.replace(t,"")).split("\r");if(e=1<(t=e.split("\n")).length&&t[0].length<n[0].length,1===n.length||e)return"\n";for(var i=0,r=0;r<n.length;r++)"\n"===n[r][0]&&i++;return i>=n.length/2?"\r\n":"\r"}}function g(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function m(e){var t=(e=e||{}).delimiter,n=e.newline,i=e.comments,r=e.step,o=e.preview,a=e.fastMode,l=null,c=!1,u=null==e.quoteChar?'"':e.quoteChar,h=u;if(void 0!==e.escapeChar&&(h=e.escapeChar),("string"!=typeof t||-1<s.BAD_DELIMITERS.indexOf(t))&&(t=","),i===t)throw new Error("Comment character same as delimiter");!0===i?i="#":("string"!=typeof i||-1<s.BAD_DELIMITERS.indexOf(i))&&(i=!1),"\n"!==n&&"\r"!==n&&"\r\n"!==n&&(n="\n");var d=0,f=!1;this.parse=function(s,m,p){if("string"!=typeof s)throw new Error("Input must be a string");var y=s.length,v=t.length,w=n.length,x=i.length,_=b(r),C=[],I=[],E=[],T=d=0;if(!s)return O();if(a||!1!==a&&-1===s.indexOf(u)){for(var k=s.split(n),M=0;M<k.length;M++){if(E=k[M],d+=E.length,M!==k.length-1)d+=n.length;else if(p)return O();if(!i||E.substring(0,x)!==i){if(_){if(C=[],D(E.split(t)),B(),f)return O()}else D(E.split(t));if(o&&o<=M)return C=C.slice(0,o),O(!0)}}return O()}for(var N=s.indexOf(t,d),z=s.indexOf(n,d),L=new RegExp(g(h)+g(u),"g"),A=s.indexOf(u,d);;)if(s[d]===u)for(A=d,d++;;){if(-1===(A=s.indexOf(u,A+1)))return p||I.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:C.length,index:d}),R();if(A===y-1)return R(s.substring(d,A).replace(L,u));if(u===h&&s[A+1]===h)A++;else if(u===h||0===A||s[A-1]!==h){-1!==N&&N<A+1&&(N=s.indexOf(t,A+1));var S=P(-1===(z=-1!==z&&z<A+1?s.indexOf(n,A+1):z)?N:Math.min(N,z));if(s.substr(A+1+S,v)===t){E.push(s.substring(d,A).replace(L,u)),s[d=A+1+S+v]!==u&&(A=s.indexOf(u,d)),N=s.indexOf(t,d),z=s.indexOf(n,d);break}if(S=P(z),s.substring(A+1+S,A+1+S+w)===n){if(E.push(s.substring(d,A).replace(L,u)),$(A+1+S+w),N=s.indexOf(t,d),A=s.indexOf(u,d),_&&(B(),f))return O();if(o&&C.length>=o)return O(!0);break}I.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:C.length,index:d}),A++}}else if(i&&0===E.length&&s.substring(d,d+x)===i){if(-1===z)return O();d=z+w,z=s.indexOf(n,d),N=s.indexOf(t,d)}else if(-1!==N&&(N<z||-1===z))E.push(s.substring(d,N)),d=N+v,N=s.indexOf(t,d);else{if(-1===z)break;if(E.push(s.substring(d,z)),$(z+w),_&&(B(),f))return O();if(o&&C.length>=o)return O(!0)}return R();function D(e){C.push(e),T=d}function P(e){var t=0;return-1!==e&&(e=s.substring(A+1,e))&&""===e.trim()?e.length:t}function R(e){return p||(void 0===e&&(e=s.substring(d)),E.push(e),d=y,D(E),_&&B()),O()}function $(e){d=e,D(E),E=[],z=s.indexOf(n,d)}function O(i){if(e.header&&!m&&C.length&&!c){var r=C[0],o=Object.create(null),a=new Set(r);let t=!1;for(let n=0;n<r.length;n++){let i=r[n];if(o[i=b(e.transformHeader)?e.transformHeader(i,n):i]){let e,s=o[i];for(;e=i+"_"+s,s++,a.has(e););a.add(e),r[n]=e,o[i]++,t=!0,(l=null===l?{}:l)[e]=i}else o[i]=1,r[n]=i;a.add(i)}t&&console.warn("Duplicate headers found and renamed."),c=!0}return{data:C,errors:I,meta:{delimiter:t,linebreak:n,aborted:f,truncated:!!i,cursor:T+(m||0),renamedHeaders:l}}}function B(){r(O()),C=[],I=[]}},this.abort=function(){f=!0},this.getCharIndex=function(){return d}}function p(e){var t=e.data,n=o[t.workerId],i=!1;if(t.error)n.userError(t.error,t.file);else if(t.results&&t.results.data){var r={abort:function(){i=!0,y(t.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:v,resume:v};if(b(n.userStep)){for(var a=0;a<t.results.data.length&&(n.userStep({data:t.results.data[a],errors:t.results.errors,meta:t.results.meta},r),!i);a++);delete t.results}else b(n.userChunk)&&(n.userChunk(t.results,r,t.file),delete t.results)}t.finished&&!i&&y(t.workerId,t.results)}function y(e,t){var n=o[e];b(n.userComplete)&&n.userComplete(t),n.terminate(),delete o[e]}function v(){throw new Error("Not implemented.")}function w(e){if("object"!=typeof e||null===e)return e;var t,n=Array.isArray(e)?[]:{};for(t in e)n[t]=w(e[t]);return n}function x(e,t){return function(){e.apply(t,arguments)}}function b(e){return"function"==typeof e}return s.parse=function(t,i){var r,l=(i=i||{}).dynamicTyping||!1;if(b(l)&&(i.dynamicTypingFunction=l,l={}),i.dynamicTyping=l,i.transform=!!b(i.transform)&&i.transform,!i.worker||!s.WORKERS_SUPPORTED)return l=null,s.NODE_STREAM_INPUT,"string"==typeof t?(t=65279!==(r=t).charCodeAt(0)?r:r.slice(1),l=new(i.download?c:h)(i)):!0===t.readable&&b(t.read)&&b(t.on)?l=new d(i):(n.File&&t instanceof File||t instanceof Object)&&(l=new u(i)),l.stream(t);(l=(()=>{var t,i,r;return!!s.WORKERS_SUPPORTED&&(i=n.URL||n.webkitURL||null,r=e.toString(),t=s.BLOB_URL||(s.BLOB_URL=i.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",r,")();"],{type:"text/javascript"}))),(t=new n.Worker(t)).onmessage=p,t.id=a++,o[t.id]=t)})()).userStep=i.step,l.userChunk=i.chunk,l.userComplete=i.complete,l.userError=i.error,i.step=b(i.step),i.chunk=b(i.chunk),i.complete=b(i.complete),i.error=b(i.error),delete i.worker,l.postMessage({input:t,config:i,workerId:l.id})},s.unparse=function(e,t){var n=!1,i=!0,r=",",o="\r\n",a='"',l=a+a,c=!1,u=null,h=!1,d=((()=>{if("object"==typeof t){if("string"!=typeof t.delimiter||s.BAD_DELIMITERS.filter(function(e){return-1!==t.delimiter.indexOf(e)}).length||(r=t.delimiter),"boolean"!=typeof t.quotes&&"function"!=typeof t.quotes&&!Array.isArray(t.quotes)||(n=t.quotes),"boolean"!=typeof t.skipEmptyLines&&"string"!=typeof t.skipEmptyLines||(c=t.skipEmptyLines),"string"==typeof t.newline&&(o=t.newline),"string"==typeof t.quoteChar&&(a=t.quoteChar),"boolean"==typeof t.header&&(i=t.header),Array.isArray(t.columns)){if(0===t.columns.length)throw new Error("Option columns is empty");u=t.columns}void 0!==t.escapeChar&&(l=t.escapeChar+a),t.escapeFormulae instanceof RegExp?h=t.escapeFormulae:"boolean"==typeof t.escapeFormulae&&t.escapeFormulae&&(h=/^[=+\-@\t\r].*$/)}})(),new RegExp(g(a),"g"));if("string"==typeof e&&(e=JSON.parse(e)),Array.isArray(e)){if(!e.length||Array.isArray(e[0]))return f(null,e,c);if("object"==typeof e[0])return f(u||Object.keys(e[0]),e,c)}else if("object"==typeof e)return"string"==typeof e.data&&(e.data=JSON.parse(e.data)),Array.isArray(e.data)&&(e.fields||(e.fields=e.meta&&e.meta.fields||u),e.fields||(e.fields=Array.isArray(e.data[0])?e.fields:"object"==typeof e.data[0]?Object.keys(e.data[0]):[]),Array.isArray(e.data[0])||"object"==typeof e.data[0]||(e.data=[e.data])),f(e.fields||[],e.data||[],c);throw new Error("Unable to serialize unrecognized input");function f(e,t,n){var a="",s=("string"==typeof e&&(e=JSON.parse(e)),"string"==typeof t&&(t=JSON.parse(t)),Array.isArray(e)&&0<e.length),l=!Array.isArray(t[0]);if(s&&i){for(var c=0;c<e.length;c++)0<c&&(a+=r),a+=m(e[c],c);0<t.length&&(a+=o)}for(var u=0;u<t.length;u++){var h=(s?e:t[u]).length,d=!1,f=s?0===Object.keys(t[u]).length:0===t[u].length;if(n&&!s&&(d="greedy"===n?""===t[u].join("").trim():1===t[u].length&&0===t[u][0].length),"greedy"===n&&s){for(var g=[],p=0;p<h;p++){var y=l?e[p]:p;g.push(t[u][y])}d=""===g.join("").trim()}if(!d){for(var v=0;v<h;v++){0<v&&!f&&(a+=r);var w=s&&l?e[v]:v;a+=m(t[u][w],v)}u<t.length-1&&(!n||0<h&&!f)&&(a+=o)}}return a}function m(e,t){var i,o;return null==e?"":e.constructor===Date?JSON.stringify(e).slice(1,25):(o=!1,h&&"string"==typeof e&&h.test(e)&&(e="'"+e,o=!0),i=e.toString().replace(d,l),(o=o||!0===n||"function"==typeof n&&n(e,t)||Array.isArray(n)&&n[t]||((e,t)=>{for(var n=0;n<t.length;n++)if(-1<e.indexOf(t[n]))return!0;return!1})(i,s.BAD_DELIMITERS)||-1<i.indexOf(r)||" "===i.charAt(0)||" "===i.charAt(i.length-1))?a+i+a:i)}},s.RECORD_SEP=String.fromCharCode(30),s.UNIT_SEP=String.fromCharCode(31),s.BYTE_ORDER_MARK="\ufeff",s.BAD_DELIMITERS=["\r","\n",'"',s.BYTE_ORDER_MARK],s.WORKERS_SUPPORTED=!i&&!!n.Worker,s.NODE_STREAM_INPUT=1,s.LocalChunkSize=10485760,s.RemoteChunkSize=5242880,s.DefaultDelimiter=",",s.Parser=m,s.ParserHandle=f,s.NetworkStreamer=c,s.FileStreamer=u,s.StringStreamer=h,s.ReadableStreamStreamer=d,n.jQuery&&((t=n.jQuery).fn.parse=function(e){var i=e.config||{},r=[];return this.each(function(e){if("INPUT"!==t(this).prop("tagName").toUpperCase()||"file"!==t(this).attr("type").toLowerCase()||!n.FileReader||!this.files||0===this.files.length)return!0;for(var o=0;o<this.files.length;o++)r.push({file:this.files[o],inputElem:this,instanceConfig:t.extend({},i)})}),o(),this;function o(){if(0===r.length)b(e.complete)&&e.complete();else{var n,i,o,l,c=r[0];if(b(e.before)){var u=e.before(c.file,c.inputElem);if("object"==typeof u){if("abort"===u.action)return n="AbortError",i=c.file,o=c.inputElem,l=u.reason,void(b(e.error)&&e.error({name:n},i,o,l));if("skip"===u.action)return void a();"object"==typeof u.config&&(c.instanceConfig=t.extend(c.instanceConfig,u.config))}else if("skip"===u)return void a()}var h=c.instanceConfig.complete;c.instanceConfig.complete=function(e){b(h)&&h(e,c.file,c.inputElem),a()},s.parse(c.file,c.instanceConfig)}}function a(){r.splice(0,1),o()}}),r&&(n.onmessage=function(e){e=e.data,void 0===s.WORKER_ID&&e&&(s.WORKER_ID=e.workerId),"string"==typeof e.input?n.postMessage({workerId:s.WORKER_ID,results:s.parse(e.input,e.config),finished:!0}):(n.File&&e.input instanceof File||e.input instanceof Object)&&(e=s.parse(e.input,e.config))&&n.postMessage({workerId:s.WORKER_ID,results:e,finished:!0})}),(c.prototype=Object.create(l.prototype)).constructor=c,(u.prototype=Object.create(l.prototype)).constructor=u,(h.prototype=Object.create(h.prototype)).constructor=h,(d.prototype=Object.create(l.prototype)).constructor=d,s}();const qn=jn(Un.exports);let Wn;if("undefined"!=typeof window&&window.Papa)Wn=window.Papa;else try{Wn=qn}catch(Ti){throw console.error(" Error cargando PapaParse:",Ti),new Error("PapaParse no est disponible ni globalmente ni como mdulo ES6")}"undefined"!=typeof window&&(window.Papa=Wn);class Xn{constructor(){this.sourcePatterns={googleSheets:["google.com/spreadsheets","docs.google.com"],restApi:["api.","/api/"],csvUrl:[".csv","output=csv"],jsonUrl:[".json"],protectedApi:["sheet.best"]}}detectSourceType(e,t={}){if("string"==typeof e){return this.detectStringSource(e,t)}return Array.isArray(e)?"multiple-urls":"object"==typeof e&&null!==e?this.detectObjectSource(e):"unknown"}detectStringSource(e,t={}){const n=e.toLowerCase();return t.privateApi&&(n.includes("sheetbest.com")||n.includes("api.sheetbest.com"))||this.sourcePatterns.protectedApi.some(e=>n.includes(e))?"protected-api":this.sourcePatterns.googleSheets.some(e=>n.includes(e))?"google-sheets":n.endsWith(".json")||n.includes(".json?")?"json-url":this.sourcePatterns.csvUrl.some(e=>n.includes(e))?"csv-url":this.sourcePatterns.restApi.some(e=>n.includes(e))?"rest-api":"unknown"}detectObjectSource(e){return e.urls&&Array.isArray(e.urls)?"multiple-urls":e.data||e.records?"object":"unknown"}isValidUrl(e){try{return new URL(e),!0}catch{return!1}}requiresAuthentication(e){const t=e.toLowerCase();return this.sourcePatterns.protectedApi.some(e=>t.includes(e))}getAuthInfo(e){const t=this.requiresAuthentication(e);return{requiresAuth:t,hasApiKey:t,configuredPatterns:this.sourcePatterns.protectedApi}}convertGoogleSheetsToCsv(e){return e.includes("output=csv")?e:e.includes("/edit")?e.replace("/edit","/pub?output=csv"):e.includes("/pub")&&e.includes("?")?`${e}&output=csv`:`${e}?output=csv`}}class Zn{constructor(){this.authMethods={"sheet.best":this.createSheetBestAuth,"sheetbest.com":this.createSheetBestAuth,default:this.createDefaultAuth}}createSheetBestAuth(e){return{"X-Api-Key":e,"Content-Type":"application/json"}}createDefaultAuth(e){return{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}getAuthHeaders(e){return null}requiresAuthentication(e){if(!e)return!1;const t=e.toLowerCase();return t.includes("sheet.best")||t.includes("sheetbest.com")}addAuthMethod(e,t){this.authMethods[e]=t}getAuthInfo(e){const t=this.requiresAuthentication(e);return{url:e,requiresAuthentication:t,hasApiKey:t,configuredPatterns:["sheet.best","sheetbest.com"],authMethod:t?this.getAuthMethodName(e):null}}getAuthMethodName(e){try{const t=new URL(e).hostname;for(const[e,n]of Object.entries(this.authMethods))if(t.includes(e))return e;return"default"}catch(Ti){return"unknown"}}validateApiKeyFormat(e){return!(!e||"string"!=typeof e)&&e.trim().length>=10}handleAuthError(e,t){let n="Error de autenticacin";switch(e.status){case 401:n="API Key invlida o expirada. Verifica tu configuracin.";break;case 403:n="Acceso denegado. Verifica que tu API Key tenga los permisos necesarios.";break;case 429:n="Lmite de requests excedido. Intenta ms tarde.";break;default:n=`Error de autenticacin: ${e.status} ${e.statusText}`}const i=new Error(n);return i.status=e.status,i.url=t,i.isAuthError=!0,i}}class Vn{constructor(){this.sourceDetector=new Xn,this.authManager=new Zn}async loadFromGoogleSheets(e,t={}){try{const n=this.sourceDetector.convertGoogleSheetsToCsv(e),i=t.timeout||1e4,r=new AbortController,o=setTimeout(()=>r.abort(),i),a=await fetch(n,{signal:r.signal,mode:"cors"});if(clearTimeout(o),!a.ok)throw new Error(`Error HTTP: ${a.status} - ${a.statusText}`);const s=await a.text();if(!s||""===s.trim())throw new Error("El archivo de Google Sheets est vaco o no contiene datos vlidos");return this.parseCsv(s,t)}catch(Ti){if(console.error("Error loading from Google Sheets:",Ti),"AbortError"===Ti.name)throw new Error(`Timeout: No se pudo cargar el archivo de Google Sheets despus de ${timeout}ms. Verifica la URL y tu conexin a internet.`);if(Ti.message.includes("Failed to fetch")||Ti.message.includes("ERR_CONNECTION_CLOSED"))throw new Error("Error de conexin: No se pudo conectar con Google Sheets. Verifica tu conexin a internet y que la URL sea correcta.");if(Ti.message.includes("CORS"))throw new Error("Error de CORS: El archivo de Google Sheets no permite acceso desde este dominio. Verifica la configuracin de permisos.");throw new Error(`Error cargando Google Sheets: ${Ti.message}`)}}async loadFromRestApi(e,t={}){const n={headers:{"Content-Type":"application/json",...this.authManager.getAuthHeaders(e)}},i=await fetch(e,n);if(!i.ok){if(401===i.status||403===i.status)throw this.authManager.handleAuthError(i,e);throw new Error(`Error HTTP: ${i.status}`)}const r=await i.json();return this.convertJsonToCsvFormat(r,t)}async loadFromCsvUrl(e,t={}){const n={headers:{"Content-Type":"text/csv",...this.authManager.getAuthHeaders(e)}},i=await fetch(e,n);if(!i.ok){if(401===i.status||403===i.status)throw this.authManager.handleAuthError(i,e);throw new Error(`Error HTTP: ${i.status}`)}const r=await i.text();return this.parseCsv(r,t)}async loadFromJsonUrl(e,t={}){const n={headers:{"Content-Type":"application/json",...this.authManager.getAuthHeaders(e)}},i=await fetch(e,n);if(!i.ok){if(401===i.status||403===i.status)throw this.authManager.handleAuthError(i,e);throw new Error(`Error HTTP: ${i.status}`)}const r=await i.json();return this.convertJsonToCsvFormat(r,t)}async loadFromProtectedApi(e,t={}){try{console.log(` [DataLoader] Cargando desde API protegida via Netlify Function: ${e}`);const n=`/api/sheetbest-proxy?url=${encodeURIComponent(e)}`;console.log(` [DataLoader] Proxy URL: ${n}`);const i=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}});if(console.log(` [DataLoader] Response status: ${i.status}`),console.log(" [DataLoader] Response headers:",Object.fromEntries(i.headers.entries())),!i.ok){const e=await i.json().catch(()=>({}));throw new Error(e.error||`Error HTTP: ${i.status}`)}const r=await i.json();return console.log(" [DataLoader] Datos cargados exitosamente desde proxy"),Array.isArray(r)?r:this.convertJsonToCsvFormat(r,t)}catch(Ti){throw console.error(" [DataLoader] Error cargando desde API protegida:",Ti),new Error(`Error cargando API protegida: ${Ti.message}`)}}loadFromObject(e){return Array.isArray(e)?e:e.data?Array.isArray(e.data)?e.data:[e.data]:e.records?Array.isArray(e.records)?e.records:[e.records]:[e]}async loadFromMultipleUrls(e,t={}){const n=Array.isArray(e)?e:e.urls,i=e.combineStrategy||"append";let r=[];for(let o=0;o<n.length;o++){const e=n[o];try{const n=await this.loadData(e,e=>e,t);if(n&&Array.isArray(n)){const t=n.map(t=>({...t,_source:e,_sourceIndex:o}));r="merge"===i?this.mergeData(r,t):r.concat(t)}}catch(Ti){console.warn(`Error cargando URL ${e}:`,Ti)}}return r}mergeData(e,t){const n=[...e];return t.forEach(e=>{const t=n.findIndex(t=>t.id===e.id||t.ID===e.ID||t.node===e.node||t.Node===e.Node);t>=0?n[t]={...n[t],...e}:n.push(e)}),n}parseCsv(e,t={}){return new Promise((n,i)=>{Papa.parse(e,{header:!0,skipEmptyLines:!0,...t,complete:e=>{n(e.data)},error:e=>{i(e)}})})}convertJsonToCsvFormat(e,t={}){if(Array.isArray(e))return e;if(e.data&&Array.isArray(e.data))return e.data;if(e.records&&Array.isArray(e.records))return e.records;if(e.items&&Array.isArray(e.items))return e.items;if("object"==typeof e&&null!==e)return[e];if("string"==typeof e)try{const n=JSON.parse(e);return this.convertJsonToCsvFormat(n,t)}catch(Ti){throw new Error("Datos JSON invlidos")}throw new Error("Formato de datos no reconocido")}async loadData(e,t,n={}){let i;try{let r;switch(i=this.sourceDetector.detectSourceType(e,n),i){case"protected-api":r=await this.loadFromProtectedApi(e,n);break;case"google-sheets":r=await this.loadFromGoogleSheets(e,n);break;case"rest-api":r=await this.loadFromRestApi(e,n);break;case"csv-url":r=await this.loadFromCsvUrl(e,n);break;case"json-url":r=await this.loadFromJsonUrl(e,n);break;case"object":r=this.loadFromObject(e);break;case"multiple-urls":r=await this.loadFromMultipleUrls(e,n);break;case"unknown":throw new Error(`No se pudo determinar el tipo de fuente. URL o formato no reconocido: ${e}`);default:throw new Error(`Tipo de fuente no soportado: ${i}`)}t(r)}catch(Ti){console.error("Error cargando datos:",Ti);let r=Ti.message;Ti.isAuthError?r=`Error de autenticacin: ${Ti.message}\n\nSugerencias:\n- Verifica que tu API Key est configurada correctamente\n- Asegrate de que la API Key tenga los permisos necesarios\n- Verifica que la URL sea correcta\n- Revisa la documentacin de la API para ms detalles`:"protected-api"===i?r=`Error cargando API protegida: ${Ti.message}\n\nSugerencias:\n- Verifica que tu API Key est configurada\n- Asegrate de que la URL sea correcta\n- Verifica los permisos de tu API Key\n- Revisa la documentacin de la API`:"google-sheets"===i?r=`Error cargando Google Sheets: ${Ti.message}\n\nSugerencias:\n- Verifica que la URL sea correcta\n- Asegrate de que el archivo est publicado pblicamente\n- Verifica tu conexin a internet\n- Intenta usar un archivo CSV local como alternativa`:"csv-url"===i&&(r=`Error cargando archivo CSV: ${Ti.message}\n\nSugerencias:\n- Verifica que la URL sea correcta\n- Asegrate de que el archivo sea accesible\n- Verifica tu conexin a internet`);const o=new Error(r);o.originalError=Ti,o.sourceType=i,o.source=e,t(null,o)}}}class Kn{constructor(e={}){this.config={ttl:36e5,maxSize:10,version:"1.0",disabled:e.disableCache||!1},this.isLoading=!1,this.currentUrl=null}getCacheKey(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return`xdiagrams_cache_${Math.abs(t)}`}shouldCache(e){if(this.config.disabled)return!1;try{return new URL(e,window.location.href).origin!==window.location.origin&&(e.includes("api.")||e.includes(".json")||e.includes("/api/"))}catch{return!1}}get(e){if(!this.shouldCache(e))return null;try{const t=this.getCacheKey(e),n=localStorage.getItem(t);if(!n)return null;const i=JSON.parse(n);return i.expires&&Date.now()>i.expires||i.version!==this.config.version?(localStorage.removeItem(t),null):i.data}catch(Ti){return console.warn("Error reading cache:",Ti),null}}set(e,t){if(this.shouldCache(e))try{const n=this.getCacheKey(e),i={data:t,timestamp:Date.now(),expires:Date.now()+this.config.ttl,version:this.config.version,url:e};localStorage.setItem(n,JSON.stringify(i))}catch(Ti){console.warn("Error saving to cache:",Ti)}}clear(e){try{const t=this.getCacheKey(e);localStorage.removeItem(t)}catch(Ti){console.warn("Error clearing cache:",Ti)}}clearAll(){try{const e=Object.keys(localStorage);e.filter(e=>e.startsWith("xdiagrams_cache_")).forEach(e=>localStorage.removeItem(e))}catch(Ti){console.warn("Error clearing all cache:",Ti)}}startLoading(e){this.isLoading=!0,this.currentUrl="string"==typeof e?e:null}stopLoading(){this.isLoading=!1}getLoadingState(){return{isLoading:this.isLoading,currentUrl:this.currentUrl}}}class Gn{constructor(e={}){this.dataLoader=new Vn,this.cache=new Kn(e)}async loadData(e,t,n={}){this.cache.startLoading(e);try{const i=this.cache.get(e);if(i)return this.cache.stopLoading(),void t(i);await this.dataLoader.loadData(e,(n,i)=>{this.cache.stopLoading(),i?t(null,i):(this.cache.set(e,n),t(n))},n)}catch(Ti){this.cache.stopLoading(),t(null,Ti)}}clearCache(e){this.cache.clear(e)}getLoadingState(){return this.cache.getLoadingState()}get dataLoaderInstance(){return this.dataLoader}get cacheInstance(){return this.cache}}class Yn{constructor(e={}){this.config={defaultIcon:"detail",...e},this.validCustomIcons=["detail","list","grid","form","document","modal","report","profile","home","settings"],this.iconUnicodeMap={detail:"",list:"",grid:"",form:"",document:"",modal:"",report:"",profile:"",home:"",settings:""},this.iconAliases={icon:"detail",default:"detail"}}isValidCustomIcon(e){if(!e||"string"!=typeof e)return!1;const t=this.normalizeIconName(e);return this.validCustomIcons.includes(t)}getIconUnicode(e){if(!e||"string"!=typeof e)return this.iconUnicodeMap.detail;const t=this.normalizeIconName(e);return this.iconUnicodeMap[t]||this.iconUnicodeMap.detail}normalizeIconName(e){if(!e||"string"!=typeof e)return"";let t=e.toLowerCase().trim();return this.iconAliases[t]?this.iconAliases[t]:(t=t.replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,""),t)}isExternalImageUrl(e){if(!e||"string"!=typeof e)return!1;try{const t=new URL(e),n=[".jpg",".jpeg",".png",".gif",".svg",".webp",".bmp"].some(e=>t.pathname.toLowerCase().endsWith(e)),i=["image","img","photo","pic","avatar"].some(e=>t.pathname.toLowerCase().includes(e));return n||i}catch(t){return[".jpg",".jpeg",".png",".gif",".svg",".webp",".bmp"].some(t=>e.toLowerCase().endsWith(t))}}isCustomIconsLoaded(){const e=document.createElement("span");e.style.cssText="position: absolute; visibility: hidden; font-size: 24px; font-family: xdiagrams-icons;",e.textContent="",document.body.appendChild(e);const t=e.offsetWidth+e.offsetHeight;e.style.fontFamily="Arial, sans-serif";const n=e.offsetWidth+e.offsetHeight;return e.remove(),t!==n}getDefaultIcon(){return this.config.defaultIcon||"detail"}}class Jn{constructor(e){this.iconManager=e}resolveThumbnail(e){const t=e.img||e.data&&e.data.img,n=e.layout||e.data&&e.data.layout;if(t){const e=this.resolveFromValue(t);if(e)return e}if(!t&&n){const e=this.resolveFromValue(n);if(e)return e}return{type:"custom-icon",value:this.iconManager.getDefaultIcon()}}resolveFromValue(e){if(this.iconManager.isValidCustomIcon(e)){return{type:"custom-icon",value:this.iconManager.normalizeIconName(e)}}return this.iconManager.isExternalImageUrl(e)?{type:"external-image",value:e}:null}getThumbnailType(e){return this.iconManager.isValidCustomIcon(e)?"custom-icon":this.iconManager.isExternalImageUrl(e)?"external-image":"unknown"}hasValidThumbnail(e){const t=e.img||e.data&&e.data.img,n=e.layout||e.data&&e.data.layout;return t&&"unknown"!==this.getThumbnailType(t)||n&&"unknown"!==this.getThumbnailType(n)}}class Qn{constructor(e){this.iconManager=e}createThumbnailElement(e,t,n,i,r,o,a){return"custom-icon"===a.type?this.createCustomIconElement(t,n,i,a.value):"external-image"===a.type?this.createExternalImageElement(t,n,i,r,o,a.value):this.createDefaultIconElement(t,n,i)}createCustomIconElement(e,t,n,i){const r=this.iconManager.getIconUnicode(i);return e.append("text").attr("x",t).attr("y",n).attr("font-family","xdiagrams-icons").attr("font-size","82px").attr("text-anchor","middle").attr("dominant-baseline","middle").attr("class","embedded-thumbnail").text(r).style("opacity",0)}createExternalImageElement(e,t,n,i,r,o){return e.append("image").attr("x",t-i/2).attr("y",n-r/2-10).attr("width",i).attr("height",r).attr("href",o).style("opacity",0).on("error",function(){return console.error("Failed to load external image:",o),d3.select(this).remove(),this.createDefaultIconElement(e,t,n)}.bind(this))}createDefaultIconElement(e,t,n){const i=this.iconManager.getIconUnicode(this.iconManager.getDefaultIcon());return e.append("text").attr("x",t).attr("y",n).attr("font-family","xdiagrams-icons").attr("font-size","82px").attr("text-anchor","middle").attr("dominant-baseline","middle").attr("class","embedded-thumbnail").text(i).style("opacity",0)}applyStyles(e,t={}){Object.entries(t).forEach(([t,n])=>{e.style(t,n)})}updatePosition(e,t,n){e.attr("x",t).attr("y",n)}updateSize(e,t,n){e.attr("width",t).attr("height",n)}}class ei{constructor(e){this.iconManager=e,this.animationDelay=100,this.fadeInDuration=300}showIconsWithFadeIn(){this.iconManager.isCustomIconsLoaded()?this.showAllIcons():setTimeout(()=>this.showIconsWithFadeIn(),this.animationDelay)}showAllIcons(){this.showCustomIcons(),this.showExternalImages()}showCustomIcons(){d3.selectAll('text[font-family="xdiagrams-icons"]').transition().duration(this.fadeInDuration).style("opacity",1)}showExternalImages(){d3.selectAll("image[href]").transition().duration(this.fadeInDuration).style("opacity",1)}hideAllIcons(){d3.selectAll('text[font-family="xdiagrams-icons"]').style("opacity",0),d3.selectAll("image[href]").style("opacity",0)}showIconWithFadeIn(e,t=this.fadeInDuration){e.transition().duration(t).style("opacity",1)}hideIconWithFadeOut(e,t=this.fadeInDuration){e.transition().duration(t).style("opacity",0)}setAnimationDuration(e){this.fadeInDuration=e}setAnimationDelay(e){this.animationDelay=e}areIconsReady(){return this.iconManager.isCustomIconsLoaded()}}class ti{constructor(e={}){this.iconManager=new Yn(e),this.resolver=new Jn(this.iconManager),this.renderer=new Qn(this.iconManager),this.animator=new ei(this.iconManager)}resolveThumbnail(e){return this.resolver.resolveThumbnail(e)}createThumbnailElement(e,t,n,i,r,o){const a=this.resolver.resolveThumbnail(e);return this.renderer.createThumbnailElement(e,t,n,i,r,o,a)}showIconsWithFadeIn(){return this.animator.showIconsWithFadeIn()}get iconManagerInstance(){return this.iconManager}get resolverInstance(){return this.resolver}get rendererInstance(){return this.renderer}get animatorInstance(){return this.animator}}class ni{constructor(e={}){this.config={maxWidth:80,maxLines:2,fontSize:8,nodeNameFontSize:9,lineHeight:1.2,fontFamily:"Arial, sans-serif",textAnchor:"middle",dominantBaseline:"middle",ellipsis:"...",fontWeight:"bold",...e}}renderText(e,t,n={}){const i={...this.config,...n};if(!t||""===t.trim())return e.append("text").attr("class","empty-text").style("display","none");const r=e.append("g").attr("class","text-group").append("text").attr("class","smart-text").style("font-family",i.fontFamily).style("font-size",i.fontSize+"px").style("font-weight",i.fontWeight||"normal").style("text-anchor",i.textAnchor).style("dominant-baseline",i.dominantBaseline);return this.wrapText(r,t,i),r}wrapText(e,t,n){const i=t.split(/\s+/),r=[];let o="";for(let a=0;a<i.length;a++){const t=o?o+" "+i[a]:i[a],s=e.text(t).node();let l=0;if(s&&"function"==typeof s.getComputedTextLength)l=s.getComputedTextLength();else{const e=.6*n.fontSize;l=t.length*e}l>n.maxWidth&&""!==o?(r.push(o),o=i[a]):o=t}o&&r.push(o),r.length>n.maxLines&&(r.splice(n.maxLines),r[n.maxLines-1]&&(r[n.maxLines-1]=this.truncateText(r[n.maxLines-1],n.maxWidth,n.ellipsis))),e.text(""),r.forEach((t,i)=>{e.append("tspan").attr("x",0).attr("dy",0===i?"0":n.lineHeight+"em").text(t)})}truncateText(e,t,n){const i=document.createElementNS("http://www.w3.org/2000/svg","text");i.style.fontFamily=this.config.fontFamily,i.style.fontSize=this.config.fontSize+"px",i.style.fontWeight=this.config.fontWeight||"normal";let r=e,o=n;for(;r.length>0;){i.textContent=r+o;if(i.getComputedTextLength()<=t)break;r=r.slice(0,-1)}return r+o}renderNodeText(e,t,n,i,r={}){const o=this.renderText(e,t,r);return o.attr("x",n).attr("y",i),o}renderNodeTextCentered(e,t,n,i,r={}){const o={...this.config,...r};if(!t||""===t.trim())return e.append("text").attr("class","empty-text").attr("x",n).attr("y",i).style("display","none");const a=t.split(/\s+/),s=[];let l="";for(let d=0;d<a.length;d++){const e=l?l+" "+a[d]:a[d],t=document.createElementNS("http://www.w3.org/2000/svg","text");t.style.fontFamily=o.fontFamily,t.style.fontSize=o.fontSize+"px",t.style.fontWeight=o.fontWeight||"normal",t.textContent=e;let n=0;if(t.getComputedTextLength)n=t.getComputedTextLength();else{const t=.6*o.fontSize;n=e.length*t}n>o.maxWidth&&""!==l?(s.push(l),l=a[d]):l=e}l&&s.push(l),s.length>o.maxLines&&s.splice(o.maxLines);let c=i,u=o.dominantBaseline;1===s.length?(c=i+8,u="hanging"):(c=i-5,u="middle");const h=e.append("g").attr("class","text-group").attr("transform",`translate(${n}, ${c})`).append("text").attr("class","smart-text").style("font-family",o.fontFamily).style("font-size",o.fontSize+"px").style("font-weight",o.fontWeight||"normal").style("text-anchor",o.textAnchor).style("dominant-baseline",u);return this.wrapText(h,t,o),h}updateConfig(e){this.config={...this.config,...e}}}class ii{constructor(e){this.navigation=e,this.core=e.core,this.zoomControls=null,this.zoomInput=null}create(){document.getElementById("zoom-controls")?.remove();const e=document.createElement("div");e.id="zoom-controls",e.className="zoom-controls";const t=document.createElement("button");t.className="zoom-btn",t.innerHTML="",t.title="Reducir zoom",t.onclick=()=>this.adjustZoom(-.08);const n=document.createElement("div");n.className="zoom-input-container";const i=document.createElement("input");i.className="zoom-input",i.type="text",i.placeholder="100",i.title="Nivel de zoom en porcentaje (6-150%)",i.onchange=e=>this.setZoomFromInput(e.target.value),i.onkeydown=e=>{"Enter"===e.key&&(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),this.setZoomFromInput(e.target.value),e.target.blur())};const r=document.createElement("span");r.className="zoom-percent-inline",r.textContent="%";const o=document.createElement("button");o.className="zoom-btn",o.innerHTML="+",o.title="Aumentar zoom",o.onclick=()=>this.adjustZoom(.08),n.appendChild(i),n.appendChild(r),e.appendChild(t),e.appendChild(n),e.appendChild(o),document.body.appendChild(e),this.zoomControls=e,this.zoomInput=i}updateZoomInput(e){this.zoomInput&&(this.zoomInput.value=Math.round(100*e))}resetZoom(e){const t=d3.select("#diagram");this.navigation.clusterNavInstance.deselectActiveCluster();try{d3.selectAll(".node rect").classed("node-selected",!1).style("stroke",null).style("stroke-width",null).style("fill",null)}catch(m){}const n=this.core.navigation?.zoomManagerInstance?.getInitialTransform();if(n)return this.core.uiManager&&"function"==typeof this.core.uiManager.closeInfoPanel&&this.core.uiManager.closeInfoPanel(),this.core.navigation&&this.core.navigation.zoomManagerInstance?this.core.navigation.zoomManagerInstance.zoomTo(n,1e3):t.transition().duration(1e3).ease(d3.easeCubicOut).call(d3.zoom().transform,n),void document.getElementById("zoom-status")?.style.setProperty("display","none");const i=t.node().getBoundingClientRect(),{width:r,height:o}=i,a=this.core.calculateDiagramBounds();this.core.uiManager&&"function"==typeof this.core.uiManager.closeInfoPanel&&this.core.uiManager.closeInfoPanel();const s=a.width||8e3,l=a.height||8e3,c=r/s,u=o/l,h=.95*Math.min(c,u),d=(r-s*h)/2,f=(o-l*h)/2,g=d3.zoomIdentity.translate(d,f).scale(h);this.core.navigation&&this.core.navigation.zoomManagerInstance?this.core.navigation.zoomManagerInstance.zoomTo(g,this.core.config.transitionDuration.reset):t.transition().duration(this.core.config.transitionDuration.reset).ease(d3.easeCubicOut).call(d3.zoom().transform,g),document.getElementById("zoom-status")?.style.setProperty("display","none")}adjustZoom(e){if(!this.core.navigation||!this.core.navigation.zoomManagerInstance)return;const t=d3.select("#diagram").node(),n=t.getBoundingClientRect(),{width:i,height:r}=n,o=d3.zoomTransform(t),a=this.core.navigation?.zoomManagerInstance?.getInitialTransform();if(o.k<.05&&e>0&&a){const e=a.k,t=i/2,n=r/2,s=e/o.k,l=t-(t-o.x)*s,c=n-(n-o.y)*s,u=d3.zoomIdentity.translate(l,c).scale(e);return void this.core.navigation.zoomManagerInstance.zoomTo(u,300)}let s;s=e>0?o.k>=1?.75:o.k>=.5?.5:o.k>=.25?.25:.1:o.k>=1?.5:o.k>=.5?.25:o.k>=.25?.15:.1;const l=e>0?s:-s,c=Math.max(.05,Math.min(2,o.k+l)),u=i/2,h=r/2,d=c/o.k,f=u-(u-o.x)*d,g=h-(h-o.y)*d,m=d3.zoomIdentity.translate(f,g).scale(c);this.core.navigation.zoomManagerInstance.zoomTo(m,300)}setZoomFromInput(e){if(!this.core.navigation||!this.core.navigation.zoomManagerInstance)return;const t=parseFloat(e);if(isNaN(t)||t<6||t>200){const e=d3.select("#diagram"),t=d3.zoomTransform(e.node());return void(this.zoomInput.value=Math.round(100*t.k))}const n=t/100,i=d3.select("#diagram").node(),r=i.getBoundingClientRect(),{width:o,height:a}=r,s=d3.zoomTransform(i),l=o/2,c=a/2,u=n/s.k,h=l-(l-s.x)*u,d=c-(c-s.y)*u,f=d3.zoomIdentity.translate(h,d).scale(n);this.core.navigation.zoomManagerInstance.zoomTo(f,300)}destroy(){this.zoomControls&&(this.zoomControls.remove(),this.zoomControls=null,this.zoomInput=null)}}class ri{constructor(){this.zoom=null,this.currentTransform=null,this.initialTransform=null,this.zoomChangeListeners=[]}setupZoom(e,t){return this.zoom=d3.zoom().scaleExtent([.05,2]).wheelDelta(e=>.002*-e.deltaY).on("zoom",n=>{const i="mousemove"===n.sourceEvent?.type?d3.zoomIdentity.translate(n.transform.x,n.transform.y).scale(d3.zoomTransform(e.node()).k):n.transform;this.currentTransform=i;const r=e.select("g");r.empty()||r.attr("transform",i),this.applyZoomBasedClusterClasses(i.k),this.notifyZoomChangeListeners(i.k),this.updateInfoPanel(i),t&&t.zoomControlsInstance&&t.zoomControlsInstance.updateZoomInput(i.k)}),e.call(this.zoom).on("dblclick.zoom",null),this.zoom}getCurrentZoom(){const e=d3.select("#diagram");if(e.empty())return 1;const t=e.node();return d3.zoomTransform(t).k}getCurrentTransform(){return this.currentTransform}zoomTo(e,t=750){if(!this.zoom)return;const n=d3.select("#diagram");n.empty()||n.transition().duration(t).ease(d3.easeCubicOut).call(this.zoom.transform,e)}zoomToImmediate(e){if(!this.zoom)return;const t=d3.select("#diagram");t.empty()||t.call(this.zoom.transform,e)}zoomToScale(e){if(!this.currentTransform)return;const t=d3.zoomIdentity.translate(this.currentTransform.x,this.currentTransform.y).scale(e);this.zoomTo(t)}resetZoom(){if(!this.zoom)return;const e=d3.select("#diagram");e.empty()||e.transition().duration(750).call(this.zoom.transform,d3.zoomIdentity)}updateInfoPanel(e){this.navigation&&this.navigation.core&&this.navigation.core.uiManager&&this.navigation.core.uiManager.updateInfoPanel(e)}destroyZoom(){if(this.zoom){const e=d3.select("#diagram");e.empty()||e.on(".zoom",null),this.zoom=null,this.currentTransform=null}}getZoomInstance(){return this.zoom}setInitialTransform(e){this.initialTransform=e}getInitialTransform(){return this.initialTransform}applyZoomBasedClusterClasses(e){const t=d3.selectAll(".cluster-bg");t.empty()||(t.classed("zoom-out",!1).classed("zoom-in",!1),e<=.1?(t.classed("zoom-out",!0),this.navigation&&this.navigation.core&&this.navigation.core.config&&!1!==this.navigation.core.config.enableNavigationLogs&&console.log("[ZoomClasses] Applied zoom-out class (zoom <= 10%):",e)):(t.classed("zoom-in",!0),this.navigation&&this.navigation.core&&this.navigation.core.config&&!1!==this.navigation.core.config.enableNavigationLogs&&console.log("[ZoomClasses] Applied zoom-in class (zoom > 10%):",e)))}onZoomChange(e){this.zoomChangeListeners.push(e)}notifyZoomChangeListeners(e){this.zoomChangeListeners.forEach(t=>{try{t(e)}catch(Ti){console.error("[ZoomManager] Error en listener de zoom:",Ti)}})}}class oi{constructor(e){this.navigation=e,this.core=e.core,this.keyboardHandler=null}setup(e){this.keyboardHandler=t=>{if(!t.__xdiHandled){if(t.__xdiHandled=!0,(t.metaKey||t.ctrlKey)&&("="===t.key||"+"===t.key))return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.navigation.zoomControlsInstance.adjustZoom(.01),!1;if((t.metaKey||t.ctrlKey)&&"-"===t.key)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.navigation.zoomControlsInstance.adjustZoom(-.01),!1;if((t.metaKey||t.ctrlKey)&&"0"===t.key)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.navigation.zoomControlsInstance.resetZoom(e),!1;if("Tab"===t.key){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.navigation.escapeLevel=0;d3.select(".node-selected").empty()?this.navigation.clusterNavInstance.handleTabNavigation():this.navigation.nodeNavInstance.handleTabNavigation()}else if("Enter"===t.key){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.navigation.escapeLevel=0;if(!d3.select(".node-selected").empty())return;const e=d3.selectAll(".cluster-bg");if(e.empty())return;const n=d3.select(".cluster-bg:focus");if(-1===(n.empty()?-1:Array.from(e.nodes()).indexOf(n.node()))){const t=e.nodes()[0];if(t){d3.select(t).node().focus();const e=d3.select(t.parentNode);this.navigation.clusterNavInstance.highlightCluster(e),this.navigation.clusterNavInstance.zoomToCluster(e,this.core.globalContainer,!0)}return}this.navigation.nodeNavInstance.selectFirstNodeInCluster(n)}else if("Escape"===t.key){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();d3.select(".node-selected").empty()?(this.navigation.escapeLevel,this.navigation.zoomControlsInstance.resetZoom(e),this.navigation.escapeLevel=0):(this.navigation.nodeNavInstance.exitNodeNavigationMode(),this.navigation.escapeLevel=1)}else if("R"===t.key&&t.ctrlKey&&t.shiftKey)t.preventDefault(),this.core.clearCacheAndReload();else if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(t.key)){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.navigation.escapeLevel=0;d3.select(".node-selected").empty()?this.navigation.clusterNavInstance.handleArrowNavigation(t.key):this.navigation.nodeNavInstance.handleNodeArrowNavigation(t.key)}}},document.addEventListener("keydown",this.keyboardHandler,{capture:!0,passive:!1}),navigator.userAgent.includes("Firefox")&&document.addEventListener("keydown",this.keyboardHandler,{passive:!1})}initialize(){d3.selectAll(".cluster-bg");const e=d3.select(".cluster-bg").node();e&&e.focus()}destroy(){this.keyboardHandler&&(document.removeEventListener("keydown",this.keyboardHandler,{capture:!0}),navigator.userAgent.includes("Firefox")&&document.removeEventListener("keydown",this.keyboardHandler),this.keyboardHandler=null)}}class ai{constructor(e){this.navigation=e,this.core=e.core,window.addEventListener("resize",()=>{this.updateOverlayPosition()})}zoomToCluster(e,t,n=!1,i=!0){try{this.core.config&&!1!==this.core.config.enableNavigationLogs&&console.log(" [ClusterNav] zoomToCluster llamado:",{isTabNavigation:n,shouldDeselectNode:i,clusterTitle:e.select(".cluster-title").text()});if(!d3.select(".node-selected").empty()&&i&&(this.core.uiManager.closeInfoPanel(),d3.selectAll(".node-selected").classed("node-selected",!1).style("stroke",null).style("stroke-width",null).style("fill",null),this.navigation.escapeLevel=0),!e||e.empty())return;const t=d3.select("#diagram");if(t.empty())return;const r=t.node().getBoundingClientRect(),{width:o,height:a}=r;if(o<=0||a<=0)return;const s=e.select(".cluster-bg");if(s.empty())return;const l=parseFloat(s.attr("width")),c=parseFloat(s.attr("height"));if(isNaN(l)||isNaN(c)||l<=0||c<=0)return;const u=e.select(".cluster-title").attr("data-cluster-name")||e.select(".cluster-title").text(),h=this.core.clusterPositions.get(u);let d=0,f=0;if(h)d=h.x,f=h.y;else{const t=e.attr("transform");if(t){const e=t.match(/translate\(([^,]+),\s*([^)]+)\)/);e&&(d=parseFloat(e[1]),f=parseFloat(e[2]))}}const g=d+l/2,m=f+c/2,p=Math.min(o,a),y=p<768?30:p<1024?50:80,v=(o-2*y)/l,w=(a-2*y)/c,x=p<768?1.8:p<1024?2:2.2,b=Math.min(v,w,x);if(isNaN(b)||b<=0)return;const _=o/2-g*b,C=a/2-m*b,I=d3.zoomIdentity.translate(_,C).scale(b),E=n?this.core.config.transitionDuration.tab:this.core.config.transitionDuration.click;this.core.navigation&&this.core.navigation.zoomManagerInstance?this.core.navigation.zoomManagerInstance.zoomTo(I,E):t.transition().duration(E).ease(d3.easeCubicOut).call(d3.zoom().transform,I),this.core.uiManager&&this.core.uiManager.updateInfoPanel({k:b,x:_,y:C});const T=document.getElementById("zoom-status");T&&(T.style.display="block",setTimeout(()=>T.style.display="none",2e3));e.select(".cluster-bg").empty()||(this.clearClusterSelection(),this.removeNodeBlockerOverlay(),this.applySelectedClusterStyle(e),this.core.config&&!1!==this.core.config.enableNavigationLogs&&console.log(" [ClusterNav] zoomToCluster completado para:",e.select(".cluster-title").text()))}catch(Ti){}}handleTabNavigation(){const e=d3.select(".cluster-bg:focus"),t=d3.selectAll(".cluster-bg");if(t.empty())return;const n=e.empty()?-1:Array.from(t.nodes()).indexOf(e.node()),i=event.shiftKey?n<=0?t.size()-1:n-1:n>=t.size()-1?0:n+1,r=t.nodes()[i];if(!r)return;d3.select(r).node().focus();const o=d3.select(r.parentNode);o.empty()||this.zoomToCluster(o,this.core.globalContainer,!0)}handleArrowNavigation(e){const t=d3.selectAll(".cluster-bg");if(t.empty())return;const n=d3.select(".cluster-bg:focus"),i=n.empty()?-1:Array.from(t.nodes()).indexOf(n.node());if(-1===i){const e=t.nodes()[0];if(e){d3.select(e).node().focus();const t=d3.select(e.parentNode);this.zoomToCluster(t,this.core.globalContainer,!0)}return}let r;switch(e){case"ArrowUp":r=this.getClusterInPreviousRow(i,t);break;case"ArrowDown":r=this.getClusterInNextRow(i,t);break;case"ArrowLeft":r=this.getPreviousClusterInRow(i,t);break;case"ArrowRight":r=this.getNextClusterInRow(i,t);break;default:return}const o=t.nodes()[r];o&&(d3.select(o).node().focus(),this.zoomToCluster(d3.select(o.parentNode),this.core.globalContainer,!0))}getPreviousClusterInRow(e,t){return this._findClusterInRow(e,t,"previous")}getNextClusterInRow(e,t){return this._findClusterInRow(e,t,"next")}_findClusterInRow(e,t,n){const i=t.nodes()[e].getBoundingClientRect(),r=i.top,o=i.left;let a=e,s=1/0;return t.each(function(t,i){if(i===e)return;const l=this.getBoundingClientRect();if(Math.abs(l.top-r)<50){const e="previous"===n&&l.left<o,t="next"===n&&l.left>o;if(e||t){const e=Math.abs(l.left-o);e<s&&(s=e,a=i)}}}),a===e&&("previous"===n?(a=this.getLastClusterInPreviousRow(e,t),a===e&&(a=t.size()-1)):(a=this.getFirstClusterInNextRow(e,t),a===e&&(a=0))),a}getClusterInPreviousRow(e,t){return this._findClusterInAdjacentRow(e,t,"previous")}getClusterInNextRow(e,t){return this._findClusterInAdjacentRow(e,t,"next")}_findClusterInAdjacentRow(e,t,n){const i=t.nodes()[e].getBoundingClientRect(),r=i.left+i.width/2,o=i.top;let a=e,s=1/0,l=1/0;return t.each(function(t,i){if(i===e)return;const c=this.getBoundingClientRect(),u=c.left+c.width/2,h=c.top,d="previous"===n?o-h:h-o;if(d>50){const e=Math.abs(u-r);d<s?(s=d,a=i,l=e):Math.abs(d-s)<10&&e<l&&(a=i,l=e)}}),a===e&&(a="previous"===n?t.size()-1:0),a}getLastClusterInPreviousRow(e,t){return this._findClusterAtRowExtreme(e,t,"previous","last")}getFirstClusterInNextRow(e,t){return this._findClusterAtRowExtreme(e,t,"next","first")}_findClusterAtRowExtreme(e,t,n,i){const r=t.nodes()[e].getBoundingClientRect().top;let o=e,a=1/0,s="first"===i?1/0:-1/0;return t.each(function(t,l){if(l===e)return;const c=this.getBoundingClientRect(),u="previous"===n?r-c.top:c.top-r;if(u>50)if(u<a)a=u,o=l,s=c.left;else if(Math.abs(u-a)<10){("first"===i?c.left<s:c.left>s)&&(o=l,s=c.left)}}),o}highlightCluster(e){console.warn("highlightCluster is deprecated, use zoomToCluster instead")}deselectActiveCluster(){d3.selectAll(".cluster-bg").each(function(){this.blur()}),d3.selectAll(".cluster-bg").classed("cluster-focused",!1),d3.selectAll(".cluster-bg").classed("cluster-hover-simulated",!1),d3.selectAll(".cluster-bg").attr("data-selected","false"),d3.selectAll(".cluster-bg").style("outline",null),this.createNodeBlockerOverlay()}clearClusterSelection(){d3.selectAll(".cluster-bg").classed("cluster-focused",!1),d3.selectAll(".cluster-bg").attr("data-selected","false"),d3.selectAll(".cluster-bg").style("outline",null),d3.selectAll(".cluster-bg").classed("cluster-hover-simulated",!1),d3.selectAll(".cluster-bg").each(function(){this.blur()}),this.recreateNodeBlockerOverlay()}recreateNodeBlockerOverlay(){this.removeNodeBlockerOverlay(),this.createNodeBlockerOverlay()}applyClusterStyle(e,t,n){console.warn("applyClusterStyle is deprecated, styles are now handled by CSS")}applySelectedClusterStyle(e){const t=e.select(".cluster-bg");t.empty()||(t.classed("cluster-hover-simulated",!1),t.classed("cluster-focused",!0),t.attr("data-selected","true"),t.style("outline","none"),t.node().focus(),this.core.config&&!1!==this.core.config.enableNavigationLogs&&console.log(" [ClusterNav] Cluster seleccionado:",e.select(".cluster-title").text()))}deselectClusterOnOutsideClick(){d3.select('.cluster-bg[data-selected="true"]').empty()?this.createNodeBlockerOverlay():this.deselectActiveCluster()}createNodeBlockerOverlay(){d3.selectAll(".cluster-node-blocker").remove();d3.selectAll(".cluster").each((e,t,n)=>{const i=d3.select(n[t]),r=i.select(".cluster-bg");if(!r.empty()){const e=parseFloat(r.attr("width")),n=parseFloat(r.attr("height"));i.append("rect").attr("class","cluster-node-blocker").attr("data-cluster-index",t).attr("x",0).attr("y",0).attr("width",e).attr("height",n).attr("fill","transparent").attr("stroke","none").attr("pointer-events","all").style("cursor","pointer").on("mouseenter",()=>{"true"!==r.attr("data-selected")&&r.classed("cluster-hover-simulated",!0)}).on("mouseleave",()=>{"true"!==r.attr("data-selected")&&r.classed("cluster-hover-simulated",!1)}).on("click",e=>{e.stopPropagation(),e.preventDefault(),this.zoomToCluster(i,this.core.globalContainer,!1,!0),this.removeNodeBlockerOverlay()})}})}removeNodeBlockerOverlay(){d3.selectAll(".cluster-node-blocker").remove()}updateOverlayPosition(){d3.selectAll(".cluster-node-blocker").empty()||this.createNodeBlockerOverlay()}}class si{constructor(e){this.navigation=e,this.core=e.core,this.lastNodeDistance=0,this.isCircularNavigation=!1}handleTabNavigation(){const e=d3.select(".node-selected");if(e.empty())return;const t=d3.select(e.node().closest(".node"));if(t.empty())return;const n=d3.select(t.node().closest(".cluster"));if(n.empty())return;const i=n.selectAll(".node");if(i.empty())return;const r=Array.from(i.nodes()).indexOf(t.node()),o=event.shiftKey?r<=0?i.size()-1:r-1:r>=i.size()-1?0:r+1,a=i.nodes()[o];a&&this.selectNode(d3.select(a),!1)}handleNodeArrowNavigation(e){const t=d3.select(".node-selected");if(t.empty())return;let n=d3.select(t.node().closest(".node")),i=!1;if(n.empty())n=d3.select(t.node().closest(".cluster-bg")),n.empty()||(i=!0);else{const e=n.node().__data__;!e||null!==e.parent&&void 0!==e.parent&&""!==e.parent||(i=!0)}if(n.empty())return;const r=d3.select(n.node().closest(".cluster"));if(r.empty())return;const o=i?r.selectAll(".node, .cluster-bg"):r.selectAll(".node");if(o.empty())return;const a=Array.from(o.nodes()).indexOf(n.node());let s;switch(e){case"ArrowUp":s=this.getPreviousNodeInColumn(a,o,i);break;case"ArrowDown":s=this.getNextNodeInColumn(a,o,i);break;case"ArrowLeft":s=this.getPreviousNodeInRow(a,o);break;case"ArrowRight":s=this.getNextNodeInRow(a,o);break;default:return}const l=o.nodes()[s];l&&this.selectNode(d3.select(l),!1)}selectNode(e,t=!1){let n=0;if(!t){const t=d3.select(".node-selected");if(!t.empty()){const i=d3.select(t.node().closest(".node"));if(!i.empty()){const t=i.node().getBoundingClientRect(),r=e.node().getBoundingClientRect(),o=t.left+t.width/2,a=t.top+t.height/2,s=r.left+r.width/2-o,l=r.top+r.height/2-a;n=Math.sqrt(s*s+l*l)}}}d3.selectAll(".node-selected").classed("node-selected",!1),e.classed("node-selected",!0);e.select("rect").style("stroke-linejoin","round"),this.ensureNodeVisibleWithTransition(e);const i=e.node(),r=i.__data__;if(r){const e=r.data?.data||r.data||{};this.core.uiManager.openInfoPanel(e,this.core.config)}else{const e=i.querySelector(".node-id-label")?.textContent;if(e){const t={id:e};this.core.uiManager.openInfoPanel(t,this.core.config)}}this.lastNodeDistance=n,this.isCircularNavigation=n>500}exitNodeNavigationMode(e=!1){const t=d3.select(".node-selected");let n=null;if(!t.empty()){const e=t.node().closest(".cluster");e&&(n=d3.select(e))}if(this.core.uiManager.isInfoPanelClosing||this.core.uiManager.closeInfoPanel(),d3.selectAll(".node-selected").classed("node-selected",!1),n&&!n.empty())try{this.core.navigation.clusterNavInstance.zoomToCluster(n,this.core.globalContainer,!1,!0)}catch(Ti){console.error("Error calling zoomToCluster from exitNodeNavigationMode:",Ti)}}selectFirstNodeInCluster(e){const t=d3.select(e.node().closest(".cluster"));if(t.empty())return;const n=t.selectAll(".node");if(n.empty())return;const i=n.nodes()[0];if(i){this.selectNode(d3.select(i),!1);const e=i.__data__;e&&this.core.diagramRenderer.zoomToNode(d3.select(i),e,!0)}}ensureNodeVisible(e){const t=d3.select("#diagram");if(t.empty())return;const n=t.node(),i=n.getBoundingClientRect(),r=e.node().getBoundingClientRect(),o=d3.zoomTransform(n),a=r.left+r.width/2,s=r.top+r.height/2,l=(a-o.x)/o.k,c=(s-o.y)/o.k,u=i.width,h=i.height,d=document.getElementById("side-panel");let f=0;if(d&&"none"!==d.style.display){f=d.getBoundingClientRect().width}const g=u-f,m=.2*g,p=.2*h,y=-o.x/o.k,v=y+g/o.k,w=-o.y/o.k,x=w+h/o.k;let b=o.x,_=o.y,C=!1;if(l<y+m?(b=-(l-m)*o.k,C=!0):l>v-m&&(b=-(l+m-g/o.k)*o.k,C=!0),c<w+p?(_=-(c-p)*o.k,C=!0):c>x-p&&(_=-(c+p-h/o.k)*o.k,C=!0),C){const e=d3.zoomIdentity.translate(b,_).scale(o.k);this.core.navigation&&this.core.navigation.zoomManagerInstance?this.core.navigation.zoomManagerInstance.zoomTo(e,300):t.transition().duration(300).ease(d3.easeCubicOut).call(d3.zoom().transform,e)}}ensureNodeVisibleWithTransition(e){const t=d3.select("#diagram");if(t.empty())return;const n=t.node(),i=n.getBoundingClientRect(),r=e.node().getBoundingClientRect(),o=d3.zoomTransform(n),a=r.left+r.width/2,s=r.top+r.height/2,l=(a-o.x)/o.k,c=(s-o.y)/o.k,u=i.width,h=i.height,d=document.getElementById("side-panel");let f=0;if(d&&"none"!==d.style.display){f=d.getBoundingClientRect().width}const g=u-f,m=.2*g,p=.2*h,y=-o.x/o.k,v=y+g/o.k,w=-o.y/o.k,x=w+h/o.k;let b=o.x,_=o.y,C=!1;if(l<y+m?(b=-(l-m)*o.k,C=!0):l>v-m&&(b=-(l+m-g/o.k)*o.k,C=!0),c<w+p?(_=-(c-p)*o.k,C=!0):c>x-p&&(_=-(c+p-h/o.k)*o.k,C=!0),C){const e=Math.abs(b-o.x),n=Math.abs(_-o.y),i=Math.sqrt(e*e+n*n);let r,a;this.isCircularNavigation?(r=800,a=2500):(r=300,a=1500);const s=r+(a-r)*Math.min(i/1e3,1),l=d3.zoomIdentity.translate(b,_).scale(o.k);this.core.navigation&&this.core.navigation.zoomManagerInstance?this.core.navigation.zoomManagerInstance.zoomTo(l,s):t.transition().duration(s).ease(d3.easeCubicOut).call(d3.zoom().transform,l)}}getPreviousNodeInRow(e,t){return this._findNodeInRow(e,t,"previous")}getNextNodeInRow(e,t){return this._findNodeInRow(e,t,"next")}getPreviousNodeInColumn(e,t,n=!1){return this._findNodeInColumn(e,t,"previous",n)}getNextNodeInColumn(e,t,n=!1){return this._findNodeInColumn(e,t,"next",n)}_findNodeInRow(e,t,n){const i=t.nodes(),r=i[e];if(!r)return e;const o=r.getBoundingClientRect(),a=o.top+o.height/2;let s=e,l=1/0;for(let c=0;c<i.length;c++){if(c===e)continue;const t=i[c].getBoundingClientRect(),r=t.top+t.height/2;if(Math.abs(r-a)<=20){const e=t.left-o.left;"next"===n&&e>0&&e<l?(s=c,l=e):"previous"===n&&e<0&&Math.abs(e)<l&&(s=c,l=Math.abs(e))}}if(s===e){const t=[];for(let n=0;n<i.length;n++){if(n===e)continue;const r=i[n].getBoundingClientRect(),s=r.top+r.height/2;Math.abs(s-a)<=20&&t.push({index:n,x:r.left,distance:r.left-o.left})}t.length>0&&(t.sort((e,t)=>e.x-t.x),s="next"===n?t[0].index:t[t.length-1].index)}return s}_findNodeInColumn(e,t,n,i=!1){const r=t.nodes(),o=r[e];if(!o)return e;const a=o.getBoundingClientRect(),s=a.left+a.width/2,l=a.top+a.height/2,c=[];for(let p=0;p<r.length;p++){if(p===e)continue;const t=r[p].getBoundingClientRect(),o=t.left+t.width/2,a=t.top+t.height/2,u=a-l;if("next"===n&&u>0||"previous"===n&&u<0){const e=Math.abs(o-s),t=!i||!r[p].classList.contains("cluster-bg");e<=50&&t&&c.push({index:p,verticalDistance:Math.abs(u),horizontalDistance:e,node:r[p],nodeY:a})}}if(0===c.length)for(let p=0;p<r.length;p++){if(p===e)continue;const t=r[p].getBoundingClientRect(),o=t.top+t.height/2,a=o-l;if("next"===n&&a>0||"previous"===n&&a<0){(!i||!r[p].classList.contains("cluster-bg"))&&c.push({index:p,verticalDistance:Math.abs(a),horizontalDistance:Math.abs(t.left+t.width/2-s),node:r[p],nodeY:o})}}if(0===c.length){if(i)return e;{const t=[];for(let n=0;n<r.length;n++)if(n!==e&&!r[n].classList.contains("cluster-bg")){const e=r[n].getBoundingClientRect(),i=e.top+e.height/2,o=e.left+e.width/2;t.push({index:n,y:i,x:o,verticalDistance:i-l})}if(t.length>0){let e;return t.sort((e,t)=>e.y-t.y),e="next"===n?t[0].index:t[t.length-1].index,e}return e}}const u=new Map;for(const p of c){let e=!1;for(const[t,n]of u)if(Math.abs(p.nodeY-t)<=20){n.push(p),e=!0;break}e||u.set(p.nodeY,[p])}const h=Array.from(u.entries()).sort(([e],[t])=>Math.abs(e-l)-Math.abs(t-l));if(0===h.length)return e;const[d,f]=h[0];let g=e,m=1/0;for(const p of f)p.horizontalDistance<m&&(g=p.index,m=p.horizontalDistance);return g}}class li{constructor(e){this.navigation=e,this.core=e.core,this.resizeHandler=null}setup(){let e,t=window.innerWidth,n=window.innerHeight;this.resizeHandler=()=>{const i=window.innerWidth,r=window.innerHeight,o=Math.abs(i-t),a=Math.abs(r-n),s=o>10||a>10,l=d3.select("#diagram");if(!l.empty())if(l.attr("width",i).attr("height",r),this.core.config.fitOnResize&&this.core.globalContainer&&this.core.globalTrees){const e=this.core.calculateDiagramBounds();this.core.applyInitialZoomImmediate(this.core.globalContainer,e.width,e.height)}else if(s&&this.core.globalContainer&&this.core.globalTrees){if((this.core.navigation?.zoomManagerInstance?.getCurrentZoom()||1)<=.2){const e=this.core.calculateDiagramBounds();this.core.applyInitialZoomImmediate(this.core.globalContainer,e.width,e.height)}}t=i,n=r,clearTimeout(e),e=setTimeout(()=>{},100)},window.addEventListener("resize",this.resizeHandler)}destroy(){this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null)}}class ci{constructor(){this.setupEventListeners()}setupEventListeners(){try{window.addEventListener("xdiagrams:infopanel:close",()=>{this.handleInfoPanelClose()})}catch(Ti){console.warn("Error setting up infopanel close listener:",Ti)}}handleInfoPanelClose(){try{d3.selectAll(".node rect").classed("node-selected",!1).style("stroke",null).style("stroke-width",null)}catch(Ti){console.warn("Error handling infopanel close:",Ti)}}destroy(){try{window.removeEventListener("xdiagrams:infopanel:close",this.handleInfoPanelClose)}catch(Ti){console.warn("Error removing event listeners:",Ti)}}}class ui{constructor(e){this.core=e,this.escapeLevel=0,this.zoomManager=new ri,this.zoomControls=new ii(this),this.keyboardNav=new oi(this),this.clusterNav=new ai(this),this.nodeNav=new si(this),this.resizeHandler=new li(this),this.eventHandler=new ci}createZoomControls(){return this.zoomControls.create()}setupKeyboardNavigation(e){return this.keyboardNav.setup(e)}setupResizeHandler(){return this.resizeHandler.setup()}destroyZoomControls(){this.keyboardNav.destroy(),this.resizeHandler.destroy(),this.zoomControls.destroy(),this.eventHandler.destroy()}getCurrentZoom(){return this.zoomManager.getCurrentZoom()}get zoomManagerInstance(){return this.zoomManager}get zoomControlsInstance(){return this.zoomControls}get keyboardNavInstance(){return this.keyboardNav}get clusterNavInstance(){return this.clusterNav}get nodeNavInstance(){return this.nodeNav}get resizeHandlerInstance(){return this.resizeHandler}get lastNodeDistance(){return this.nodeNav.lastNodeDistance}get isCircularNavigation(){return this.nodeNav.isCircularNavigation}}class hi{constructor(){this.isLoading=!1,this.loadingContainer=null}createLoading(){const e=document.querySelector("#app");if(!e)return;document.getElementById("loading-container")?.remove();const t=document.createElement("div");t.id="loading-container",t.style.cssText="\n      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);\n      z-index: 9999; opacity: 1; transition: opacity 0.5s ease-in-out; pointer-events: none;\n    ";const n=document.createElement("div");if(n.style.cssText="\n      width: 50px; height: 50px; border: 3px solid rgba(255, 255, 255, 0.3);\n      border-top: 3px solid var(--loading-color); border-radius: 50%; animation: spin 1s linear infinite;\n    ",!document.querySelector("#loading-animation")){const e=document.createElement("style");e.id="loading-animation",e.textContent="\n        @keyframes spin {\n          0% { transform: rotate(0deg); }\n          100% { transform: rotate(360deg); }\n        }\n      ",document.head.appendChild(e)}t.appendChild(n),e.appendChild(t),this.loadingContainer=t}show(){this.isLoading=!0,this.createLoading();const e=document.getElementById("diagram");e&&e.style.setProperty("opacity","0")}hide(){this.isLoading=!1,this.loadingContainer&&(this.loadingContainer.style.opacity="0",setTimeout(()=>{this.loadingContainer&&this.loadingContainer.parentNode&&this.loadingContainer.remove()},500))}getLoadingState(){return{isLoading:this.isLoading,loadingContainer:this.loadingContainer}}}class di{constructor(){this.errorContainer=null}showError(e){if(this.isSimpleError(e))return void this.showSimpleError("No se ha encontrado el archivo de datos");const t=document.createElement("div");t.id="xdiagrams-error",t.className="xdiagrams-error-dialog";const n=document.createElement("h3");n.textContent="No se pudo cargar el diagrama",n.className="xdiagrams-error-title",t.appendChild(n);const i=document.createElement("p");i.textContent=e.message||"Error desconocido al cargar los datos",i.className="xdiagrams-error-message",t.appendChild(i);const r=document.createElement("button");r.textContent="Reintentar",r.className="xdiagrams-error-retry-btn",r.onclick=()=>{t.remove(),window.dispatchEvent(new CustomEvent("xdiagrams-retry"))};const o=document.createElement("button");o.textContent="Cerrar",o.className="xdiagrams-error-close-btn",o.onclick=()=>{t.remove()};const a=document.createElement("div");a.className="xdiagrams-error-buttons",a.appendChild(r),a.appendChild(o),t.appendChild(a),document.body.appendChild(t),this.errorContainer=t,setTimeout(()=>{t.parentNode&&t.remove()},3e4)}showSimpleError(e){const t=document.getElementById("xdiagrams-simple-error");t&&t.remove();const n=document.createElement("div");n.id="xdiagrams-simple-error",n.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      color: white;\n      opacity: 0.5;\n      font-family: Arial, sans-serif;\n      font-size: 18px;\n      z-index: 10000;\n      text-align: center;\n      max-width: 400px;\n      line-height: 1.4;\n    ";const i=document.createElement("div");i.textContent=e,i.style.cssText="margin: 0;",n.appendChild(i),document.body.appendChild(n),this.errorContainer=n}isSimpleError(e){return["404","No se pudo cargar","Failed to fetch","ERR_CONNECTION_CLOSED","Error cargando archivo CSV","No se pudo determinar el tipo de fuente","URL o formato no reconocido"].some(t=>e.message&&e.message.includes(t))}clearError(){this.errorContainer&&this.errorContainer.parentNode&&(this.errorContainer.remove(),this.errorContainer=null)}}class fi{constructor(){this.notifications=new Map}showCacheCleared(){const e=document.createElement("div");e.id="cache-notification",e.style.cssText="\n      position: fixed; top: 20px; right: 20px; background: #000; color: white;\n      padding: 12px 20px; border-radius: 6px; font-family: Arial, sans-serif;\n      font-size: 14px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n      opacity: 0; transform: translateX(100%); transition: all 0.3s ease;\n    ",e.textContent="Cache limpiado - Recargando datos...",document.body.appendChild(e),setTimeout(()=>{e.style.cssText+="opacity: 1; transform: translateX(0);"},100),setTimeout(()=>{e.style.cssText+="opacity: 0; transform: translateX(100%);",setTimeout(()=>{e.parentNode&&e.remove()},300)},3e3),this.notifications.set("cache-cleared",e)}showNotification(e,t="info",n=3e3){const i=document.createElement("div"),r=`notification-${Date.now()}`;i.id=r;const o=this.getBackgroundColor(t),a=this.getIcon(t);i.style.cssText=`\n      position: fixed; top: 20px; right: 20px; background: ${o}; color: white;\n      padding: 12px 20px; border-radius: 6px; font-family: Arial, sans-serif;\n      font-size: 14px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n      opacity: 0; transform: translateX(100%); transition: all 0.3s ease;\n      display: flex; align-items: center; gap: 8px;\n    `,i.innerHTML=`\n      <span style="font-size: 16px;">${a}</span>\n      <span>${e}</span>\n    `,document.body.appendChild(i),setTimeout(()=>{i.style.cssText+="opacity: 1; transform: translateX(0);"},100),setTimeout(()=>{i.style.cssText+="opacity: 0; transform: translateX(100%);",setTimeout(()=>{i.parentNode&&i.remove(),this.notifications.delete(r)},300)},n),this.notifications.set(r,i)}getBackgroundColor(e){const t={info:"#007bff",success:"#28a745",warning:"#ffc107",error:"#dc3545"};return t[e]||t.info}getIcon(e){const t={info:"",success:"",warning:"",error:""};return t[e]||t.info}clearAllNotifications(){this.notifications.forEach(e=>{e.parentNode&&e.remove()}),this.notifications.clear()}clearNotification(e){const t=this.notifications.get(e);t&&t.parentNode&&(t.remove(),this.notifications.delete(e))}}const gi=window.d3;class mi{constructor(e={}){this.options={panelId:"side-panel",...e},this.isClosing=!1,this.infoPanelElements=new Map,this.thumbsSystem=e.thumbsSystem||null,this.ensureStylesInjected(),this.ensurePanel()}ensureStylesInjected(){}ensurePanel(){if(document.getElementById(this.options.panelId))return;const e=document.createElement("div");e.className="side-panel",e.id=this.options.panelId,e.innerHTML='\n      <div class="side-panel-header">\n        <h3 class="side-panel-title" id="side-panel-title">\n          <span class="side-panel-title-thumbnail" id="side-panel-thumbnail"></span>\n          <div class="side-panel-title-content">\n            <span class="side-panel-title-text" id="side-panel-title-text">Detalles del Nodo</span>\n            <span class="side-panel-title-id" id="side-panel-title-id"></span>\n          </div>\n        </h3>\n      </div>\n      <div class="side-panel-url-section" id="side-panel-url-section" style="display: none;">\n        <div class="side-panel-url-input-container">\n          <input type="text" class="side-panel-url-input" id="side-panel-url-input" placeholder="URL del nodo" readonly>\n          <button class="side-panel-url-button" id="side-panel-url-button" type="button">\n            <svg class="side-panel-url-button-icon" width="14" height="14" viewBox="0 0 640 640" fill="currentColor" xmlns="http://www.w3.org/2000/svg">\n              <path d="M384 64C366.3 64 352 78.3 352 96C352 113.7 366.3 128 384 128L466.7 128L265.3 329.4C252.8 341.9 252.8 362.2 265.3 374.7C277.8 387.2 298.1 387.2 310.6 374.7L512 173.3L512 256C512 273.7 526.3 288 544 288C561.7 288 576 273.7 576 256L576 96C576 78.3 561.7 64 544 64L384 64zM144 160C99.8 160 64 195.8 64 240L64 496C64 540.2 99.8 576 144 576L400 576C444.2 576 480 540.2 480 496L480 416C480 398.3 465.7 384 448 384C430.3 384 416 398.3 416 416L416 496C416 504.8 408.8 512 400 512L144 512C135.2 512 128 504.8 128 496L128 240C128 231.2 135.2 224 144 224L224 224C241.7 224 256 209.7 256 192C256 174.3 241.7 160 224 160L144 160z"/>\n            </svg>\n          </button>\n        </div>\n      </div>\n      <div class="side-panel-content" id="side-panel-content"></div>\n      <button class="side-panel-collapse-btn" id="side-panel-collapse-btn" type="button" aria-label="Colapsar panel"></button>\n    ',document.body.appendChild(e),e.querySelector("#side-panel-collapse-btn")?.addEventListener("click",()=>this.close())}async open(e,t={}){this.ensurePanel();const n=document.getElementById(this.options.panelId),i=document.getElementById("side-panel-content"),r=document.getElementById("side-panel-title-text"),o=document.getElementById("side-panel-title-id"),a=document.getElementById("side-panel-thumbnail"),s=document.getElementById("side-panel-url-section"),l=document.getElementById("side-panel-url-input"),c=document.getElementById("side-panel-url-button");if(!(n&&i&&r&&o&&a))return;const u=e?.name||e?.Name||e.data&&e.data.name||e.data&&e.data.Name||e?.title||"Nodo",h=e?.id??e?.ID??e?.Node??(e.data&&e.data.id)??(e.data&&e.data.ID)??(e.data&&e.data.Node)??"";r.textContent=String(u),o.textContent=h||"";const d=this.findUrl(e);d&&s&&l?(l.value=d,s.style.display="block",c&&(c.onclick=()=>{window.open(d,"_blank","noopener,noreferrer")})):s&&(s.style.display="none"),await this.createThumbnail(a,e,t),i.innerHTML=await this.buildFieldsHtml(e,t),n.classList.add("open");try{window.dispatchEvent(new CustomEvent("xdiagrams:infopanel:open"))}catch(f){}}async createThumbnail(e,t,n={}){try{let i=null;if(this.thumbsSystem&&this.thumbsSystem.resolverInstance?i=this.thumbsSystem.resolverInstance:window.xDiagramsLoader&&window.xDiagramsLoader.instance&&window.xDiagramsLoader.instance.thumbs?i=window.xDiagramsLoader.instance.thumbs.resolverInstance:window.XDiagrams&&window.XDiagrams.instance&&window.XDiagrams.instance.thumbs&&(i=window.XDiagrams.instance.thumbs.resolverInstance),i){const n=i.resolveThumbnail(t);if("external-image"===n.type)return void(e.innerHTML=`<img src="${n.value}" class="custom-image" width="36" height="36" style="opacity: 1; transition: opacity 0.2s ease-in-out;" onerror="this.style.display='none'">`);if("custom-icon"===n.type){const t=this.getIconUnicode(n.value);return void(e.innerHTML=`<span style="display: flex; align-items: center; justify-content: center; font-family: 'xdiagrams-icons'; font-size: 18px; color: var(--ui-panel-text);">${t}</span>`)}}const r=t.img||t.data&&t.data.img||"";if(r&&""!==r.trim())return void(e.innerHTML=`<img src="${r}" class="custom-image" width="36" height="36" style="opacity: 1; transition: opacity 0.2s ease-in-out;" onerror="this.style.display='none'">`);const o=this.getNodeIconFromDiagram(t);if(o)return void(e.innerHTML=o);const a=n.defaultIcon||"detail",s=this.getIconUnicode(a);e.innerHTML=`<span style="display: flex; align-items: center; justify-content: center; font-family: 'xdiagrams-icons'; font-size: 18px; color: var(--ui-panel-text);">${s}</span>`}catch(Ti){console.error("[InfoPanel] Error creating thumbnail:",Ti);const n=this.getIconUnicode("detail");e.innerHTML=`<span style="display: flex; align-items: center; justify-content: center; font-family: 'xdiagrams-icons'; font-size: 18px; color: var(--ui-panel-text);">${n}</span>`}}resolveNodeImage(e){return e.img||e.data&&e.data.img||""}getDefaultIcon(e,t={}){try{const n=this.getNodeIconFromDiagram(e);if(n)return n;return`<span class="${t.defaultIcon||"detail"}" style="display: flex; align-items: center; justify-content: center; font-family: 'xdiagrams-icons'; font-size: 18px; color: var(--ui-panel-text);"></span>`}catch(Ti){return console.error("[InfoPanel] Error creating default icon:",Ti),'<span style="display: flex; align-items: center; justify-content: center; font-size: 14px; color: var(--ui-panel-text-muted);"></span>'}}getNodeIconFromDiagram(e){try{const t=e.icon||e.Icon||e.type||e.Type||e.data&&e.data.icon||e.data&&e.data.Icon||e.data&&e.data.type||e.data&&e.data.Type;if(t){return`<span style="display: flex; align-items: center; justify-content: center; font-family: 'xdiagrams-icons'; font-size: 18px; color: var(--ui-panel-text);">${this.getIconUnicode(t)}</span>`}const n=e.name||e.Name||e.data&&e.data.name||e.data&&e.data.Name||"",i=this.inferIconFromName(n);if(i){return`<span style="display: flex; align-items: center; justify-content: center; font-family: 'xdiagrams-icons'; font-size: 18px; color: var(--ui-panel-text);">${this.getIconUnicode(i)}</span>`}return null}catch(Ti){return console.error("[InfoPanel] Error getting node icon from diagram:",Ti),null}}getIconUnicode(e){const t={detail:"",list:"",grid:"",form:"",document:"",modal:"",report:"",profile:"",home:"",settings:""};return t[this.normalizeIconName(e)]||t.detail}normalizeIconName(e){if(!e||"string"!=typeof e)return"";let t=e.toLowerCase().trim();return t=t.replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,""),t}inferIconFromName(e){if(!e||"string"!=typeof e)return null;const t=e.toLowerCase(),n={form:"form",formulario:"form",input:"form",entrada:"form",document:"document",documento:"document",file:"document",archivo:"document",pdf:"document",report:"report",reporte:"report",list:"list",lista:"list",table:"list",tabla:"list",grid:"grid",cuadricula:"grid",home:"home",inicio:"home",dashboard:"home",panel:"home",profile:"profile",perfil:"profile",user:"profile",usuario:"profile",settings:"settings",configuracion:"settings",config:"settings",ajustes:"settings",modal:"modal",popup:"modal",ventana:"modal",dialog:"modal",detail:"detail",detalle:"detail",info:"detail",informacion:"detail"};for(const[i,r]of Object.entries(n))if(t.includes(i))return r;return null}close(){this.isClosing=!0;const e=document.getElementById(this.options.panelId);e?.classList.remove("open");if(!gi.select(".node-selected").empty()&&window.$xDiagrams?.navigation)try{window.$xDiagrams.navigation.exitNodeNavigationMode(!0)}catch(t){}try{window.dispatchEvent(new CustomEvent("xdiagrams:infopanel:close"))}catch(t){}setTimeout(()=>{this.isClosing=!1},300)}async buildFieldsHtml(e,t={}){try{const n=[],i=e.data||e,r=!1!==t.showAllColumns,o=!0===t.hideEmptyColumns;for(const[e,t]of Object.entries(i)){if(e.startsWith("_")||"children"===e||"parent"===e||"Parent"===e)continue;if(o&&(!t||""===t.toString().trim()))continue;const i=["name","Name"],a=["id","ID","Node"],s=["parent","Parent","img","Img"],l=["url","URL","Url"].includes(e);if(i.includes(e)||a.includes(e)||s.includes(e)||l)continue;if(!r){if(!["title","description","desc"].includes(e.toLowerCase()))continue}const c=this.formatValue(t),u=this.isUrl(t);n.push({label:e.charAt(0).toUpperCase()+e.slice(1),value:t,displayValue:c,isUrl:u,labelTitle:`Campo: ${e}`,valueTitle:u?`Abrir: ${t}`:void 0})}if(0===n.length)return'<div class="side-panel-field"><div class="side-panel-value empty">No hay informacin disponible</div></div>';let a='<div class="side-panel-fields-table">';return n.forEach(e=>{a+=`\n          <div class="side-panel-field">\n            <div class="side-panel-label" ${e.labelTitle?`data-tooltip="${e.labelTitle}"`:""}>${e.label}</div>\n            <div class="side-panel-value ${e.value?"":"empty"}" ${e.valueTitle?`data-tooltip="${e.valueTitle}"`:""}>\n              ${e.isUrl?`<a href="${e.value}" target="_blank" rel="noreferrer" class="side-panel-url-link">${e.displayValue}</a>`:e.displayValue}\n            </div>\n          </div>\n        `}),a+="</div>",a}catch(Ti){return console.error("[InfoPanel] Error building fields HTML:",Ti),'<div class="side-panel-field"><div class="side-panel-value empty">Error al cargar informacin</div></div>'}}formatValue(e){return null==e?"":"string"==typeof e?this.escapeHtml(e):"number"==typeof e?e.toString():"boolean"==typeof e?e?"S":"No":Array.isArray(e)?e.join(", "):"object"==typeof e?JSON.stringify(e):String(e)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}isUrl(e){if("string"!=typeof e)return!1;try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch{return!1}}findUrl(e){const t=e.data||e,n=t.url||t.URL||t.Url;return n&&this.isUrl(n)?n:null}updateInfoPanel(e){}getInfoPanelData(){return{}}clearInfoPanel(){this.close()}setInfoPanelValue(e,t){console.warn("[InfoPanel] setInfoPanelValue is deprecated")}getInfoPanelElement(e){return document.getElementById(e)}}class pi{constructor(){this.pillElement=null,this.isInitialized=!1}init(){this.createPillElement()}createPillElement(){this.pillElement=document.createElement("div"),this.pillElement.id="xdiagrams-floating-title-pill",this.pillElement.className="floating-title-pill",document.body.appendChild(this.pillElement)}update(e,t){if(this.pillElement&&document.body.contains(this.pillElement)||this.init(),this.pillElement.innerHTML="",t){const e=document.createElement("img");e.className="floating-logo",e.src=t,e.alt="Logo",this.pillElement.appendChild(e)}else{const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("width","24"),e.setAttribute("height","24"),e.setAttribute("viewBox","0 0 24 24"),e.className="floating-logo";const t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("d","M12 2L22 12L12 22L2 12L12 2Z"),t.setAttribute("fill","currentColor"),t.setAttribute("opacity","0.8");const n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d","M12 6L18 12L12 18L6 12L12 6Z"),n.setAttribute("fill","var(--ui-panel-bg)"),e.appendChild(t),e.appendChild(n),this.pillElement.appendChild(e)}if(e){const t=document.createElement("h2");t.className="floating-title",t.textContent=e,this.pillElement.appendChild(t)}this.pillElement.style.display="flex",this.pillElement.style.visibility="visible",this.pillElement.style.opacity="1",this.forceApplyStyles()}getTitleFromConfig(e){if(e.title)return e.title;if(e.name)return e.name;const t=document.querySelector("title");return t?t.textContent:"Diagrama"}getLogoFromConfig(e){return e.logo?e.logo:window.$xDiagrams&&window.$xDiagrams.logo?window.$xDiagrams.logo:null}updateFromConfig(e){const t=this.getTitleFromConfig(e),n=this.getLogoFromConfig(e);this.update(t,n)}show(){this.pillElement&&(this.pillElement.style.display="flex")}hide(){this.pillElement&&(this.pillElement.style.display="none")}destroy(){this.pillElement&&(this.pillElement.remove(),this.pillElement=null,this.isInitialized=!1)}ensureVisible(){if(!this.pillElement||!document.body.contains(this.pillElement))return void this.init();const e=this.pillElement.getBoundingClientRect();0!==e.width&&0!==e.height&&"none"!==this.pillElement.style.display||(this.pillElement.style.display="flex",this.pillElement.style.visibility="visible",this.pillElement.style.opacity="1")}startVisibilityMonitoring(){setInterval(()=>{this.ensureVisible()},2e3)}setupThemeListener(){new MutationObserver(e=>{e.forEach(e=>{"attributes"===e.type&&"data-theme"===e.attributeName&&this.updateThemeStyles()})}).observe(document.body,{attributes:!0,attributeFilter:["data-theme"]})}updateThemeStyles(){this.pillElement&&this.ensureVisible()}forceApplyStyles(){this.pillElement&&this.pillElement.offsetHeight}}class yi{constructor(e={}){this.errorManager=new di,this.loadingManager=new hi,this.notificationManager=new fi,this.infoPanel=new mi({thumbsSystem:e.thumbsSystem}),this.floatingTitlePill=new pi}showLoading(){return this.loadingManager.show()}hideLoading(){return this.loadingManager.hide()}showErrorMessage(e){return this.errorManager.showError(e)}showSimpleErrorMessage(e){return this.errorManager.showSimpleError(e)}showCacheClearedNotification(){return this.notificationManager.showCacheCleared()}openInfoPanel(e,t={}){return this.infoPanel.open(e,t)}closeInfoPanel(){return this.infoPanel.close()}updateInfoPanel(e){return this.infoPanel.updateInfoPanel(e)}getInfoPanelData(){return this.infoPanel.getInfoPanelData()}clearInfoPanel(){return this.infoPanel.clearInfoPanel()}setInfoPanelValue(e,t){return this.infoPanel.setInfoPanelValue(e,t)}getInfoPanelElement(e){return this.infoPanel.getInfoPanelElement(e)}get loadingManagerInstance(){return this.loadingManager}get errorManagerInstance(){return this.errorManager}get notificationManagerInstance(){return this.notificationManager}get infoPanelInstance(){return this.infoPanel}get isInfoPanelClosing(){return this.infoPanel.isClosing}updateFloatingTitlePill(e){!1!==e.showTitle?(this.floatingTitlePill.updateFromConfig(e),this.floatingTitlePill.startVisibilityMonitoring(),this.floatingTitlePill.setupThemeListener()):this.floatingTitlePill.hide()}showFloatingTitlePill(){return this.floatingTitlePill.show()}hideFloatingTitlePill(){return this.floatingTitlePill.hide()}destroyFloatingTitlePill(){return this.floatingTitlePill.destroy()}get floatingTitlePillInstance(){return this.floatingTitlePill}}class vi{constructor(e){this.core=e}renderTrees(e,t){const{clusterGapX:n,clusterGapY:i}=this.core.config,r=this.core.config.clustersPerRow?this.core.config.clustersPerRow.split(" ").map(e=>parseInt(e)):this.calculateOptimalLayout(e.length),o=e.map((e,t)=>{const n=this.calculateTreeSize(e);return{tree:e,index:t,clusterWidth:n.width,clusterHeight:n.height}}),{treeLayouts:a,maxRowWidth:s,totalHeight:l}=this.calculateLayout(o,r,n,i),c=a.map((e,n)=>{const{tree:i,clusterWidth:r,clusterHeight:o,x:a,y:s}=e,l=t.append("g").attr("class","cluster").attr("id",`cluster-${i.id}`).attr("transform",`translate(${a}, ${s})`).style("opacity",0),c=l.append("g").attr("class","tree-group");c.append("rect").attr("class","cluster-bg").attr("width",r).attr("height",o).attr("x",0).attr("y",0).attr("tabindex","0").style("outline","none"),this.core.clusterPositions.set(i.name,{x:a,y:s,width:r,height:o});const u=c.append("g").attr("class","cluster-title-container"),h=u.append("rect").attr("class","cluster-title-bg").attr("rx",8).attr("ry",8),d=u.append("text").attr("class","cluster-title").attr("x",50).attr("y",150).text(i.id||i.name);d.attr("data-cluster-name",i.name);const f=d.node().getBBox();h.attr("x",f.x-56).attr("y",f.y-32).attr("width",f.width+112).attr("height",f.height+64);const g=u.append("rect").attr("class","cluster-hover-title-large-bg").attr("x",0).attr("y",0).attr("rx",80).attr("ry",80),m=u.append("text").attr("class","cluster-hover-title-large").attr("x",150).attr("y",350).text(i.id||i.name).attr("data-cluster-name",i.name),p=m.node().getBBox();g.attr("x",p.x-120).attr("y",p.y-90).attr("width",p.width+240).attr("height",p.height+180);let y=!1;l.on("mouseenter",()=>{if(y)return;this.core.navigation.zoomManager.getCurrentZoom()<=.1&&(m.style("opacity",1),g.style("opacity",1))}).on("mouseleave",()=>{y||(m.style("opacity",0),g.style("opacity",0))}).on("click",()=>{y=!0,m.style("opacity",0),g.style("opacity",0),setTimeout(()=>{y=!1},2e3)});const v=()=>{this.core.navigation.zoomManager.getCurrentZoom()>.1&&(m.style("opacity",0),g.style("opacity",0))};this.core.navigation&&this.core.navigation.zoomManager&&this.core.navigation.zoomManager.onZoomChange(v);const w=c.append("g").attr("class","tree-content"),x=d3.hierarchy(i);d3.tree().nodeSize([this.core.config.nodeWidth+this.core.config.spacing,this.core.config.nodeHeight+this.core.config.verticalSpacing])(x);let b=1/0,_=-1/0,C=1/0,I=-1/0;x.descendants().forEach(e=>{b=Math.min(b,e.x),_=Math.max(_,e.x+this.core.config.nodeWidth),C=Math.min(C,e.y),I=Math.max(I,e.y+this.core.config.nodeHeight)});const E=r/2-(b+_)/2,T=450+(o-450-450)/2-(C+I)/2;return this.renderTreeSimple(i,w,E,T),l});this.addClusterClickEvents(c,t),this.setupThemeChangeListener(),this.updateCounters(this.countTotalNodes(e),e.length),this.applyInitialZoomImmediate(t,s,l),setTimeout(()=>{this.core.uiManager&&this.core.uiManager.hideLoading(),setTimeout(()=>{c.forEach(e=>e.style("opacity",1));const e=d3.select("#diagram");e.select("g").style("opacity",null).style("visibility",null),e.style("opacity",1).style("visibility","visible"),document.getElementById("diagram").style.cssText="opacity: 1; visibility: visible;",this.core.thumbs.showIconsWithFadeIn(),this.core.navigation.keyboardNavInstance.initialize()},300)},100)}calculateOptimalLayout(e){const t=Math.ceil(Math.sqrt(e)),n=Math.ceil(e/t),i=[];for(let r=0;r<n;r++)i.push(Math.min(t,e-r*t));return i}calculateLayout(e,t,n,i){const r=[],o=[],a=[];let s=0,l=0;for(;s<e.length;){const i=t[l]||7,r=Math.min(s+i,e.length),c=e.slice(s,r),u=c.reduce((e,t)=>e+(this.calculateTreeSize(t.tree).treeWidth+280+280),0)+(c.length-1)*n;o.push(u),a.push(Math.max(...c.map(e=>e.clusterHeight))),s=r,l++}const c=Math.max(...o);let u=30;for(s=0,l=0;s<e.length;){const o=t[l]||7,h=Math.min(s+o,e.length),d=e.slice(s,h),f=a[l],g=d.map(e=>this.calculateTreeSize(e.tree).treeWidth+280+280),m=g.reduce((e,t)=>e+t,0),p=c-(d.length-1)*n,y=Math.max(0,p-m),v=g.map((e,t)=>e+y*(y>0?e/m:0));let w=0;d.forEach((e,t)=>{const i=v[t];r.push({tree:e.tree,clusterWidth:i,clusterHeight:f,x:w,y:u}),w+=i+n}),u+=f+i,s=h,l++}const h=a.reduce((e,t,n)=>e+t+(n<a.length-1?i:0),30);return{treeLayouts:r,maxRowWidth:c,totalHeight:h}}isLinearTree(e){if(!e.children||0===e.children.length)return!0;return function e(t){return!t.children||0===t.children.length||!(t.children.length>1)&&e(t.children[0])}(e)}hasLinearBranches(e){if(!e.children||0===e.children.length)return!0;function t(e){return!e.children||0===e.children.length||!(e.children.length>1)&&t(e.children[0])}return e.children.every(e=>t(e))}isSingleLevelTree(e){return!e.children||0===e.children.length||e.children.every(e=>!e.children||0===e.children.length)}renderTreeSimple(e,t,n=0,i=0){const{nodeWidth:r,nodeHeight:o,linearSpacing:a,branchedSpacing:s}=this.core.config,l=d3.hierarchy(e),c=this.isLinearTree(l),u=this.hasLinearBranches(l),h=this.isSingleLevelTree(l),d=c||u?a:s;if(d3.tree().nodeSize([r+d,o+this.core.config.verticalSpacing])(l),l.children&&l.children.length>1&&(u||h)){const e=l.children.filter(e=>e.children&&e.children.length>0);let t=0;if(e.length>1){const n=e.sort((e,t)=>e.x-t.x),i=n[n.length-1].x-n[0].x;t=i/(e.length-1)}l.children.forEach((e,n)=>{if((!e.children||0===e.children.length)&&t>0)if(n>0){const i=l.children[n-1],r=e.x-i.x;if(r<t){const n=t-r;e.x+=n}}else{const i=l.children[n+1];if(i){const n=i.x-e.x;if(n<t){const i=t-n;e.x-=i}}}})}this.renderTreeFromLayout(l,t,n,i)}renderTreeFromLayout(e,t,n=0,i=0){const{nodeWidth:r,nodeHeight:o}=this.core.config,a=t.append("g").attr("class","node").attr("transform",`translate(${n+e.x}, ${i+e.y})`).datum(e);if(a.append("rect").attr("width",r).attr("height",o).style("pointer-events","all"),this.core.thumbs.createThumbnailElement(e.data,a,r/2,o/2,82,82),this.core.textHandler.renderNodeTextCentered(a,e.data.name,r/2,.7*o,{maxWidth:this.core.config.textConfig.maxWidth,fontSize:this.core.config.textConfig.nodeNameFontSize,lineHeight:this.core.config.textConfig.lineHeight,fontWeight:"bold",textAnchor:"middle",dominantBaseline:"middle"}),e.data.id){const o=null!==e.parent,a=o?n+e.x+44:n+e.x+r/2,s=o?"end":"middle";t.append("text").attr("class","node-id-label").attr("x",a).attr("y",i+e.y-7).style("font-size","6px").style("font-weight","normal").style("text-anchor",s).style("dominant-baseline","baseline").text(e.data.id)}a.style("cursor","pointer").style("pointer-events","all").on("click",t=>{t.stopPropagation();let n=null;try{const e=a.node()?.closest(".cluster");e&&(n=d3.select(e))}catch(i){}if(n&&!n.empty()){if(!n.select(".cluster-bg").classed("cluster-focused"))return void this.core.navigation.clusterNavInstance.zoomToCluster(n,this.core.globalContainer,!1,!1);this.selectNodeAndZoomToIt(a,e)}else this.selectNodeAndZoomToIt(a,e)}).on("dblclick",t=>{t.stopPropagation(),d3.select(".node-selected").empty()?this.selectNodeAndZoomToIt(a,e):this.core.navigation.nodeNavInstance.exitNodeNavigationMode(!0)}),e.children&&e.children.length>0&&e.children.forEach(a=>{const s=n+e.x+r/2,l=i+e.y+o,c=n+a.x+r/2,u=i+a.y;t.insert("path",":first-child").attr("class","link").attr("d",this.createLinkPath(s,l,c,u)),this.renderTreeFromLayout(a,t,n,i)})}createLinkPath(e,t,n,i){const{cornerRadius:r,verticalTolerance:o}=this.core.config.linkConfig;return((e,t,n,i)=>{const r=(t+i)/2,o=this.core.config.linkConfig.cornerRadius;return Math.abs(e-n)<this.core.config.linkConfig.verticalTolerance?`M${e},${t} L${n},${i}`:n<e?`\n          M${e},${t}\n          L${e},${r-o}\n          Q${e},${r} ${e-o},${r}\n          L${n+o},${r}\n          Q${n},${r} ${n},${r+o}\n          L${n},${i}\n        `:`\n          M${e},${t}\n          L${e},${r-o}\n          Q${e},${r} ${e+o},${r}\n          L${n-o},${r}\n          Q${n},${r} ${n},${r+o}\n          L${n},${i}\n        `})(e,t,n,i)}countTotalNodes(e){let t=0;const n=e=>{t++,e.children.forEach(n)};return e.forEach(n),t}calculateTreeSize(e){const t=d3.hierarchy(e),n=this.isLinearTree(t),i=this.hasLinearBranches(t),r=n||i?this.core.config.linearSpacing:this.core.config.branchedSpacing;d3.tree().nodeSize([this.core.config.nodeWidth+r,this.core.config.nodeHeight+this.core.config.verticalSpacing])(t);let o=1/0,a=-1/0,s=1/0,l=-1/0;t.descendants().forEach(e=>{o=Math.min(o,e.x),a=Math.max(a,e.x+this.core.config.nodeWidth),s=Math.min(s,e.y),l=Math.max(l,e.y+this.core.config.nodeHeight)}),o===1/0&&(o=0),a===-1/0&&(a=this.core.config.nodeWidth),s===1/0&&(s=0),l===-1/0&&(l=this.core.config.nodeHeight);const c=t.descendants().find(e=>0===e.depth),u=c?c.x:0,h=Math.abs(o-u),d=Math.abs(a-u),f=2*Math.max(h,d)+this.core.config.nodeWidth,g=l-s,m=g>0?g:(t.height+1)*(this.core.config.nodeHeight+this.core.config.verticalSpacing);return{width:f+280+280,height:1.1*(m+this.core.config.nodeWidth+280+450),treeWidth:f,treeHeight:m}}addClusterClickEvents(e,t){e.forEach(e=>{["cluster-bg","cluster-title"].forEach(n=>{const i=e.select(`.${n}`);let r=0,o=0,a=!1;i.style("cursor","pointer").on("mousedown",e=>{r=e.clientX,o=e.clientY,a=!1}).on("mousemove",e=>{if(0!==r&&0!==o){const t=Math.abs(e.clientX-r),n=Math.abs(e.clientY-o);(t>10||n>10)&&(a=!0)}}).on("click",n=>{if(!a){if(n.stopPropagation(),n.preventDefault(),!d3.select(".node-selected").empty())return;e&&!e.empty()&&this.core.navigation.clusterNavInstance.zoomToCluster(e,t,!1,!0)}r=0,o=0,a=!1})})}),d3.select("#diagram").on("dblclick",e=>{d3.select(".node-selected").empty()?this.core.navigation.zoomControlsInstance.resetZoom(t):this.core.navigation.nodeNavInstance.exitNodeNavigationMode(!0)}),d3.select("#diagram").on("click",e=>{if(e.target===e.currentTarget){if(!d3.select(".node-selected").empty())return e.stopPropagation(),void e.preventDefault();this.core.navigation.clusterNavInstance.deselectClusterOnOutsideClick()}}),this.core.navigation.createZoomControls(),this.core.navigation.setupKeyboardNavigation(t)}updateCounters(e,t){const n={"node-count":e,"cluster-count":t,"render-type":"SVG"};Object.entries(n).forEach(([e,t])=>{const n=document.getElementById(e);n&&(n.textContent=t)})}applyInitialZoom(e,t,n){this.applyInitialZoomWithTransition(e,t,n,1e3)}applyInitialZoomImmediate(e,t,n){this.applyInitialZoomWithTransition(e,t,n,0)}applyInitialZoomWithTransition(e,t,n,i=0){const r=d3.select("#diagram").node().getBoundingClientRect(),{width:o,height:a}=r,s=this.calculateDiagramBounds(),l=s.width||t,c=s.height||n,u=o/l,h=a/c;let d=Math.min(u,h)*(this.core.config.initialZoom?.scale||.95)*(1-(this.core.config.initialZoom?.padding||.05));d=Math.max(.05,Math.min(2,d));const f=(o-l*d)/2,g=(a-c*d)/2,m=d3.zoomIdentity.translate(f,g).scale(d);this.core.navigation&&this.core.navigation.zoomManagerInstance&&this.core.navigation.zoomManagerInstance.setInitialTransform(m),this.core.navigation&&this.core.navigation.zoomManagerInstance&&(i>0?this.core.navigation.zoomManagerInstance.zoomTo(m,i):this.core.navigation.zoomManagerInstance.zoomToImmediate(m)),this.updateInfoPanel(m),this.core.navigation.clusterNavInstance.deselectActiveCluster()}calculateDiagramBounds(){const e=d3.selectAll(".cluster");if(e.empty())return{width:8e3,height:8e3};let t=1/0,n=-1/0,i=1/0,r=-1/0,o=0;return e.each(function(){const e=d3.select(this),a=e.attr("transform"),s=e.select(".cluster-bg");if(a&&!s.empty()){const e=a.match(/translate\(([^,]+),\s*([^)]+)\)/);if(e){const a=parseFloat(e[1]),l=parseFloat(e[2]),c=parseFloat(s.attr("width")),u=parseFloat(s.attr("height"));isNaN(a)||isNaN(l)||isNaN(c)||isNaN(u)||(t=Math.min(t,a),n=Math.max(n,a+c),i=Math.min(i,l),r=Math.max(r,l+u),o++)}}}),t===1/0||n===-1/0||i===1/0||r===-1/0||0===o?{width:8e3,height:8e3}:{width:n-t,height:r-i}}updateInfoPanel(e){this.core.uiManager&&this.core.uiManager.updateInfoPanel(e)}selectNodeAndZoomToIt(e,t){this.core.navigation.nodeNavInstance.selectNode(e,!0),this.zoomToNode(e,t,!0)}zoomToNode(e,t,n=!1){const i=d3.select("#diagram");if(i.empty())return;const r=i.node(),o=d3.zoomTransform(r),a=e.node().getBoundingClientRect(),s=r.getBoundingClientRect(),l=a.left+a.width/2,c=a.top+a.height/2,u=(l-o.x)/o.k,h=(c-o.y)/o.k,d=s.width/2,f=s.height/2,g=document.getElementById("side-panel");let m=0;g&&"none"!==g.style.display&&(m=g.getBoundingClientRect().width);const p=d-m/2-1.6*u,y=f-1.6*h,v=d3.zoomIdentity.translate(p,y).scale(1.6);let w=800;if(n)w=600;else if(this.core.navigation&&this.core.navigation.lastNodeDistance){const e=this.core.navigation.lastNodeDistance;let t,n;this.core.navigation.isCircularNavigation?(t=1e3,n=3e3):(t=400,n=1200),w=t+(n-t)*Math.min(e/800,1)}this.core.config&&this.core.config.enableNavigationLogs,this.core.navigation&&this.core.navigation.zoomManagerInstance?this.core.navigation.zoomManagerInstance.zoomTo(v,w):i.transition().duration(w).ease(d3.easeCubicOut).call(d3.zoom().transform,v)}setupThemeChangeListener(){document.addEventListener("themechange",e=>{this.updateClusterBorderRadius()})}updateClusterBorderRadius(){}}class wi{constructor(){}buildHierarchy(e){const t=new Map,n=[],i=(e,t,n="")=>{for(const i of t)if(void 0!==e[i]&&null!==e[i]&&""!==e[i])return e[i];return n};return e.forEach(e=>{const n=i(e,["ID","id","Node","node","Id"],null),r=i(e,["Name","name","Title","title"],null),o=i(e,["Parent","parent","Manager","manager","Leader","leader"],null),a=i(e,["Img","img","Icon","icon"],null);if(n&&r&&r.trim()){const s={id:n,name:r.trim(),parent:o,img:a,layout:i(e,["Layout","layout"],null),data:e,children:[]};t.set(n,s)}}),t.forEach(e=>{if(e.parent&&t.has(e.parent))t.get(e.parent).children.push(e);else if(e.parent){const i=Array.from(t.values()).find(t=>t.name===e.parent||t.id===e.parent);i?i.children.push(e):n.push(e)}else n.push(e)}),n}}class xi{constructor(){this.diagram=null,this.container=null}createDiagram(){let e=d3.select("#diagram");if(e.empty()){const t=d3.select("#app");if(t.empty())return console.error("XDiagrams: Elemento #app no encontrado"),null;const n=window.innerWidth,i=window.innerHeight;e=t.append("svg").attr("id","diagram").attr("width",n).attr("height",i).style("position","absolute").style("top","0").style("left","0").style("width","100%").style("height","100%")}const t=e.append("g").style("opacity",0).style("visibility","hidden");return e.style("opacity",0).style("visibility","hidden"),this.diagram=e,this.container=t,{diagram:e,container:t}}ensureDiagramHidden(){const e=document.getElementById("diagram");e&&(e.style.cssText="opacity: 0; visibility: hidden; transition: opacity 0.8s ease-in-out, visibility 0.8s ease-in-out")}showDiagram(){this.diagram&&(this.diagram.style("opacity",1).style("visibility","visible"),this.container&&this.container.style("opacity",1).style("visibility","visible"))}hideDiagram(){this.diagram&&(this.diagram.style("opacity",0).style("visibility","hidden"),this.container&&this.container.style("opacity",0).style("visibility","hidden"))}clearDiagram(){this.diagram&&this.diagram.selectAll("*").remove()}getDiagram(){return this.diagram}getContainer(){return this.container}getDiagramDimensions(){if(!this.diagram)return{width:0,height:0};const e=this.diagram.node();return{width:e.clientWidth||window.innerWidth,height:e.clientHeight||window.innerHeight}}}class bi{constructor(e){this.core=e}async initDiagram(){try{if(!this.core.config.url)return console.error("XDiagrams: URL de datos no configurada"),void this.core.uiManager.hideLoading();this.core.uiManager.showLoading();const{diagram:e,container:t}=this.core.svgManager.createDiagram();if(!e||!t)throw new Error("No se pudo crear el diagrama");this.core.navigation.zoomManagerInstance.setupZoom(e,this.core.navigation);const n=await this.loadData(),i=this.core.hierarchyBuilder.buildHierarchy(n);this.core.globalTrees=i,this.core.globalContainer=t,this.core.diagramRenderer.renderTrees(i,t),await this.core.llmDataGenerator.initialize(n,this.core.config),this.core.uiManager.updateFloatingTitlePill(this.core.config)}catch(Ti){console.error("XDiagrams: Error de inicializacin:",Ti),this.core.uiManager.hideLoading(),this.core.uiManager.showErrorMessage(Ti)}}async loadData(){let e;if(window.xDiagramsLoader)await new Promise((t,n)=>{window.xDiagramsLoader.loadData(this.core.config.url,(i,r)=>{r?(console.error("XDiagrams: Error en loader:",r),n(r)):(e=i,t())},{privateApi:this.core.config.privateApi})});else{const t=await fetch(this.core.config.url),n=await t.text();e=await new Promise((e,t)=>{Papa.parse(n,{header:!0,complete:t=>e(t.data),error:e=>t(e)})})}return e}clearCacheAndReload(){window.xDiagramsLoader?(window.xDiagramsLoader.clearCache(),this.core.uiManager.showCacheClearedNotification(),setTimeout(()=>{this.reloadDiagram()},500)):console.warn("XDiagrams: Loader no disponible")}async reloadDiagram(){try{this.core.navigation.destroyZoomControls(),this.core.svgManager.clearDiagram(),this.core.navigation.createZoomControls(),await this.initDiagram()}catch(Ti){console.error("XDiagrams: Error de recarga:",Ti)}}setupEventListeners(){window.addEventListener("xdiagrams-retry",()=>{this.initDiagram()})}}class _i{constructor(){this.storageKey="xdiagrams_llm_data",this.lastUpdateKey="xdiagrams_llm_last_update",this.updateInterval=3e5}async initialize(e,t){const n=localStorage.getItem("xdiagrams_llm_last_update"),i=Date.now(),r=i-(n?parseInt(n):0);if(!(n&&r<36e5))try{const n=this.generateLLMData(e,t);localStorage.setItem("xdiagrams_llm_data",JSON.stringify(n)),localStorage.setItem("xdiagrams_llm_last_update",i.toString())}catch(Ti){console.error("[LLMDataGenerator] Error generando datos LLM:",Ti)}}shouldUpdateData(){const e=localStorage.getItem(this.lastUpdateKey);if(!e)return!0;return Date.now()-parseInt(e)>this.updateInterval}async generateLLMData(e,t={}){try{console.log("[LLMDataGenerator] Generando datos LLM...");const n={metadata:{generatedAt:(new Date).toISOString(),totalNodes:e.length,diagramTitle:t.title||"Diagrama",dataSource:"CSV",version:"1.0"},nodes:this.processNodes(e),clusters:this.identifyClusters(e),relationships:this.extractRelationships(e),summary:this.generateSummary(e,t)},i=this.generateLLMText(n);this.storeData(n,i),console.log("[LLMDataGenerator] Datos LLM generados y almacenados exitosamente")}catch(Ti){console.error("[LLMDataGenerator] Error generando datos LLM:",Ti)}}processNodes(e){return e.map((e,t)=>({id:e.id||e.Id||e.Node||`node_${t}`,name:e.name||e.Name||e.title||"Sin nombre",type:e.type||e.Type||"default",icon:e.icon||e.Icon||"detail",parent:e.parent||e.Parent||null,img:e.img||e.Img||null,description:e.description||e.Description||"",category:e.category||e.Category||"",status:e.status||e.Status||"active",priority:e.priority||e.Priority||"medium",tags:e.tags||e.Tags||"",url:e.url||e.Url||e.link||e.Link||"",notes:e.notes||e.Notes||"",...this.extractAdditionalFields(e)}))}extractAdditionalFields(e){const t={},n=["id","Id","Node","name","Name","title","type","Type","icon","Icon","parent","Parent","img","Img","description","Description","category","Category","status","Status","priority","Priority","tags","Tags","url","Url","link","Link","notes","Notes"];return Object.keys(e).forEach(i=>{n.includes(i)||void 0===e[i]||""===e[i]||(t[i]=e[i])}),t}identifyClusters(e){const t={};return e.forEach(n=>{const i=n.parent||n.Parent;i&&(t[i]||(t[i]={id:i,name:this.findParentName(e,i),children:[],childCount:0}),t[i].children.push(n.id||n.Id||n.Node),t[i].childCount++)}),Object.values(t)}findParentName(e,t){const n=e.find(e=>(e.id||e.Id||e.Node)===t);return n&&(n.name||n.Name||n.title)||t}extractRelationships(e){const t=[];return e.forEach(e=>{const n=e.parent||e.Parent,i=e.id||e.Id||e.Node;n&&i&&t.push({from:n,to:i,type:"parent-child",relationship:"hierarchy"})}),t}generateSummary(e,t){const n=e.length,i=e.filter(e=>e.parent||e.Parent).length,r=n-i,o={},a={},s={};return e.forEach(e=>{const t=e.category||e.Category||"Sin categora",n=e.type||e.Type||"default",i=e.status||e.Status||"active";o[t]=(o[t]||0)+1,a[n]=(a[n]||0)+1,s[i]=(s[i]||0)+1}),{totalNodes:n,rootNodes:r,childNodes:i,categories:Object.keys(o).length,types:Object.keys(a).length,statuses:Object.keys(s).length,topCategories:Object.entries(o).sort(([,e],[,t])=>t-e).slice(0,5).map(([e,t])=>({name:e,count:t})),topTypes:Object.entries(a).sort(([,e],[,t])=>t-e).slice(0,5).map(([e,t])=>({name:e,count:t}))}}generateLLMText(e){let t=`# ${e.metadata.diagramTitle}\n\n`;return t+="## Resumen del Diagrama\n",t+=`- Total de nodos: ${e.summary.totalNodes}\n`,t+=`- Nodos raz: ${e.summary.rootNodes}\n`,t+=`- Nodos hijos: ${e.summary.childNodes}\n`,t+=`- Categoras: ${e.summary.categories}\n`,t+=`- Tipos: ${e.summary.types}\n\n`,t+="## Categoras Principales\n",e.summary.topCategories.forEach(e=>{t+=`- ${e.name}: ${e.count} nodos\n`}),t+="\n",t+="## Tipos Principales\n",e.summary.topTypes.forEach(e=>{t+=`- ${e.name}: ${e.count} nodos\n`}),t+="\n",t+="## Clusters y Jerarquas\n",e.clusters.forEach(e=>{t+=`### Cluster: ${e.name} (ID: ${e.id})\n`,t+=`- Nodos hijos: ${e.childCount}\n`,t+=`- IDs de hijos: ${e.children.join(", ")}\n\n`}),t+="## Nodos Detallados\n",e.nodes.forEach(e=>{t+=`### ${e.name} (ID: ${e.id})\n`,t+=`- Tipo: ${e.type}\n`,t+=`- Icono: ${e.icon}\n`,e.parent&&(t+=`- Padre: ${e.parent}\n`),e.description&&(t+=`- Descripcin: ${e.description}\n`),e.category&&(t+=`- Categora: ${e.category}\n`),e.status&&(t+=`- Estado: ${e.status}\n`),e.priority&&(t+=`- Prioridad: ${e.priority}\n`),e.tags&&(t+=`- Etiquetas: ${e.tags}\n`),e.url&&(t+=`- URL: ${e.url}\n`),e.notes&&(t+=`- Notas: ${e.notes}\n`),Object.keys(e).forEach(n=>{["id","name","type","icon","parent","img","description","category","status","priority","tags","url","notes"].includes(n)||(t+=`- ${n}: ${e[n]}\n`)}),t+="\n"}),t+="## Relaciones\n",e.relationships.forEach(e=>{t+=`- ${e.from}  ${e.to} (${e.type})\n`}),t+="\n---\n",t+=`Generado automticamente el ${e.metadata.generatedAt}\n`,t+=`Fuente: ${e.metadata.dataSource}\n`,t}storeData(e,t){try{localStorage.setItem(this.storageKey,JSON.stringify(e)),localStorage.setItem(`${this.storageKey}_text`,t),localStorage.setItem(this.lastUpdateKey,Date.now().toString()),console.log("[LLMDataGenerator] Datos almacenados en localStorage")}catch(Ti){console.error("[LLMDataGenerator] Error almacenando datos:",Ti)}}getStoredData(){try{const e=localStorage.getItem(this.storageKey),t=localStorage.getItem(`${this.storageKey}_text`);return e&&t?{structured:JSON.parse(e),text:t}:null}catch(Ti){return console.error("[LLMDataGenerator] Error obteniendo datos almacenados:",Ti),null}}scheduleBackgroundUpdate(e,t){setInterval(()=>{this.shouldUpdateData()&&(console.log("[LLMDataGenerator] Actualizacin en segundo plano..."),this.generateLLMData(e,t))},this.updateInterval)}clearStoredData(){try{localStorage.removeItem(this.storageKey),localStorage.removeItem(`${this.storageKey}_text`),localStorage.removeItem(this.lastUpdateKey),console.log("[LLMDataGenerator] Datos limpiados de localStorage")}catch(Ti){console.error("[LLMDataGenerator] Error limpiando datos:",Ti)}}exportLLMFile(){try{const e=this.getStoredData();if(!e)return void console.warn("[LLMDataGenerator] No hay datos para exportar");const t=new Blob([e.text],{type:"text/markdown"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download="context.md",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n),console.log("[LLMDataGenerator] Archivo context.md exportado")}catch(Ti){console.error("[LLMDataGenerator] Error exportando archivo:",Ti)}}}class Ci{constructor(e){this.config={url:null,title:"Diagrams",logo:"img/logo.svg",spacing:80,verticalSpacing:170,linearSpacing:30,branchedSpacing:80,nodeWidth:100,nodeHeight:125,treeSpacing:100,clustersPerRow:"4 5 5 5",clusterGapX:120,clusterGapY:120,defaultIcon:"detail",showThemeToggle:!1,transitionDuration:{click:1e3,tab:1500,reset:3e3,resize:300},initialZoom:{scale:.95,padding:.05},fitOnResize:!0,textConfig:{maxWidth:80,maxLines:2,fontSize:8,nodeNameFontSize:9,lineHeight:1.2,fontFamily:"Arial, sans-serif",textAnchor:"middle",dominantBaseline:"middle",ellipsis:"...",fontWeight:"bold"},linkConfig:{cornerRadius:8,verticalTolerance:5},selectedNode:{stroke:"#007bff",strokeWidth:6,fill:"#E0FFFF"},enableNavigationLogs:!1,privateApi:!1,...e},this.globalTrees=[],this.globalContainer=null,this.clusterPositions=new Map,this.thumbs=new ti({defaultIcon:this.config.defaultIcon}),this.uiManager=new yi({thumbsSystem:this.thumbs}),this.svgManager=new xi,this.textHandler=new ni(this.config.textConfig),this.navigation=new ui(this),this.loader=new Gn,this.diagramRenderer=new vi(this),this.hierarchyBuilder=new wi,this.diagramManager=new bi(this),this.llmDataGenerator=new _i,this.svgManager.ensureDiagramHidden(),this.diagramManager.setupEventListeners()}async initDiagram(){return this.diagramManager.initDiagram()}clearCacheAndReload(){return this.diagramManager.clearCacheAndReload()}async reloadDiagram(){return this.diagramManager.reloadDiagram()}calculateDiagramBounds(){return this.diagramRenderer.calculateDiagramBounds()}zoomToNode(e,t,n=!1){return this.diagramRenderer.zoomToNode(e,t,n)}applyInitialZoomImmediate(e,t,n){return this.diagramRenderer.applyInitialZoomImmediate(e,t,n)}getCurrentZoom(){return this.navigation.getCurrentZoom()}createDiagram(){return this.svgManager.createDiagram()}ensureDiagramHidden(){return this.svgManager.ensureDiagramHidden()}showDiagram(){return this.svgManager.showDiagram()}hideDiagram(){return this.svgManager.hideDiagram()}clearDiagram(){return this.svgManager.clearDiagram()}getDiagram(){return this.svgManager.getDiagram()}getContainer(){return this.svgManager.getContainer()}getDiagramDimensions(){return this.svgManager.getDiagramDimensions()}renderText(e,t,n={}){return this.textHandler.renderText(e,t,n)}renderNodeText(e,t,n,i,r={}){return this.textHandler.renderNodeText(e,t,n,i,r)}renderNodeTextCentered(e,t,n,i,r={}){return this.textHandler.renderNodeTextCentered(e,t,n,i,r)}updateTextConfig(e){return this.textHandler.updateConfig(e)}updateInfoPanel(e){return this.uiManager.updateInfoPanel(e)}openInfoPanel(e,t={}){return this.uiManager.openInfoPanel(e,t)}closeInfoPanel(){return this.uiManager.closeInfoPanel()}get svgManagerInstance(){return this.svgManager}get textHandlerInstance(){return this.textHandler}get uiManagerInstance(){return this.uiManager}get diagramManagerInstance(){return this.diagramManager}get llmDataGeneratorInstance(){return this.llmDataGenerator}}class Ii{constructor(e={}){this.currentTheme="dark",this.storageKey="xdiagrams-theme",this.showThemeToggle=!1!==e.showThemeToggle,this.init()}init(){this.loadSavedTheme(),this.applyTheme(this.currentTheme),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this.createThemeToggle()}):this.createThemeToggle(),setTimeout(()=>{document.getElementById("theme-toggle")||this.createThemeToggle()},500),this.integrateWithXDiagrams()}loadSavedTheme(){try{const e=localStorage.getItem(this.storageKey);!e||"light"!==e&&"dark"!==e?window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(this.currentTheme="dark"):this.currentTheme=e}catch(Ti){console.warn("No se pudo cargar el tema guardado:",Ti)}}clearSavedTheme(){try{localStorage.removeItem(this.storageKey),this.currentTheme="dark",this.applyTheme("dark"),console.log(" Tema guardado limpiado, aplicando tema dark por defecto")}catch(Ti){console.warn("No se pudo limpiar el tema guardado:",Ti)}}createThemeToggle(){if(!this.showThemeToggle)return;if(document.getElementById("theme-toggle"))return;let e=document.querySelector(".theme-controls");if(e||(e=document.createElement("div"),e.className="theme-controls",e.style.position="fixed",e.style.top="20px",e.style.right="20px",e.style.zIndex="1000",document.body.appendChild(e)),e.querySelector("#theme-toggle"))return;const t=document.createElement("button");t.id="theme-toggle",t.className="theme-toggle",t.title="Cambiar tema",t.innerHTML='\n      <svg class="theme-icon sun-icon" width="18" height="18" viewBox="0 0 24 24">\n        <circle cx="12" cy="12" r="4" fill="currentColor"></circle>\n        <g stroke="currentColor" stroke-width="2" stroke-linecap="round">\n          <line x1="12" y1="1" x2="12" y2="3"></line>\n          <line x1="12" y1="21" x2="12" y2="23"></line>\n          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>\n          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>\n          <line x1="1" y1="12" x2="3" y2="12"></line>\n          <line x1="21" y1="12" x2="23" y2="12"></line>\n          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>\n          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>\n        </g>\n      </svg>\n      <svg class="theme-icon moon-icon" width="18" height="18" viewBox="0 0 24 24">\n        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor"></path>\n      </svg>\n    ',t.addEventListener("click",()=>{this.toggleTheme()}),t.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),this.toggleTheme())}),e.appendChild(t)}toggleTheme(){const e="light"===this.currentTheme?"dark":"light";this.setTheme(e)}setTheme(e){if("light"===e||"dark"===e){this.currentTheme=e;try{localStorage.setItem(this.storageKey,e)}catch(Ti){console.warn("No se pudo guardar el tema:",Ti)}this.applyTheme(e)}else console.warn("Tema no vlido:",e)}applyTheme(e){document.body.classList.remove("theme-light","theme-dark"),document.body.classList.add(`theme-${e}`),this.updateToggleButton(e),this.dispatchThemeChangeEvent(e)}updateToggleButton(e){const t=document.getElementById("theme-toggle");t&&("dark"===e?t.classList.add("dark-mode"):t.classList.remove("dark-mode"))}setThemeToggleVisibility(e){this.showThemeToggle=e;const t=document.getElementById("theme-toggle"),n=document.querySelector(".theme-controls");e?(t||this.createThemeToggle(),n&&(n.style.display="flex")):(t&&t.remove(),n&&(n.style.display="none"))}dispatchThemeChangeEvent(e){const t=new CustomEvent("themechange",{detail:{theme:e}});document.dispatchEvent(t)}getCurrentTheme(){return this.currentTheme}isLightTheme(){return"light"===this.currentTheme}isDarkTheme(){return"dark"===this.currentTheme}integrateWithXDiagrams(){document.addEventListener("diagram-ready",()=>{this.ensureToggleVisibility()}),"complete"===document.readyState?this.ensureToggleVisibility():window.addEventListener("load",()=>{this.ensureToggleVisibility()})}ensureToggleVisibility(){const e=document.getElementById("theme-toggle");e&&(e.style.display="flex",e.style.visibility="visible",e.style.opacity="1")}}function Ei(e={}){const t=new Ii(e);return window.ThemeManager=t,t}if("undefined"!=typeof window&&!window.ThemeManager){Ei({showThemeToggle:!1!==(window.$xDiagrams||{}).showThemeToggle})}if("undefined"!=typeof window){let e=function(){const e=window.$xDiagrams||{};if(Object.keys(e).length>0)try{const t=new Ci(e);t.initDiagram(),window.$xDiagrams={...e,instance:t,navigation:t.navigation,core:t,uiManager:t.uiManager,themeManager:n,getLLMData:()=>t.core.llmDataGenerator.getStoredData(),exportLLMFile:()=>t.core.llmDataGenerator.exportLLMFile(),clearLLMData:()=>t.core.llmDataGenerator.clearStoredData()},t.navigation.setupResizeHandler()}catch(Ti){console.error(" [XDiagrams] Error al inicializar diagrama:",Ti)}};window.XDiagramsLoader=Gn,window.XDiagramsCache=Kn,window.XDiagramsThumbs=ti,window.XDiagramsTextHandler=ni,window.XDiagramsNavigation=ui,window.XDiagramsUIManager=yi,window.XDiagrams=Ci;const t=window.$xDiagrams||{};window.xDiagramsLoader=new Gn({disableCache:t.disableCache||!1});const n=Ei({showThemeToggle:!1!==t.showThemeToggle});window.ThemeManager=n,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}e.ThemeManager=Ii,e.XDiagrams=Ci,e.XDiagramsCache=Kn,e.XDiagramsLoader=Gn,e.XDiagramsNavigation=ui,e.XDiagramsTextHandler=ni,e.XDiagramsThumbs=ti,e.XDiagramsUIManager=yi,e.initThemes=Ei,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
