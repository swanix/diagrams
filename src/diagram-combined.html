<!DOCTYPE html>
<html lang="es" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama Combinado - Swanix</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="sw-diagrams.js"></script>
    <link href="sw-diagrams.css" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        
        .container {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: var(--topbar-bg, #fff);
            border-bottom: 1px solid var(--sidepanel-border, #ddd);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            color: var(--text-color, #333);
            font-size: 1.5rem;
        }
        
        .header-info {
            color: var(--text-color, #666);
            font-size: 0.9rem;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .control-btn {
            background: var(--control-bg, #fff);
            color: var(--control-text, #333);
            border: 1px solid var(--control-border, #d1d5db);
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .control-btn:hover {
            background: var(--control-bg, #fff);
            border-color: var(--control-border-hover, #9ca3af);
            box-shadow: 0 2px 8px var(--control-shadow, rgba(0,0,0,0.1));
        }
        
        .control-btn.primary {
            background: var(--node-selection-focus, #1976d2);
            color: #fff;
            border-color: var(--node-selection-focus, #1976d2);
        }
        
        .control-btn.primary:hover {
            background: var(--node-selection-focus, #1565c0);
            border-color: var(--node-selection-focus, #1565c0);
        }
        
        .theme-selector {
            background: var(--control-bg, #fff);
            border: 1px solid var(--control-border, #d1d5db);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.9rem;
            color: var(--control-text, #333);
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0,0,0,0.1);
            border-left: 5px solid var(--node-selection-focus, #1976d2);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: var(--text-color, #666);
            font-size: 1.1rem;
            text-align: center;
        }
        
        .progress-bar {
            width: 300px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--node-selection-focus, #1976d2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        #svg-container {
            width: 100%;
            height: 100%;
            background: var(--bg-color, #f6f7f9);
        }
        
        #main-svg {
            width: 100%;
            height: 100%;
            opacity: 1 !important;
        }
        
        #main-svg * {
            opacity: 1 !important;
        }
        
        /* Forzar visibilidad de elementos del diagrama */
        .node {
            opacity: 1 !important;
        }
        
        .link {
            opacity: 1 !important;
        }
        
        .node rect {
            opacity: 1 !important;
        }
        
        .node text {
            opacity: 1 !important;
        }
        
        .node image {
            opacity: 1 !important;
        }
        
        /* Estilos para t√≠tulos de diagramas */
        .diagram-title {
            opacity: 1 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .diagram-group {
            opacity: 1 !important;
        }
        
        /* Estilos del sidepanel */
        .side-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 350px;
            height: 100vh;
            background: var(--side-panel-bg, #fff);
            border-left: 1px solid var(--side-panel-border, #e0e0e0);
            box-shadow: -2px 0 10px var(--side-panel-shadow, rgba(0, 0, 0, 0.1));
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        .side-panel.open {
            right: 0;
        }
        
        .side-panel-header {
            padding: 20px;
            background: var(--side-panel-header-bg, #f8f9fa);
            border-bottom: 1px solid var(--side-panel-header-border, #dee2e6);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .side-panel-title {
            margin: 0;
            color: var(--side-panel-text, #222);
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .side-panel-close {
            background: var(--side-panel-close-bg, #dc3545);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        
        .side-panel-close:hover {
            background: var(--side-panel-close-hover, #c82333);
        }
        
        .side-panel-content {
            padding: 20px;
        }
        
        .side-panel-fields-table {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .side-panel-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .side-panel-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--side-panel-label, #666);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .side-panel-value {
            font-size: 1rem;
            color: var(--side-panel-value, #222);
            padding: 8px 12px;
            background: var(--control-bg, #f8f9fa);
            border: 1px solid var(--control-border, #d1d5db);
            border-radius: 6px;
            min-height: 20px;
        }
        
        .side-panel-value.empty {
            color: var(--text-color, #999);
            font-style: italic;
        }
        
        .side-panel-url {
            color: var(--node-selection-focus, #1976d2);
            text-decoration: none;
            word-break: break-all;
        }
        
        .side-panel-url:hover {
            text-decoration: underline;
        }
        
        .thumbnail-selector-dropdown {
            padding: 8px 12px;
            border: 1px solid var(--control-border, #d1d5db);
            border-radius: 6px;
            background: var(--control-bg, #fff);
            color: var(--control-text, #333);
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .thumbnail-selector-dropdown:hover {
            border-color: var(--control-border-hover, #9ca3af);
        }
        
        .thumbnail-selector-dropdown:focus {
            outline: none;
            border-color: var(--node-selection-focus, #1976d2);
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
        }
        
        .status-active {
            color: #4ade80;
            font-weight: 600;
        }
        
        .status-inactive {
            color: #f87171;
            font-weight: 600;
        }
        
        .priority-critical {
            color: #f87171;
            font-weight: 600;
        }
        
        .priority-high {
            color: #fb923c;
            font-weight: 600;
        }
        
        .priority-medium {
            color: #fbbf24;
            font-weight: 600;
        }
        
        .priority-low {
            color: #4ade80;
            font-weight: 600;
        }
        
        /* Estilos para nodos seleccionados */
        .node.node-selected rect {
            stroke: var(--node-selection-focus, #1976d2) !important;
            stroke-width: 3px !important;
            animation: node-pulse 2s infinite;
        }
        
        @keyframes node-pulse {
            0% { stroke-width: 3px; }
            50% { stroke-width: 5px; }
            100% { stroke-width: 3px; }
        }
        
        /* Estilos para diagramas separados */
        .diagram-container {
            opacity: 1 !important;
            position: relative;
        }
        
        .cluster {
            stroke: var(--cluster-border-color, var(--control-border, #d1d5db));
            stroke-width: var(--cluster-border-width, 1.5px);
            stroke-dasharray: var(--cluster-border-dash, 8,4);
            fill: var(--cluster-bg-color, rgba(0, 0, 0, 0.05));
            opacity: var(--cluster-opacity, 0.8);
            pointer-events: none;
        }
        
        /* Estilos para nodos ra√≠z (clusters) que encierran a todos sus hijos */
        .node-cluster {
            stroke: var(--cluster-border-color, var(--control-border, #d1d5db)) !important;
            stroke-width: var(--cluster-border-width, 2px) !important;
            stroke-dasharray: var(--cluster-border-dash, 5,3) !important;
            fill: var(--cluster-bg-color, rgba(0, 0, 0, 0.03)) !important;
            opacity: var(--cluster-opacity, 0.9) !important;
        }
        
        .node-cluster:hover {
            stroke: var(--cluster-border-hover, var(--node-selection-focus, #1976d2)) !important;
            stroke-width: var(--cluster-border-width-hover, 3px) !important;
            fill: var(--cluster-bg-hover, rgba(0, 0, 0, 0.08)) !important;
        }
        
        .diagram-title {
            opacity: 1 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px !important;
            font-weight: bold !important;
            fill: var(--text-color, #333) !important;
            text-anchor: start;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            pointer-events: none;
        }
        
        .diagram-group {
            opacity: 1 !important;
        }
        
        /* Estilos para nodos de diferentes fuentes */
        .node[data-source] {
            position: relative;
        }
        
        .node[data-source]::after {
            content: attr(data-source);
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--node-selection-focus, #1976d2);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 8px;
            font-weight: bold;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üåê Diagrama Combinado - Demo Sources</h1>
                <div class="header-info">
                    <span id="node-count">0</span> nodos de <span id="source-count">0</span> fuentes (mismas que demo-multi-diagram.html)
                </div>
            </div>
            <div class="controls">
                <button class="control-btn" onclick="resetZoom()">üîç Reset Zoom</button>
                <button class="control-btn" onclick="centerDiagram()">üéØ Centrar</button>
                <button class="control-btn primary" onclick="exportData()">üìä Exportar</button>
                <select id="theme-selector" class="theme-selector">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="vintage">Vintage</option>
                    <option value="pastel">Pastel</option>
                    <option value="cyberpunk">Cyberpunk</option>
                    <option value="neon">Neon</option>
                </select>
            </div>
        </div>

        <div class="loading-overlay" id="loading-overlay">
            <div class="spinner"></div>
            <div class="loading-text" id="loading-text">Cargando diagramas...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>

        <div id="svg-container">
            <svg id="main-svg" width="100%" height="100%"></svg>
        </div>
    </div>

    <script>
        // Lista de diagramas a combinar (mismas fuentes que demo-multi-diagram.html)
        const diagrams = [
            {
                name: "Org Chart (Google Sheets)",
                url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTQZfZhC3cWHg0QkqRoY9i3alinAnSHab5DJtWzsm_xAhLKKJdHri8fBMUawh-DhpvCkm-G1vBeWPFq/pub?gid=466976322&single=true&output=csv",
                type: "external"
            },
            {
                name: "Tree Simple (Local)",
                url: "./data/tree-simple.csv",
                type: "local"
            },
            {
                name: "Company Structure (Local)",
                url: "./data/company-structure.csv",
                type: "local"
            },
            {
                name: "Sample Diagram (Local)",
                url: "./data/sample-diagram.csv",
                type: "local"
            },
            {
                name: "Sitemap Demo (Local)",
                url: "../docs/demo/sitemap/data/sitemap.csv",
                type: "local"
            }
        ];

        let allNodes = [];
        let allLinks = [];
        let combinedHierarchy = null;
        let diagramZoom = null;

        // Funci√≥n para cargar todos los diagramas
        async function loadAllDiagrams() {
            console.log('Iniciando carga de todos los diagramas...');
            const loadingText = document.getElementById('loading-text');
            const progressFill = document.getElementById('progress-fill');
            
            allNodes = [];
            allLinks = [];
            let loadedCount = 0;
            let totalNodes = 0;
            
            for (let i = 0; i < diagrams.length; i++) {
                const diagram = diagrams[i];
                const progress = ((i + 1) / diagrams.length) * 100;
                
                loadingText.textContent = `Cargando ${diagram.name}... (${i + 1}/${diagrams.length})`;
                progressFill.style.width = `${progress}%`;
                
                try {
                    console.log(`Cargando diagrama ${i + 1}:`, diagram.name);
                    const data = await loadCSV(diagram.url);
                    const nodes = buildNodesFromData(data, diagram.name);
                    allNodes.push(...nodes);
                    loadedCount++;
                    totalNodes += nodes.length;
                    
                    console.log(`‚úÖ Diagrama ${diagram.name} cargado:`, nodes.length, 'nodos');
                    loadingText.textContent = `‚úÖ ${diagram.name} cargado (${nodes.length} nodos)`;
                } catch (error) {
                    console.error(`‚ùå Error al cargar ${diagram.name}:`, error);
                    loadingText.textContent = `‚ùå Error en ${diagram.name}, continuando...`;
                    // Continuar con el siguiente diagrama
                }
                
                // Peque√±a pausa entre cargas para evitar sobrecarga
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            console.log('üéâ Carga completada. Diagramas cargados:', loadedCount, 'de', diagrams.length);
            console.log('üìä Total de nodos cargados:', totalNodes);
            
            if (allNodes.length === 0) {
                loadingText.textContent = '‚ö†Ô∏è No se pudieron cargar diagramas. Creando diagrama de ejemplo...';
                // Crear un diagrama de ejemplo si no se carg√≥ nada
                createFallbackDiagram();
            } else {
                loadingText.textContent = `üéØ Creando diagrama combinado con ${totalNodes} nodos...`;
                createCombinedHierarchy();
            }
        }

        // Funci√≥n para cargar CSV
        function loadCSV(url) {
            return new Promise((resolve, reject) => {
                console.log('Intentando cargar CSV desde:', url);
                
                Papa.parse(url, {
                    download: true,
                    header: true,
                    complete: function(results) {
                        console.log('CSV parseado:', results.data.length, 'filas');
                        if (results.errors.length > 0) {
                            console.warn('Errores en CSV:', results.errors);
                            // Si hay errores pero hay datos, continuar
                            if (results.data.length > 0) {
                                resolve(results.data);
                            } else {
                                reject(new Error(`Errores en CSV: ${results.errors.map(e => e.message).join(', ')}`));
                            }
                        } else {
                            resolve(results.data);
                        }
                    },
                    error: function(err) {
                        console.error('Error al cargar CSV:', err);
                        reject(err);
                    }
                });
            });
        }
        
        // Funci√≥n para crear diagrama de fallback
        function createFallbackDiagram() {
            console.log('Creando diagrama de fallback...');
            
            const fallbackData = [
                { id: "1", name: "Nodo Ra√≠z", parent: "" },
                { id: "2", name: "Hijo 1", parent: "1" },
                { id: "3", name: "Hijo 2", parent: "1" },
                { id: "4", name: "Nieto 1", parent: "2" },
                { id: "5", name: "Nieto 2", parent: "2" }
            ];
            
            const nodes = buildNodesFromData(fallbackData, "Fallback");
            allNodes = nodes;
            
            console.log('Diagrama de fallback creado:', nodes.length, 'nodos');
            createCombinedHierarchy();
        }

        // Funci√≥n para construir nodos desde datos CSV
        function buildNodesFromData(data, sourceName) {
            console.log(`Construyendo nodos para ${sourceName} con ${data.length} filas`);
            console.log('Primeras 3 filas de ejemplo:', data.slice(0, 3));
            
            const nodes = [];
            const nodeMap = new Map();
            
            // Primera pasada: crear todos los nodos
            data.forEach((d, index) => {
                // Mapear columnas de diferentes formatos
                const id = d.Node?.trim() || d.id?.trim() || d.ID?.trim() || `node_${sourceName}_${index}`;
                const name = d.Name?.trim() || d.name?.trim() || d.NAME?.trim() || "Nodo sin nombre";
                const subtitle = d.Description?.trim() || d.subtitle?.trim() || d.Subtitle?.trim() || "";
                const type = d.Type?.trim() || d.type?.trim() || "detail";
                const url = d.url?.trim() || d.URL?.trim() || "";
                const parent = d.Parent?.trim() || d.parent?.trim() || "";
                
                // Crear ID √∫nico para evitar conflictos entre fuentes
                const uniqueId = `${sourceName}_${id}`;
                
                const node = {
                    id: uniqueId,
                    name: name,
                    subtitle: subtitle,
                    type: type,
                    url: url,
                    parent: parent ? `${sourceName}_${parent}` : null,
                    source: sourceName,
                    originalData: d
                };
                
                nodes.push(node);
                nodeMap.set(node.id, node);
            });
            
            // Segunda pasada: establecer relaciones padre-hijo
            let childrenCount = 0;
            nodes.forEach(node => {
                if (node.parent && nodeMap.has(node.parent)) {
                    const parentNode = nodeMap.get(node.parent);
                    if (!parentNode.children) parentNode.children = [];
                    parentNode.children.push(node);
                    childrenCount++;
                }
            });
            
            // Retornar solo los nodos ra√≠z
            const rootNodes = nodes.filter(node => !node.parent);
            console.log(`‚úÖ ${sourceName}: ${rootNodes.length} nodos ra√≠z, ${childrenCount} relaciones padre-hijo`);
            
            return rootNodes;
        }

        // Funci√≥n para crear la jerarqu√≠a combinada
        function createCombinedHierarchy() {
            console.log('üåê Creando diagramas separados...');
            
            // Agrupar nodos por fuente
            const nodesBySource = {};
            allNodes.forEach(node => {
                if (!nodesBySource[node.source]) {
                    nodesBySource[node.source] = [];
                }
                nodesBySource[node.source].push(node);
            });
            
            console.log('üìä Nodos agrupados por fuente:', Object.keys(nodesBySource).map(source => ({
                source,
                count: nodesBySource[source].length
            })));
            
            // Crear m√∫ltiples jerarqu√≠as separadas (sin espaciado inicial)
            const hierarchies = [];
            
            Object.keys(nodesBySource).forEach((sourceName, index) => {
                const sourceNodes = nodesBySource[sourceName];
                
                // Crear jerarqu√≠a para esta fuente
                const hierarchy = d3.hierarchy(sourceNodes[0]); // Usar el primer nodo como ra√≠z
                
                // Aplicar layout de √°rbol
                const treeLayout = d3.tree()
                    .nodeSize([120, 250]) // Aumentar separaci√≥n entre nodos
                    .separation((a, b) => 1.2); // Aumentar separaci√≥n entre hermanos
                
                treeLayout(hierarchy);
                
                hierarchies.push({
                    hierarchy: hierarchy,
                    source: sourceName,
                    xOffset: 0 // Se calcular√° despu√©s del renderizado
                });
            });
            
            // Guardar las jerarqu√≠as separadas
            combinedHierarchy = hierarchies;
            
            const totalNodes = hierarchies.reduce((sum, h) => sum + h.hierarchy.descendants().length, 0);
            const totalLinks = hierarchies.reduce((sum, h) => sum + h.hierarchy.links().length, 0);
            
            console.log(`‚úÖ Diagramas separados creados: ${hierarchies.length} diagramas, ${totalNodes} nodos totales, ${totalLinks} enlaces`);
            
            drawCombinedDiagram();
        }

        // Funci√≥n para dibujar el diagrama combinado
        function drawCombinedDiagram() {
            console.log('üé® Dibujando diagramas separados...');
            
            const svg = d3.select("#main-svg");
            svg.innerHTML = '';
            
            // Forzar opacidad del SVG
            svg.style('opacity', '1');
            
            const g = svg.append("g");
            
            // Primero renderizar todos los diagramas en sus posiciones originales
            combinedHierarchy.forEach((hierarchyData, index) => {
                const hierarchy = hierarchyData.hierarchy;
                const sourceName = hierarchyData.source;
                
                console.log(`üéØ Dibujando diagrama ${index + 1}: ${sourceName}`);
                
                // Crear grupo para este diagrama
                const diagramGroup = g.append("g")
                    .attr("class", "diagram-group")
                    .attr("data-source", sourceName);
                
                // Dibujar enlaces de este diagrama
                diagramGroup.selectAll(".link")
                    .data(hierarchy.links())
                    .enter().append("path")
                    .attr("class", "link")
                    .style("stroke", "var(--link-color, #999)")
                    .style("stroke-width", "2px")
                    .attr("d", d => `
                        M ${d.source.x} ${d.source.y}
                        V ${(d.source.y + d.target.y) / 2}
                        H ${d.target.x}
                        V ${d.target.y}
                    `);
                
                // Dibujar nodos de este diagrama
                const node = diagramGroup.selectAll(".node")
                    .data(hierarchy.descendants())
                    .enter().append("g")
                    .attr("class", d => {
                        // Aplicar clase node-cluster a nodos ra√≠z (sin padre)
                        const isRoot = !d.parent || d.parent.data.id === d.data.id;
                        return `node node-clickable ${isRoot ? 'node-cluster' : ''}`;
                    })
                    .attr("data-id", d => d.data.id)
                    .attr("data-source", d => d.data.source)
                    .attr("transform", d => `translate(${d.x},${d.y})`)
                    .on("click", function(event, d) {
                        console.log("Nodo clickeado:", d.data);
                        event.stopPropagation();
                        openSidePanel(d.data);
                    });
                
                // Rect√°ngulo del nodo
                node.append("rect")
                    .style("stroke", "var(--label-border, #bdbdbd)")
                    .style("fill", "var(--node-fill, #fff)")
                    .style("stroke-width", "var(--node-bg-stroke, 1px)")
                    .attr("x", d => {
                        // Nodos cluster (ra√≠z) ligeramente m√°s grandes
                        const isRoot = !d.parent || d.parent.data.id === d.data.id;
                        return isRoot ? -35 : -30;
                    })
                    .attr("y", d => {
                        const isRoot = !d.parent || d.parent.data.id === d.data.id;
                        return isRoot ? -25 : -20;
                    })
                    .attr("width", d => {
                        const isRoot = !d.parent || d.parent.data.id === d.data.id;
                        return isRoot ? 70 : 60;
                    })
                    .attr("height", d => {
                        const isRoot = !d.parent || d.parent.data.id === d.data.id;
                        return isRoot ? 50 : 40;
                    })
                    .attr("rx", 6)
                    .attr("ry", 6);
                
                // Im√°genes SVG
                node.each(function(d) {
                    const nodeSel = d3.select(this);
                    nodeSel.select('.thumbnail-container').remove();
                    nodeSel.select('image').remove();

                    const type = d.data.type || 'detail';
                    const svgPath = `img/${type}.svg?v=${Date.now()}`;

                    const imageElement = nodeSel.append("image")
                        .attr("xlink:href", svgPath)
                        .attr("x", d => {
                            // Ajustar posici√≥n de imagen para nodos cluster
                            const isRoot = !d.parent || d.parent.data.id === d.data.id;
                            return isRoot ? -22 : -20;
                        })
                        .attr("y", d => {
                            const isRoot = !d.parent || d.parent.data.id === d.data.id;
                            return isRoot ? -18 : -15;
                        })
                        .attr("class", "image-base image-filter")
                        .attr("width", d => {
                            const isRoot = !d.parent || d.parent.data.id === d.data.id;
                            return isRoot ? 44 : 40;
                        })
                        .attr("height", d => {
                            const isRoot = !d.parent || d.parent.data.id === d.data.id;
                            return isRoot ? 33 : 30;
                        })
                        .on("error", function() {
                            d3.select(this)
                                .attr("xlink:href", `img/detail.svg?v=${Date.now()}`);
                        });
                });
                
                // Texto del nodo
                node.append("text")
                    .text(d => d.data.name)
                    .attr("class", "custom-text label-text")
                    .attr("text-anchor", "middle")
                    .style("fill", "var(--text-color, #333)")
                    .style("font-size", "var(--label-font-size, 12px)")
                    .style("font-weight", "bold")
                    .attr("dy", 25)
                    .attr("x", 0);
            });
            
            // Ahora calcular el espaciado y mover los diagramas
            setTimeout(() => {
                applyDiagramSpacing();
                applyClusterStyles();
            }, 50);
        }
        
        // Funci√≥n para aplicar espaciado entre diagramas
        function applyDiagramSpacing() {
            console.log('üìè Aplicando espaciado entre diagramas...');
            
            const g = d3.select("#main-svg g");
            let currentXOffset = 0;
            const spacing = 200; // Espacio adicional entre diagramas
            
            combinedHierarchy.forEach((hierarchyData, index) => {
                const sourceName = hierarchyData.source;
                const diagramGroup = g.select(`[data-source="${sourceName}"]`);
                
                if (!diagramGroup.empty()) {
                    // Calcular bounds reales del diagrama renderizado
                    const bounds = diagramGroup.node().getBBox();
                    console.log(`üìä Bounds de ${sourceName}:`, bounds);
                    
                    // Calcular el offset necesario para este diagrama
                    const diagramWidth = bounds.width + 200; // Margen adicional
                    const xOffset = currentXOffset - bounds.x;
                    
                    // Mover todo el grupo del diagrama
                    diagramGroup.attr("transform", `translate(${xOffset}, 0)`);
                    
                    // Actualizar el offset para el siguiente diagrama
                    currentXOffset += diagramWidth + spacing;
                    
                    // Agregar recuadro del diagrama al fondo (primero para que est√© detr√°s)
                    const borderRect = diagramGroup.insert("rect", ":first-child")
                        .attr("class", "cluster")
                        .attr("x", bounds.x - 60)
                        .attr("y", bounds.y - 45)
                        .attr("width", bounds.width + 120)
                        .attr("height", bounds.height + 150)
                        .attr("rx", 10)
                        .attr("ry", 10)
                        .style("pointer-events", "none"); // Evitar que bloquee clics
                    
                    // Agregar t√≠tulo del diagrama en la esquina izquierda del recuadro
                    diagramGroup.append("text")
                        .attr("class", "diagram-title")
                        .attr("x", bounds.x - 45)
                        .attr("y", bounds.y - 20)
                        .attr("text-anchor", "start")
                        .style("pointer-events", "none") // Evitar que bloquee clics
                        .text(sourceName);
                    
                    console.log(`‚úÖ ${sourceName} movido a offset ${xOffset}, ancho: ${diagramWidth}`);
                }
            });
            
            // Configurar zoom despu√©s de aplicar el espaciado
            diagramZoom = d3.zoom()
                .scaleExtent([0.1, 5])
                .on("zoom", event => {
                    g.attr("transform", event.transform);
                });
            
            d3.select("#main-svg").call(diagramZoom);
            
            // Aplicar zoom autom√°tico
            setTimeout(() => {
                applyAutoZoom();
                updateCounters();
                hideLoading();
                
                // Forzar opacidad de todos los elementos del diagrama
                forceDiagramOpacity();
            }, 100);
        }
        
        // Funci√≥n para aplicar estilos especiales a nodos cluster
        function applyClusterStyles() {
            console.log('üé® Aplicando estilos de cluster...');
            
            // Identificar nodos que son clusters (nodos ra√≠z con muchos hijos)
            combinedHierarchy.forEach((hierarchyData, index) => {
                const hierarchy = hierarchyData.hierarchy;
                const sourceName = hierarchyData.source;
                
                // Encontrar nodos ra√≠z que tienen muchos hijos (clusters)
                const rootNodes = hierarchy.descendants().filter(d => !d.parent || d.parent.data.id === d.data.id);
                
                rootNodes.forEach(rootNode => {
                    const childCount = rootNode.children ? rootNode.children.length : 0;
                    
                    // Si tiene m√°s de 2 hijos, considerarlo un cluster
                    if (childCount > 2) {
                        console.log(`üéØ Nodo cluster detectado: ${rootNode.data.name} con ${childCount} hijos`);
                        
                        // Aplicar estilos especiales al rect√°ngulo del nodo
                        const nodeElement = d3.select(`[data-id="${rootNode.data.id}"]`);
                        if (!nodeElement.empty()) {
                            const rect = nodeElement.select('rect');
                            if (!rect.empty()) {
                                rect
                                    .style("stroke", "var(--cluster-border-color, var(--control-border, #d1d5db))")
                                    .style("stroke-width", "var(--cluster-border-width, 2px)")
                                    .style("stroke-dasharray", "var(--cluster-border-dash, 5,3)")
                                    .style("fill", "var(--cluster-bg-color, rgba(0, 0, 0, 0.03))")
                                    .style("opacity", "var(--cluster-opacity, 0.9)");
                            }
                        }
                    }
                });
            });
            
            console.log('‚úÖ Estilos de cluster aplicados');
        }

        // Funci√≥n para aplicar zoom autom√°tico
        function applyAutoZoom() {
            const svg = document.getElementById("main-svg");
            const g = d3.select("#main-svg g");
            
            // Forzar opacidad antes de aplicar zoom
            forceDiagramOpacity();
            
            // Calcular bounds de todos los diagramas
            let totalBounds = null;
            
            combinedHierarchy.forEach((hierarchyData, index) => {
                const diagramGroup = g.select(`[data-source="${hierarchyData.source}"]`);
                if (!diagramGroup.empty()) {
                    const bounds = diagramGroup.node().getBBox();
                    if (bounds.width > 0 && bounds.height > 0) {
                        if (!totalBounds) {
                            totalBounds = { x: bounds.x, y: bounds.y, width: bounds.width, height: bounds.height };
                        } else {
                            // Expandir bounds para incluir este diagrama
                            totalBounds.x = Math.min(totalBounds.x, bounds.x);
                            totalBounds.y = Math.min(totalBounds.y, bounds.y);
                            totalBounds.width = Math.max(totalBounds.x + totalBounds.width, bounds.x + bounds.width) - totalBounds.x;
                            totalBounds.height = Math.max(totalBounds.y + totalBounds.height, bounds.y + bounds.height) - totalBounds.y;
                        }
                    }
                }
            });
            
            const containerWidth = svg.clientWidth;
            const containerHeight = svg.clientHeight;
            
            console.log('Bounds totales de todos los diagramas:', totalBounds);
            console.log('Dimensiones del contenedor:', { containerWidth, containerHeight });
            
            if (totalBounds && totalBounds.width > 0 && totalBounds.height > 0) {
                const scale = Math.min(containerWidth / totalBounds.width, containerHeight / totalBounds.height) * 0.7;
                const translateX = containerWidth / 2 - (totalBounds.x + totalBounds.width / 2) * scale;
                const translateY = containerHeight / 2 - (totalBounds.y + totalBounds.height / 2) * scale;

                console.log('Transformaci√≥n aplicada:', { scale, translateX, translateY });

                const transform = d3.zoomIdentity
                    .translate(translateX, translateY)
                    .scale(scale);

                d3.select("#main-svg").call(diagramZoom.transform, transform);
                console.log('Zoom aplicado exitosamente a todos los diagramas');
            } else {
                console.warn('Bounds inv√°lidos, no se aplic√≥ zoom');
            }
        }

        // Funci√≥n para actualizar contadores
        function updateCounters() {
            const totalNodes = combinedHierarchy.reduce((sum, h) => sum + h.hierarchy.descendants().length, 0);
            const sourceCount = combinedHierarchy.length;
            
            document.getElementById('node-count').textContent = totalNodes;
            document.getElementById('source-count').textContent = sourceCount;
        }

        // Funci√≥n para ocultar loading
        function hideLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.classList.add('hidden');
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 300);
        }
        
        // Funci√≥n para forzar opacidad del diagrama
        function forceDiagramOpacity() {
            console.log('Forzando opacidad del diagrama...');
            
            // Forzar opacidad del SVG principal
            const mainSvg = document.getElementById('main-svg');
            if (mainSvg) {
                mainSvg.style.opacity = '1';
                console.log('Opacidad del SVG principal forzada a 1');
            }
            
            // Forzar opacidad de todos los elementos del diagrama
            d3.selectAll('#main-svg *').style('opacity', '1');
            
            // Forzar opacidad espec√≠fica de nodos y enlaces
            d3.selectAll('#main-svg .node').style('opacity', '1');
            d3.selectAll('#main-svg .link').style('opacity', '1');
            d3.selectAll('#main-svg rect').style('opacity', '1');
            d3.selectAll('#main-svg text').style('opacity', '1');
            d3.selectAll('#main-svg image').style('opacity', '1');
            
            console.log('Opacidad forzada para todos los elementos del diagrama');
        }

        // Funci√≥n para resetear zoom
        function resetZoom() {
            if (diagramZoom) {
                d3.select("#main-svg").call(diagramZoom.transform, d3.zoomIdentity);
            }
        }

        // Funci√≥n para centrar diagrama
        function centerDiagram() {
            applyAutoZoom();
        }

        // Funci√≥n para exportar datos
        function exportData() {
            const data = {
                nodes: allNodes,
                sources: diagrams.map(d => d.name),
                totalNodes: allNodes.length,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'diagrama-combinado.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Funciones del sidepanel
        function openSidePanel(nodeData) {
            console.log("Abriendo panel lateral para:", nodeData);
            const sidePanel = document.getElementById('side-panel');
            const content = document.getElementById('side-panel-content');

            if (!sidePanel || !content) {
                console.error("No se encontr√≥ el panel lateral o su contenido");
                return;
            }

            // Quitar selecci√≥n previa
            d3.selectAll('.node.node-selected').classed('node-selected', false);
            // Seleccionar el nodo actual por ID
            if (nodeData && nodeData.id) {
                d3.selectAll('.node').filter(d => d.data.id == nodeData.id).classed('node-selected', true);
            }

            // Llenar el contenido del panel
            content.innerHTML = generateSidePanelContent(nodeData);

            // Abrir el panel
            sidePanel.classList.add('open');
        }
        
        function closeSidePanel() {
            const sidePanel = document.getElementById('side-panel');

            if (!sidePanel) {
                console.warn("Panel lateral no encontrado al intentar cerrar");
                return;
            }

            // Quitar selecci√≥n de nodo
            d3.selectAll('.node.node-selected').classed('node-selected', false);

            // Cerrar el panel
            sidePanel.classList.remove('open');
        }
        
        function generateSidePanelContent(nodeData) {
            const fields = [
                { key: 'id', label: 'ID', type: 'text' },
                { key: 'name', label: 'Nombre', type: 'text' },
                { key: 'subtitle', label: 'Subt√≠tulo', type: 'text' },
                { key: 'type', label: 'Tipo', type: 'thumbnail-selector' },
                { key: 'url', label: 'URL', type: 'url' },
                { key: 'source', label: 'Fuente', type: 'text' },
                { key: 'description', label: 'Descripci√≥n', type: 'text' },
                { key: 'status', label: 'Estado', type: 'status' },
                { key: 'priority', label: 'Prioridad', type: 'priority' },
                { key: 'created_date', label: 'Fecha de Creaci√≥n', type: 'text' },
                { key: 'owner', label: 'Propietario', type: 'text' },
                { key: 'department', label: 'Departamento', type: 'text' },
            ];

            let html = '<div class="side-panel-fields-table">';
            
            fields.forEach(field => {
                html += `<div class="side-panel-field"><div class="side-panel-label">${field.label}</div><div class="side-panel-value">`;
                
                if (field.type === 'thumbnail-selector') {
                    html += `<select class="thumbnail-selector-dropdown" data-node-id="${nodeData.id}" title="Cambio persistente - se resetea al recargar">`;
                    html += `<option value="">Sin thumbnail</option>`;
                    
                    const thumbnails = ['document', 'settings', 'form', 'list', 'modal', 'mosaic', 'report', 'detail', 'file-csv', 'file-pdf', 'file-xls', 'file-xml'];
                    
                    thumbnails.forEach(thumbName => {
                        const selected = nodeData.type === thumbName ? 'selected' : '';
                        html += `<option value="${thumbName}" ${selected}>${thumbName}</option>`;
                    });
                    
                    html += `</select>`;
                } else if (nodeData[field.key] && nodeData[field.key] !== '') {
                    if (field.type === 'url') {
                        html += `<a class="side-panel-url" href="${nodeData[field.key]}" target="_blank">${nodeData[field.key]}</a>`;
                    } else if (field.type === 'status') {
                        html += `<span class="status-${nodeData[field.key].toLowerCase()}">${nodeData[field.key]}</span>`;
                    } else if (field.type === 'priority') {
                        html += `<span class="priority-${nodeData[field.key].toLowerCase()}">${nodeData[field.key]}</span>`;
                    } else {
                        html += nodeData[field.key];
                    }
                } else {
                    html += `<span class="empty">Sin datos</span>`;
                }
                
                html += '</div></div>';
            });
            
            html += '</div>';
            return html;
        }

        // Funci√≥n para crear el sidepanel
        function createSidePanel() {
            console.log("Creando panel lateral...");
            
            try {
                // Verificar si ya existe
                if (document.getElementById('side-panel')) {
                    console.log('Sidepanel ya existe');
                    return;
                }
                
                // Crear el panel lateral
                const sidePanel = document.createElement('div');
                sidePanel.className = 'side-panel';
                sidePanel.id = 'side-panel';
            
                sidePanel.innerHTML = `
                    <div class="side-panel-header">
                        <h3 class="side-panel-title">Detalles del Nodo</h3>
                        <button class="side-panel-close" onclick="closeSidePanel()">√ó</button>
                    </div>
                    <div class="side-panel-content" id="side-panel-content">
                        <!-- El contenido se llenar√° din√°micamente -->
                    </div>
                `;
                
                document.body.appendChild(sidePanel);
                console.log("Panel lateral creado exitosamente");
            } catch (error) {
                console.error("Error en createSidePanel:", error);
                throw error;
            }
        }
        
        // Funci√≥n para aplicar temas
        function setTheme(themeName) {
            console.log('Aplicando tema:', themeName);
            const root = document.documentElement;
            
            const themes = {
                light: {
                    '--bg-color': '#f6f7f9',
                    '--text-color': '#333',
                    '--control-bg': '#fff',
                    '--control-text': '#333',
                    '--control-border': '#d1d5db',
                    '--control-border-hover': '#9ca3af',
                    '--control-shadow': 'rgba(0,0,0,0.1)',
                    '--node-selection-focus': '#1976d2',
                    '--side-panel-bg': '#fff',
                    '--side-panel-border': '#e0e0e0',
                    '--side-panel-shadow': 'rgba(0, 0, 0, 0.1)',
                    '--side-panel-header-bg': '#f8f9fa',
                    '--side-panel-header-border': '#dee2e6',
                    '--side-panel-text': '#222',
                    '--side-panel-close-bg': '#dc3545',
                    '--side-panel-close-hover': '#c82333',
                    '--side-panel-label': '#666',
                    '--side-panel-value': '#222',
                    '--cluster-opacity': '0.8',
                    '--cluster-border-color': '#d1d5db',
                    '--cluster-border-width': '1.5px',
                    '--cluster-border-dash': '8,4',
                    '--cluster-bg-color': 'rgba(0, 0, 0, 0.05)',
                    '--cluster-border-hover': '#1976d2',
                    '--cluster-border-width-hover': '2px',
                    '--cluster-bg-hover': 'rgba(0, 0, 0, 0.08)',
                },
                dark: {
                    '--bg-color': '#1a1a1a',
                    '--text-color': '#fff',
                    '--control-bg': '#2d2d2d',
                    '--control-text': '#fff',
                    '--control-border': '#404040',
                    '--control-border-hover': '#606060',
                    '--control-shadow': 'rgba(0,0,0,0.3)',
                    '--node-selection-focus': '#4fc3f7',
                    '--side-panel-bg': '#2d2d2d',
                    '--side-panel-border': '#404040',
                    '--side-panel-shadow': 'rgba(0, 0, 0, 0.3)',
                    '--side-panel-header-bg': '#1a1a1a',
                    '--side-panel-header-border': '#404040',
                    '--side-panel-text': '#fff',
                    '--side-panel-close-bg': '#dc3545',
                    '--side-panel-close-hover': '#c82333',
                    '--side-panel-label': '#ccc',
                    '--side-panel-value': '#fff',
                    '--cluster-opacity': '0.8',
                    '--cluster-border-color': '#404040',
                    '--cluster-border-width': '1.5px',
                    '--cluster-border-dash': '8,4',
                    '--cluster-bg-color': 'rgba(255, 255, 255, 0.05)',
                    '--cluster-border-hover': '#4fc3f7',
                    '--cluster-border-width-hover': '2px',
                    '--cluster-bg-hover': 'rgba(255, 255, 255, 0.08)',
                },
                vintage: {
                    '--bg-color': '#f5e9da',
                    '--text-color': '#2c1810',
                    '--control-bg': '#f8f4e8',
                    '--control-text': '#2c1810',
                    '--control-border': '#d4c4a8',
                    '--control-border-hover': '#b8a890',
                    '--control-shadow': 'rgba(44, 24, 16, 0.1)',
                    '--node-selection-focus': '#8b4513',
                    '--side-panel-bg': '#f8f4e8',
                    '--side-panel-border': '#d4c4a8',
                    '--side-panel-shadow': 'rgba(44, 24, 16, 0.1)',
                    '--side-panel-header-bg': '#f0e6d4',
                    '--side-panel-header-border': '#d4c4a8',
                    '--side-panel-text': '#2c1810',
                    '--side-panel-close-bg': '#dc3545',
                    '--side-panel-close-hover': '#c82333',
                    '--side-panel-label': '#6b4423',
                    '--side-panel-value': '#2c1810',
                    '--cluster-opacity': '0.9',
                    '--cluster-border-color': '#d4c4a8',
                    '--cluster-border-width': '1.5px',
                    '--cluster-border-dash': '8,4',
                    '--cluster-bg-color': 'rgba(139, 69, 19, 0.05)',
                    '--cluster-border-hover': '#8b4513',
                    '--cluster-border-width-hover': '2px',
                    '--cluster-bg-hover': 'rgba(139, 69, 19, 0.08)',
                },
                pastel: {
                    '--bg-color': '#fdf6fb',
                    '--text-color': '#4a4a4a',
                    '--control-bg': '#fff',
                    '--control-text': '#4a4a4a',
                    '--control-border': '#e8b4d3',
                    '--control-border-hover': '#d18bb8',
                    '--control-shadow': 'rgba(216, 180, 211, 0.2)',
                    '--node-selection-focus': '#e91e63',
                    '--side-panel-bg': '#fff',
                    '--side-panel-border': '#e8b4d3',
                    '--side-panel-shadow': 'rgba(216, 180, 211, 0.2)',
                    '--side-panel-header-bg': '#fdf6fb',
                    '--side-panel-header-border': '#e8b4d3',
                    '--side-panel-text': '#4a4a4a',
                    '--side-panel-close-bg': '#ff6b9d',
                    '--side-panel-close-hover': '#e91e63',
                    '--side-panel-label': '#8e6b7b',
                    '--side-panel-value': '#4a4a4a',
                    '--cluster-opacity': '0.7',
                    '--cluster-border-color': '#e8b4d3',
                    '--cluster-border-width': '1.5px',
                    '--cluster-border-dash': '8,4',
                    '--cluster-bg-color': 'rgba(182, 182, 247, 0.05)',
                    '--cluster-border-hover': '#b6b6f7',
                    '--cluster-border-width-hover': '2px',
                    '--cluster-bg-hover': 'rgba(182, 182, 247, 0.08)',
                },
                cyberpunk: {
                    '--bg-color': '#0f0026',
                    '--text-color': '#00ff88',
                    '--control-bg': '#1a0033',
                    '--control-text': '#00ff88',
                    '--control-border': '#ff0080',
                    '--control-border-hover': '#ff40a0',
                    '--control-shadow': 'rgba(255, 0, 128, 0.3)',
                    '--node-selection-focus': '#00ff88',
                    '--side-panel-bg': '#1a0033',
                    '--side-panel-border': '#ff0080',
                    '--side-panel-shadow': 'rgba(255, 0, 128, 0.3)',
                    '--side-panel-header-bg': '#0f0026',
                    '--side-panel-header-border': '#ff0080',
                    '--side-panel-text': '#00ff88',
                    '--side-panel-close-bg': '#ff0080',
                    '--side-panel-close-hover': '#ff40a0',
                    '--side-panel-label': '#ff40a0',
                    '--side-panel-value': '#00ff88',
                    '--cluster-opacity': '0.9',
                    '--cluster-border-color': '#ff0080',
                    '--cluster-border-width': '1.5px',
                    '--cluster-border-dash': '8,4',
                    '--cluster-bg-color': 'rgba(0, 255, 136, 0.05)',
                    '--cluster-border-hover': '#00ff88',
                    '--cluster-border-width-hover': '2px',
                    '--cluster-bg-hover': 'rgba(0, 255, 136, 0.08)',
                },
                neon: {
                    '--bg-color': '#000',
                    '--text-color': '#fff',
                    '--control-bg': '#111',
                    '--control-text': '#fff',
                    '--control-border': '#0ff',
                    '--control-border-hover': '#0cc',
                    '--control-shadow': 'rgba(0, 255, 255, 0.3)',
                    '--node-selection-focus': '#0ff',
                    '--side-panel-bg': '#111',
                    '--side-panel-border': '#0ff',
                    '--side-panel-shadow': 'rgba(0, 255, 255, 0.3)',
                    '--side-panel-header-bg': '#000',
                    '--side-panel-header-border': '#0ff',
                    '--side-panel-text': '#fff',
                    '--side-panel-close-bg': '#f0f',
                    '--side-panel-close-hover': '#c0c',
                    '--side-panel-label': '#0ff',
                    '--side-panel-value': '#fff',
                    '--cluster-opacity': '0.9',
                    '--cluster-border-color': '#0ff',
                    '--cluster-border-width': '1.5px',
                    '--cluster-border-dash': '8,4',
                    '--cluster-bg-color': 'rgba(0, 255, 255, 0.05)',
                    '--cluster-border-hover': '#0ff',
                    '--cluster-border-width-hover': '2px',
                    '--cluster-bg-hover': 'rgba(0, 255, 255, 0.08)',
                },
            };
            
            const theme = themes[themeName] || themes.light;
            
            Object.entries(theme).forEach(([property, value]) => {
                root.style.setProperty(property, value);
            });
            
            localStorage.setItem('selectedTheme', themeName);
            console.log('Tema aplicado:', themeName);
        }

        // Hacer funciones disponibles globalmente
        window.openSidePanel = openSidePanel;
        window.closeSidePanel = closeSidePanel;
        window.generateSidePanelContent = generateSidePanelContent;
        window.createSidePanel = createSidePanel;
        window.setTheme = setTheme;

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, iniciando aplicaci√≥n...');
            
            // Aplicar tema inicial
            const currentTheme = localStorage.getItem('selectedTheme') || 'light';
            if (window.setTheme) {
                window.setTheme(currentTheme);
                console.log('Tema inicial aplicado:', currentTheme);
            }
            
            // Configurar theme selector
            const themeSelector = document.getElementById('theme-selector');
            if (themeSelector) {
                themeSelector.value = currentTheme;
                
                themeSelector.addEventListener('change', function() {
                    const theme = this.value;
                    console.log('Cambiando tema a:', theme);
                    if (window.setTheme) {
                        window.setTheme(theme);
                    }
                });
            }
            
            // Crear sidepanel manualmente si no existe
            if (!document.getElementById('side-panel')) {
                try {
                    createSidePanel();
                    console.log('Sidepanel creado manualmente');
                } catch (error) {
                    console.error('Error al crear sidepanel manualmente:', error);
                }
            }
            
            // Configurar eventos
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeSidePanel();
                }
            });
            
            // Cargar todos los diagramas
            loadAllDiagrams();
            
            // Verificaci√≥n final de opacidad despu√©s de un tiempo
            setTimeout(() => {
                console.log('Verificaci√≥n final de opacidad...');
                forceDiagramOpacity();
                
                // Verificar si el diagrama es visible
                const mainSvg = document.getElementById('main-svg');
                if (mainSvg) {
                    const opacity = getComputedStyle(mainSvg).opacity;
                    console.log('Opacidad final del SVG:', opacity);
                }
            }, 3000);
        });
    </script>
</body>
</html> 