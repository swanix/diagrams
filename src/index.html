<!DOCTYPE html>
<html lang="es" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Diagrams</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="sw-diagrams-clean.js"></script>
    <link href="sw-diagrams.css" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: var(--bg-color, #f8f9fa);
            background-image: var(--bg-image, none);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        .swanix-diagram-container {
            height: 100vh;
            width: 100vw;
            position: relative;
        }
        .diagram-switcher {
            position: fixed; /* Cambiar a fixed para asegurar que esté siempre visible */
            top: 80px; /* Posicionar debajo del topbar */
            left: 20px;
            z-index: 9999; /* Z-index muy alto para asegurar que esté por encima de todo */
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--sidepanel-bg, #fff);
            padding: 15px;
            border-radius: 12px;
            box-shadow: none;
            border: 1px solid var(--sidepanel-border, #ddd);
            pointer-events: auto; /* Asegurar que los eventos de mouse funcionen */
            user-select: none; /* Prevenir selección de texto */
        }
        .diagram-btn {
            background: var(--control-bg, #fff);
            color: var(--control-text, #333);
            border: 2px solid var(--control-border, #d1d5db);
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            box-shadow: none;
            transition: all 0.2s ease;
            text-align: left;
            min-width: 200px;
            pointer-events: auto; /* Asegurar que los eventos de mouse funcionen */
            position: relative; /* Para z-index */
            z-index: 10001; /* Asegurar que esté por encima */
            user-select: none; /* Prevenir selección de texto */
            -webkit-user-select: none; /* Para Safari */
            -moz-user-select: none; /* Para Firefox */
            -ms-user-select: none; /* Para IE */
            text-decoration: none; /* Eliminar subrayado de links */
            display: block; /* Hacer que los links se comporten como bloques */
        }
        .diagram-btn.active {
            background: var(--control-focus, #1976d2);
            color: #fff;
            border: 2px solid var(--control-focus, #1976d2);
            box-shadow: none;
        }
        .diagram-btn:hover:not(:disabled) {
            background: var(--control-bg, #fff);
            border-color: var(--control-border-hover, #9ca3af);
            box-shadow: none;
            transform: translateY(-1px);
        }
        .diagram-btn.active:hover:not(:disabled) {
            background: var(--control-focus, #1976d2);
            border-color: var(--control-focus, #1976d2);
            transform: translateY(-1px);
        }
        .diagram-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--control-bg, #f5f5f5);
            color: var(--control-placeholder, #9ca3af);
            border-color: var(--control-border, #ddd);
            transform: none;
        }
        
        .switcher-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        /* Estilos para el fade-in suave */
        #main-diagram-svg {
            opacity: 0 !important; /* Forzar opacidad 0 por defecto */
            transition: opacity 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            visibility: visible; /* Mantener visible para que funcione el zoom */
        }
        
        #main-diagram-svg.loaded {
            opacity: 1 !important;
        }
        
        /* Asegurar que el SVG esté oculto durante la carga */
        #main-diagram-svg:not(.loaded) {
            opacity: 0 !important;
            pointer-events: none; /* Deshabilitar interacciones mientras está oculto */
        }
        
        /* Restaurar interacciones cuando el SVG está cargado */
        #main-diagram-svg.loaded {
            opacity: 1 !important;
            pointer-events: auto; /* Restaurar interacciones cuando está visible */
        }
        
        /* Estilos para el botón de tema redondo */
        .theme-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .theme-toggle {
            background: var(--control-bg, #fff);
            border: 1px solid var(--control-border, #ddd);
            border-radius: 50%; /* Botón redondo */
            width: 40px;
            height: 40px;
            padding: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .theme-toggle:hover {
            background: var(--control-border-hover, #f0f0f0);
            transform: scale(1.05);
            box-shadow: none;
        }
        
        .theme-toggle:active {
            transform: scale(0.95);
        }
        
        .theme-icon {
            width: 18px;
            height: 18px;
            color: var(--control-text, #333);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* Mostrar solo el icono de sol por defecto (tema claro) */
        .theme-toggle .moon-icon {
            display: none;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
            transition: all 0.3s ease;
        }
        
        .theme-toggle .sun-icon {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            transition: all 0.3s ease;
        }
        
        /* Cuando el tema es oscuro, mostrar solo el icono de luna */
        body.theme-onyx .theme-toggle .sun-icon,
        body.theme-neon .theme-toggle .sun-icon {
            display: none;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
        }
        
        body.theme-onyx .theme-toggle .moon-icon,
        body.theme-neon .theme-toggle .moon-icon {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

    </style>
</head>
<body>
    <!-- 
    Configuración de temas:
    - data-light-theme: Tema para modo claro (snow, vintage, pastel)
    - data-dark-theme: Tema para modo oscuro (onyx, neon)
    
    Ejemplos:
    - data-light-theme="vintage" data-dark-theme="neon" (Vintage claro, Neon oscuro)
    - data-light-theme="pastel" data-dark-theme="onyx" (Pastel claro, Onyx oscuro)
    - data-light-theme="snow" data-dark-theme="neon" (Snow claro, Neon oscuro)
    
    NOTA: Este archivo carga Snow (tema claro) por defecto en la primera visita
    -->
    <div id="swanix-diagram" class="swanix-diagram-container" 
         data-light-theme="snow" 
         data-dark-theme="onyx">
        <!-- Topbar necesario para que funcione el código -->
        <div class="topbar">
            <div class="topbar-left">
                <!-- Controles removidos temporalmente -->
            </div>
            
            <div class="topbar-center">
                <h1 class="diagram-title">Demo Multi-Diagramas</h1>
            </div>
            
            <div class="topbar-right">
                <div class="theme-controls">
                    <button id="theme-toggle" class="theme-toggle" title="Cambiar tema">
                        <svg class="theme-icon sun-icon" width="18" height="18" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="4" fill="currentColor"></circle>
                            <g stroke="currentColor" stroke-width="2" stroke-linecap="round">
                                <line x1="12" y1="1" x2="12" y2="3"></line>
                                <line x1="12" y1="21" x2="12" y2="23"></line>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                <line x1="1" y1="12" x2="3" y2="12"></line>
                                <line x1="21" y1="12" x2="23" y2="12"></line>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                            </g>
                        </svg>
                        <svg class="theme-icon moon-icon" width="18" height="18" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor"></path>
                        </svg>
                    </button>

                </div>
            </div>
        </div>

        <div class="diagram-switcher" id="diagram-switcher">
            <div class="switcher-header">
                <h4 style="margin: 0 0 10px 0; color: var(--text-color, #333);">Diagramas</h4>
            </div>
        </div>
        <svg id="main-diagram-svg"></svg>
        <div id="loading" class="loading"><div class="spinner"></div></div>
        <small id="error-message" class="error-message"></small>
    </div>
    <script>
    // Lista de diagramas predefinidos (pueden ser links externos o archivos locales)
    const diagrams = [
        {
            name: "Org Chart (Google Sheets)",
            url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTQZfZhC3cWHg0QkqRoY9i3alinAnSHab5DJtWzsm_xAhLKKJdHri8fBMUawh-DhpvCkm-G1vBeWPFq/pub?gid=466976322&single=true&output=csv"
        },
        {
            name: "Tree Simple (Local)",
            url: "./data/tree-simple.csv"
        },
        {
            name: "Company Structure (Local)",
            url: "./data/company-structure.csv"
        },
        {
            name: "Sample Diagram (Local)",
            url: "./data/sample-diagram.csv"
        },
        {
            name: "Sitemap Demo (Local)",
            url: "../docs/demo/sitemap/data/sitemap.csv"
        }
    ];

    let currentDiagramIdx = 0;
    let isLoading = false; // Flag para prevenir cargas múltiples
    let loadedDiagrams = new Map(); // Cache de diagramas cargados
    let currentUrl = null; // URL actual para evitar recargas innecesarias
    
    // Función para obtener el índice del diagrama desde la URL
    function getDiagramIndexFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const diagramId = urlParams.get('d'); // Parámetro corto
        if (diagramId !== null) {
            const index = parseInt(diagramId);
            if (!isNaN(index) && index >= 0 && index < diagrams.length) {
                return index;
            }
        }
        return 0; // Default al primer diagrama
    }
    
    // Función para actualizar el título del topbar
    function updateTopbarTitle(diagramIndex) {
        const titleElement = document.querySelector('.diagram-title');
        if (titleElement && diagrams[diagramIndex]) {
            titleElement.textContent = diagrams[diagramIndex].name;
        }
    }
    


    function renderDiagramButtons() {
        const switcher = document.getElementById('diagram-switcher');
        console.log('Renderizando botones de diagramas, switcher:', switcher);
        
        if (!switcher) {
            console.error('No se encontró el elemento diagram-switcher');
            return;
        }
        
        // Preservar el header y limpiar solo los botones
        const header = switcher.querySelector('.switcher-header');
        switcher.innerHTML = '';
        if (header) {
            switcher.appendChild(header);
        }
        
        console.log('Creando', diagrams.length, 'links para diagramas');
        diagrams.forEach((d, idx) => {
            const link = document.createElement('a');
            link.href = `?d=${idx}`; // URL con parámetro del diagrama
            link.className = 'diagram-btn' + (idx === currentDiagramIdx ? ' active' : '');
            link.textContent = d.name;
            link.style.textDecoration = 'none'; // Eliminar subrayado del link
            
            // Deshabilitar link durante la carga
            if (isLoading) {
                link.style.pointerEvents = 'none';
                link.style.opacity = '0.5';
            }
            
            // Usar addEventListener para mayor compatibilidad
            link.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('Link clickeado:', d.name, 'índice:', idx, 'isLoading:', isLoading);
                if (currentDiagramIdx !== idx && !isLoading) {
                    console.log('Procesando clic del link:', d.name);
                    
                    // Actualizar URL sin disparar popstate
                    const url = new URL(window.location);
                    url.searchParams.set('d', idx.toString());
                    window.history.pushState({}, '', url);
                    
                    currentDiagramIdx = idx;
                    updateTopbarTitle(idx); // Actualizar título del topbar
                    renderDiagramButtons();
                    loadDiagram(d.url);
                } else {
                    console.log('Link ignorado - currentDiagramIdx:', currentDiagramIdx, 'idx:', idx, 'isLoading:', isLoading);
                }
            });
            
            // Agregar también un event listener de mouseenter para debug
            link.addEventListener('mouseenter', () => {
                console.log('Mouse sobre link:', d.name);
            });
            
            switcher.appendChild(link);
            console.log('Link creado:', d.name);
        });
        
        console.log('Links renderizados. Total de links:', switcher.querySelectorAll('.diagram-btn').length);
    }

    function loadDiagram(url) {
        console.log('loadDiagram llamado con URL:', url);
        
        // Prevenir cargas múltiples
        if (isLoading) {
            console.log('Carga en progreso, ignorando nueva solicitud');
            return;
        }
        
        isLoading = true;
        currentUrl = url;
        
        // Limpiar cache para forzar recarga completa
        clearCache();
        
        // Cancelar cualquier transición en progreso
        const svgD3 = d3.select("#main-diagram-svg");
        if (!svgD3.empty()) {
            svgD3.interrupt(); // Interrumpir transiciones en progreso
        }
        
        // Mostrar loading
        const loading = document.getElementById('loading');
        if (loading) loading.style.display = 'block';
        
        // Limpiar SVG y ocultarlo completamente de golpe
        const svg = document.getElementById('main-diagram-svg');
        if (svg) {
            // Ocultar el SVG de golpe sin transición
            svg.style.transition = 'none'; // Deshabilitar transiciones
            svg.style.opacity = '0';
            svg.classList.remove('loaded');
            svg.style.pointerEvents = 'none';
            
            // Limpiar el contenido inmediatamente
            svg.innerHTML = '';
            
            console.log('SVG ocultado y limpiado de golpe para nueva carga');
        }
        
        // Limpiar mensajes de error
        const error = document.getElementById('error-message');
        if (error) error.textContent = '';
        
        // Controles removidos temporalmente
        
        // Llamar a la función global para cargar el diagrama
        if (window.initDiagram) {
            console.log('Llamando a initDiagram con URL:', url);
            
            // Usar la versión limpia con flujo simplificado
            window.initDiagram(url, function() {
                console.log('initDiagram completado con versión limpia');
                
                // Aplicar zoom automático (solo una vez)
                if (window.applyAutoZoom) {
                    console.log('Aplicando zoom automático');
                    window.applyAutoZoom();
                }
                
                // Mostrar el nuevo diagrama de golpe
                setTimeout(() => {
                    // Ocultar loading
                    const loading = document.getElementById('loading');
                    if (loading) loading.style.display = 'none';
                    
                    // Mostrar el SVG de golpe sin transición
                    const svg = document.getElementById("main-diagram-svg");
                    if (svg) {
                        console.log('Mostrando nuevo diagrama de golpe');
                        
                        // Restaurar transiciones y mostrar de golpe
                        svg.style.transition = ''; // Restaurar transiciones CSS
                        svg.style.opacity = '1';
                        svg.classList.add('loaded');
                        svg.style.pointerEvents = 'auto';
                        
                        console.log('Pointer events habilitados');
                        
                        // Aplicar zoom behavior y configurar cierre del panel
                        if (window.ensureZoomBehavior) {
                            window.ensureZoomBehavior();
                        }
                        
                        if (window.setupClosePanelOnSvgClick) {
                            window.setupClosePanelOnSvgClick();
                        }
                    }
                    
                    // Marcar como no cargando
                    isLoading = false;
                }, 100); // Reducir delay para transición más rápida
            });
            
            // Timeout de seguridad
            setTimeout(() => {
                if (isLoading) {
                    console.warn('Timeout de carga del diagrama');
                    const loading = document.getElementById('loading');
                    if (loading) loading.style.display = 'none';
                    const svg = document.getElementById('main-diagram-svg');
                    if (svg) svg.classList.add('loaded');
                    isLoading = false;
                    currentUrl = null;
                }
            }, 10000);
        } else {
            console.error('initDiagram no está disponible');
            isLoading = false;
        }
    }

    // Función para limpiar cache si es necesario
    function clearCache() {
        loadedDiagrams.clear();
        currentUrl = null;
    }
    
    // Función para actualizar estilos de los botones según el tema
    function updateButtonStyles() {
        const switcher = document.getElementById('diagram-switcher');
        if (switcher) {
            // Los estilos CSS ya usan variables, pero podemos forzar una actualización
            switcher.style.setProperty('--sidepanel-bg', getComputedStyle(document.documentElement).getPropertyValue('--sidepanel-bg'));
            switcher.style.setProperty('--sidepanel-border', getComputedStyle(document.documentElement).getPropertyValue('--sidepanel-border'));
        }
    }

    // Función para actualizar estilos según el tema
    function updateThemeStyles() {
        // Obtener todas las variables CSS del tema actual
        const computedStyle = getComputedStyle(document.documentElement);
        const cssVariables = [
            '--bg-color', '--text-color', '--node-fill', '--label-border', '--link-color',
            '--topbar-bg', '--topbar-text', '--sidepanel-bg', '--sidepanel-text', '--sidepanel-border',
            '--side-panel-bg', '--side-panel-text', '--side-panel-header-bg', '--side-panel-header-border',
            '--side-panel-border', '--side-panel-label', '--side-panel-value', '--side-panel-close-bg',
            '--side-panel-close-hover', '--side-panel-shadow',
            '--control-bg', '--control-text', '--control-border', '--control-border-hover',
            '--control-border-focus', '--control-placeholder', '--control-shadow', '--control-shadow-focus',
            '--node-selection-focus', '--node-selection-border', '--node-selection-hover', '--node-selection-selected',
            '--image-filter', '--loading-color', '--loading-bg', '--bg-image', '--bg-opacity',
            '--cluster-bg', '--cluster-stroke', '--cluster-title-color'
        ];
        
        // Aplicar variables CSS a todos los elementos relevantes
        const elementsToUpdate = [
            document.documentElement,
            document.body,
            document.querySelector('.swanix-diagram-container'),
            ...document.querySelectorAll('.diagram-switcher'),
            ...document.querySelectorAll('.topbar'),
            ...document.querySelectorAll('.diagram-btn'),
        ].filter(el => el);
        
        elementsToUpdate.forEach(element => {
            cssVariables.forEach(varName => {
                const value = computedStyle.getPropertyValue(varName);
                if (value && value.trim() !== '') {
                    element.style.setProperty(varName, value);
                }
            });
        });
        
        // Aplicar específicamente el fondo y la imagen de fondo al body y html
        const bgColor = computedStyle.getPropertyValue('--bg-color');
        const bgImage = computedStyle.getPropertyValue('--bg-image');
        if (bgColor && bgColor.trim() !== '') {
            document.body.style.backgroundColor = bgColor;
            document.documentElement.style.backgroundColor = bgColor;
        }
        if (bgImage && bgImage.trim() !== 'none') {
            document.body.style.backgroundImage = bgImage;
            document.documentElement.style.backgroundImage = bgImage;
        } else {
            document.body.style.backgroundImage = 'none';
            document.documentElement.style.backgroundImage = 'none';
        }
    }
    
    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded iniciado');
        
        // Inicializar el sistema de temas
        if (window.initializeThemeSystem && !window.themeSystemInitialized) {
            window.initializeThemeSystem();
            window.themeSystemInitialized = true;
        }
        
        // Obtener el diagrama desde la URL o usar el default
        currentDiagramIdx = getDiagramIndexFromURL();
        console.log('Índice del diagrama inicial:', currentDiagramIdx);
        
        // Actualizar el título del topbar con el diagrama inicial
        updateTopbarTitle(currentDiagramIdx);
        
        // Asegurar que el SVG comience oculto
        const svg = document.getElementById('main-diagram-svg');
        if (svg) {
            svg.classList.remove('loaded');
        }
        
        // Verificar que el elemento diagram-switcher esté presente antes de renderizar
        const switcher = document.getElementById('diagram-switcher');
        if (switcher) {
            console.log('Elemento diagram-switcher encontrado, renderizando botones');
            renderDiagramButtons();
            loadDiagram(diagrams[currentDiagramIdx].url);
        } else {
            console.error('Elemento diagram-switcher NO encontrado en DOMContentLoaded');
            // Reintentar después de un breve delay
            setTimeout(() => {
                const retrySwitcher = document.getElementById('diagram-switcher');
                if (retrySwitcher) {
                    console.log('Elemento diagram-switcher encontrado en retry, renderizando botones');
                    renderDiagramButtons();
                    loadDiagram(diagrams[currentDiagramIdx].url);
                } else {
                    console.error('Elemento diagram-switcher NO encontrado en retry');
                }
            }, 100);
        }
        
        // Observer para detectar cambios en las variables CSS del tema
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    updateButtonStyles();
                }
            });
        });
        
        // Observar cambios en el contenedor principal
        const container = document.querySelector('.swanix-diagram-container');
        if (container) {
            observer.observe(container, {
                attributes: true,
                attributeFilter: ['style']
            });
        }
        

        
        // Listener para navegación del navegador (botones atrás/adelante)
        window.addEventListener('popstate', function(event) {
            // Solo procesar si no es una navegación programática
            if (!event.state || Object.keys(event.state).length === 0) {
                const newIndex = getDiagramIndexFromURL();
                if (newIndex !== currentDiagramIdx && !isLoading) {
                    console.log('Navegación del navegador detectada, cargando diagrama:', newIndex);
                    currentDiagramIdx = newIndex;
                    updateTopbarTitle(currentDiagramIdx); // Actualizar título del topbar
                    renderDiagramButtons();
                    loadDiagram(diagrams[currentDiagramIdx].url);
                }
            }
        });
        

    });
    </script>
</body>
</html> 