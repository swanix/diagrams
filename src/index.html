<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Swanix Diagrams - Complex</title>
  <script src="xloader.js"></script>
  <link href="xdiagrams.css" rel="stylesheet">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <style>
    /* Drag & Drop Styles */
    .xcanvas {
      position: relative;
      transition: all 0.3s ease;
    }
    
    .xcanvas.drag-over {
      background: rgba(25, 118, 210, 0.1) !important;
      border: 3px dashed var(--control-border-focus) !important;
      border-radius: 12px;
    }
    
    .drag-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(25, 118, 210, 0.15);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      pointer-events: none;
    }
    
    .drag-overlay.active {
      display: flex;
    }
    
    .drag-message {
      background: var(--control-bg);
      border: 2px solid var(--control-border-focus);
      border-radius: 12px;
      padding: 20px 30px;
      font-size: 18px;
      font-weight: 600;
      color: var(--control-text);
      box-shadow: var(--control-shadow);
      text-align: center;
    }
    
    .drag-message .icon {
      font-size: 48px;
      margin-bottom: 10px;
      display: block;
    }
    
    .file-drop-zone {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--control-bg);
      border: 2px dashed var(--control-border);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      color: var(--control-text);
      font-size: 16px;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .file-drop-zone.active {
      opacity: 1;
      pointer-events: auto;
      border-color: var(--control-border-focus);
      background: rgba(25, 118, 210, 0.05);
    }
    
    .file-drop-zone .icon {
      font-size: 64px;
      margin-bottom: 20px;
      display: block;
      color: var(--control-border-focus);
    }
    
    .file-drop-zone .text {
      margin-bottom: 10px;
      font-weight: 600;
    }
    
    .file-drop-zone .subtext {
      font-size: 14px;
      opacity: 0.7;
    }
  </style>
</head>
<body>
<div class="xcanvas">
  <div class="file-drop-zone" id="fileDropZone">
    <span class="icon">üìÅ</span>
    <div class="text">Suelta tu archivo CSV aqu√≠</div>
    <div class="subtext">o arrastra desde tu computadora</div>
  </div>
</div>

<div class="drag-overlay" id="dragOverlay">
  <div class="drag-message">
    <span class="icon">üìÑ</span>
    <div>Suelta para cargar el archivo</div>
  </div>
</div>

<script>
window.$xDiagrams = {
  title: "My Diagrams",
  diagrams: [
    {
      name: "Diagram 1", 
      url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT1F3LXPwnGlnF_uOlhoR-5kK1DrWLwlCAKH8Ag6hPrNLzwqWYWU8ofE19xSv4cH1-Cq7ZYm7lPys7V/pub?output=csv"
    },
    {
      name: "Diagram 2", 
      url: "data/one-cluster.csv"
    },
    {
      name: "Diagram 3", 
      url: "data/multi-clusters.csv"
    }
  ],
  themes: {
    light: "snow",
    dark: "onyx",
    default: "snow"
  },
  columns: {
    id: "Node",
    name: "Name", 
    parent: "Parent",
    img: "Type",
    url: "URL",
    type: "Type",
    subtitle: "Description"
  },
  options: {
    autoZoom: true,
    keyboardNavigation: true,
    sidePanel: true,
    tooltips: true,
    responsive: true,
    dragAndDrop: true
  },
  hooks: {
    onLoad: function(diagram) {
      console.log('XDiagrams - Diagram loaded:', diagram.name);
    },
    onThemeChange: function(theme) {
      console.log('XDiagrams - Theme changed to:', theme);
    },
    onNodeClick: function(node) {
      console.log('XDiagrams - Node clicked:', node.name);
    },
    onFileDrop: function(file) {
      console.log('XDiagrams - File dropped:', file.name);
    }
  }
};

// Drag & Drop functionality
(function() {
  'use strict';
  
  const canvas = document.querySelector('.xcanvas');
  const fileDropZone = document.getElementById('fileDropZone');
  const dragOverlay = document.getElementById('dragOverlay');
  
  // Load saved diagrams from localStorage
  function loadSavedDiagrams() {
    try {
      const saved = localStorage.getItem('xdiagrams-saved-files');
      if (saved) {
        const savedDiagrams = JSON.parse(saved);
        // Add saved diagrams to the configuration
        if (savedDiagrams && Array.isArray(savedDiagrams)) {
          savedDiagrams.forEach(diagram => {
            window.$xDiagrams.diagrams.push(diagram);
          });
        }
      }
    } catch (error) {
      console.warn('Error loading saved diagrams:', error);
    }
  }
  
  // Save diagram to localStorage
  function saveDiagramToStorage(diagram) {
    try {
      const saved = localStorage.getItem('xdiagrams-saved-files');
      let savedDiagrams = saved ? JSON.parse(saved) : [];
      
      // Check if diagram already exists
      const exists = savedDiagrams.find(d => d.name === diagram.name);
      if (!exists) {
        savedDiagrams.push(diagram);
        localStorage.setItem('xdiagrams-saved-files', JSON.stringify(savedDiagrams));
        console.log('Diagram saved to localStorage:', diagram.name);
      }
    } catch (error) {
      console.error('Error saving diagram to localStorage:', error);
    }
  }
  
  // Process CSV file
  function processCSVFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const csvContent = e.target.result;
          Papa.parse(csvContent, {
            header: true,
            complete: function(results) {
              if (results.errors.length > 0) {
                reject(new Error('Error parsing CSV: ' + results.errors[0].message));
                return;
              }
              
              // Create diagram object
              const diagram = {
                name: file.name.replace('.csv', ''),
                url: null, // Local file, no URL
                data: results.data,
                isLocal: true,
                timestamp: new Date().toISOString(),
                hash: window.simpleHash(csvContent)
              };
              
              resolve(diagram);
            },
            error: function(error) {
              reject(new Error('Error parsing CSV: ' + error.message));
            }
          });
        } catch (error) {
          reject(error);
        }
      };
      
      reader.onerror = function() {
        reject(new Error('Error reading file'));
      };
      
      reader.readAsText(file);
    });
  }
  
  // Add diagram to switcher and load it
  function addAndLoadDiagram(diagram) {
    // Add to configuration
    window.$xDiagrams.diagrams.push(diagram);
    
    // Save to localStorage
    saveDiagramToStorage(diagram);
    
    // Trigger hook
    if (window.$xDiagrams.hooks.onFileDrop) {
      window.$xDiagrams.hooks.onFileDrop(diagram);
    }
    
    // Reload the diagram system to include the new diagram
    if (window.reloadDiagramSystem) {
      window.reloadDiagramSystem();
    } else {
      // Fallback: reload the page
      setTimeout(() => {
        window.location.reload();
      }, 500);
    }
  }
  
  // Handle file drop
  function handleFileDrop(e) {
    e.preventDefault();
    
    // Hide drag overlay
    dragOverlay.classList.remove('active');
    fileDropZone.classList.remove('active');
    canvas.classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      const file = files[0];
      
      // Check if it's a CSV file
      if (file.type === 'text/csv' || file.name.toLowerCase().endsWith('.csv')) {
        processCSVFile(file)
          .then(diagram => {
            window.addAndLoadDiagram(diagram);
          })
          .catch(error => {
            console.error('Error processing file:', error);
            alert('Error al procesar el archivo: ' + error.message);
          });
      } else {
        alert('Por favor, selecciona un archivo CSV v√°lido.');
      }
    }
  }
  
  // Drag event handlers
  function handleDragEnter(e) {
    e.preventDefault();
    canvas.classList.add('drag-over');
    dragOverlay.classList.add('active');
  }
  
  function handleDragOver(e) {
    e.preventDefault();
  }
  
  function handleDragLeave(e) {
    e.preventDefault();
    // Only remove drag state if we're leaving the canvas completely
    if (!canvas.contains(e.relatedTarget)) {
      canvas.classList.remove('drag-over');
      dragOverlay.classList.remove('active');
    }
  }
  
  // Initialize drag & drop
  function initDragAndDrop() {
    if (!window.$xDiagrams.options.dragAndDrop) {
      return;
    }
    
    // Load saved diagrams
    loadSavedDiagrams();
    
    // Add event listeners
    canvas.addEventListener('dragenter', handleDragEnter);
    canvas.addEventListener('dragover', handleDragOver);
    canvas.addEventListener('dragleave', handleDragLeave);
    canvas.addEventListener('drop', handleFileDrop);
    
    // Prevent default drag behaviors on the document
    document.addEventListener('dragenter', function(e) {
      e.preventDefault();
    });
    
    document.addEventListener('dragover', function(e) {
      e.preventDefault();
    });
    
    document.addEventListener('drop', function(e) {
      e.preventDefault();
    });
  }
  
  // Initialize when DOM is ready
  function initDragAndDropDelayed() {
    // Wait for the sw-diagram container to be created
    const swDiagram = document.getElementById('sw-diagram');
    if (swDiagram) {
      // Update canvas reference to the new container
      canvas = swDiagram;
      initDragAndDrop();
    } else {
      // Try again in 100ms
      setTimeout(initDragAndDropDelayed, 100);
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDragAndDropDelayed);
  } else {
    initDragAndDropDelayed();
  }
})();
</script>
<script src="xdiagrams.js"></script>
</body>
</html> 