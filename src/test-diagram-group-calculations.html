<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: C√°lculos Basados en Diagram-Group</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }
        .test-info {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-info h2 {
            margin-top: 0;
            color: #4CAF50;
        }
        .test-info ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .test-info li {
            margin: 5px 0;
        }
        #sw-diagram {
            width: 100%;
            height: 80vh;
            border: 2px solid #444;
            border-radius: 8px;
            background: #1a1a1a;
        }
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        .diagram-group-analysis {
            background: #222;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 11px;
        }
        .gap-analysis {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="test-info">
        <h2>üß™ Test: C√°lculos Basados en Diagram-Group</h2>
        <p><strong>Objetivo:</strong> Verificar que los c√°lculos de anchos y posiciones se basan correctamente en el diagram-group despu√©s de la carga completa.</p>
        
        <h3>Cambios aplicados:</h3>
        <ul>
            <li>‚úÖ Medici√≥n directa del diagram-group usando getBBox()</li>
            <li>‚úÖ C√°lculos basados en el ancho final del diagram-group</li>
            <li>‚úÖ Verificaci√≥n de gaps usando informaci√≥n del diagram-group</li>
            <li>‚úÖ Logs detallados de bounds originales del diagram-group</li>
            <li>‚úÖ Posicionamiento preciso basado en diagram-group</li>
        </ul>
        
        <h3>Resultado esperado:</h3>
        <ul>
            <li>üîç Anchos medidos directamente del diagram-group</li>
            <li>üîç Gaps exactos de 60px entre diagram-groups</li>
            <li>üîç Primer diagram-group empieza a 50px del borde izquierdo</li>
            <li>üîç Posiciones calculadas usando bounds reales del diagram-group</li>
            <li>üîç Sin afectaci√≥n por transformaciones o mediciones anteriores</li>
        </ul>
    </div>

    <div class="status" id="status">Cargando...</div>

    <div id="sw-diagram"></div>

    <div class="diagram-group-analysis" id="diagramGroupAnalysis"></div>
    <div class="gap-analysis" id="gapAnalysis"></div>

    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- PapaParse para CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <!-- Swanix Diagrams -->
    <link rel="stylesheet" href="xdiagrams.css">
    <script src="xdiagrams.js"></script>
    <script src="xloader.js"></script>

    <script>
        // Configuraci√≥n de prueba con clusters de diferentes tama√±os
        window.$xDiagrams = {
            diagrams: [
                {
                    name: "Test: Diagram-Group Calculations",
                    url: "data/multi-clusters.csv"
                }
            ],
            options: {
                theme: 'onyx',
                autoZoom: true,
                sidePanel: true,
                keyboardNavigation: true
            }
        };

        // Funci√≥n para actualizar el status
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Funci√≥n para mostrar an√°lisis de diagram-groups
        function showDiagramGroupAnalysis() {
            const diagramGroups = document.querySelectorAll('.diagram-group');
            const analysisDiv = document.getElementById('diagramGroupAnalysis');
            let analysis = '<strong>An√°lisis de Diagram-Groups:</strong><br>';
            
            diagramGroups.forEach((group, index) => {
                const bounds = group.getBBox();
                const transform = group.getAttribute('transform');
                const rect = group.querySelector('.cluster-rect');
                const rectBounds = rect ? rect.getBBox() : null;
                
                analysis += `Diagram-Group ${index}:<br>`;
                analysis += `  Bounds: x=${bounds.x.toFixed(1)}, y=${bounds.y.toFixed(1)}, w=${bounds.width.toFixed(1)}, h=${bounds.height.toFixed(1)}<br>`;
                analysis += `  Transform: ${transform || 'none'}<br>`;
                
                if (rectBounds) {
                    analysis += `  Cluster-Rect: x=${rectBounds.x.toFixed(1)}, y=${rectBounds.y.toFixed(1)}, w=${rectBounds.width.toFixed(1)}, h=${rectBounds.height.toFixed(1)}<br>`;
                }
                
                analysis += `<br>`;
            });
            
            analysisDiv.innerHTML = analysis;
        }

        // Funci√≥n para mostrar an√°lisis de gaps entre diagram-groups
        function showGapAnalysis() {
            const diagramGroups = document.querySelectorAll('.diagram-group');
            const analysisDiv = document.getElementById('gapAnalysis');
            let analysis = '<strong>An√°lisis de Gaps entre Diagram-Groups:</strong><br>';
            
            // Verificar gaps entre diagram-groups consecutivos
            for (let i = 0; i < diagramGroups.length - 1; i++) {
                const group1 = diagramGroups[i];
                const group2 = diagramGroups[i + 1];
                const bounds1 = group1.getBBox();
                const bounds2 = group2.getBBox();
                
                // Obtener transformaciones
                const transform1 = group1.getAttribute('transform');
                const transform2 = group2.getAttribute('transform');
                
                // Calcular posiciones reales considerando transformaciones
                let x1 = bounds1.x;
                let x2 = bounds2.x;
                
                if (transform1) {
                    const match1 = /translate\(([-\d.]+), ?([-\d.]+)\)/.exec(transform1);
                    if (match1) {
                        x1 += parseFloat(match1[1]) || 0;
                    }
                }
                
                if (transform2) {
                    const match2 = /translate\(([-\d.]+), ?([-\d.]+)\)/.exec(transform2);
                    if (match2) {
                        x2 += parseFloat(match2[1]) || 0;
                    }
                }
                
                const actualGap = x2 - (x1 + bounds1.width);
                const expectedGap = 60;
                const gapDiff = Math.abs(actualGap - expectedGap);
                const status = gapDiff < 5 ? '‚úÖ' : '‚ùå';
                
                analysis += `${status} Gap ${i}‚Üí${i+1}: ${actualGap.toFixed(1)}px (esperado: ${expectedGap}px, diff: ${gapDiff.toFixed(1)}px)<br>`;
                analysis += `  Diagram-Group ${i}: ancho=${bounds1.width.toFixed(1)}px, fin=${(x1 + bounds1.width).toFixed(1)}px<br>`;
                analysis += `  Diagram-Group ${i+1}: ancho=${bounds2.width.toFixed(1)}px, inicio=${x2.toFixed(1)}px<br>`;
            }
            
            // Verificar posici√≥n del primer diagram-group
            if (diagramGroups.length > 0) {
                const firstGroup = diagramGroups[0];
                const firstBounds = firstGroup.getBBox();
                const firstTransform = firstGroup.getAttribute('transform');
                
                let firstX = firstBounds.x;
                if (firstTransform) {
                    const match = /translate\(([-\d.]+), ?([-\d.]+)\)/.exec(firstTransform);
                    if (match) {
                        firstX += parseFloat(match[1]) || 0;
                    }
                }
                
                const svg = document.getElementById('main-diagram-svg');
                const svgBounds = svg.getBoundingClientRect();
                const distanceFromCanvas = firstX - svgBounds.left;
                const expectedMargin = 50;
                const marginDiff = Math.abs(distanceFromCanvas - expectedMargin);
                const status = marginDiff < 10 ? '‚úÖ' : '‚ùå';
                
                analysis += `<br><strong>Posici√≥n del Primer Diagram-Group:</strong><br>`;
                analysis += `${status} Distancia desde canvas: ${distanceFromCanvas.toFixed(1)}px (esperado: ${expectedMargin}px, diff: ${marginDiff.toFixed(1)}px)<br>`;
            }
            
            analysisDiv.innerHTML = analysis;
        }

        // Hook para detectar cuando se completa el layout
        window.$xDiagrams.hooks = {
            onLayoutComplete: function() {
                updateStatus('‚úÖ Layout completado - Analizando diagram-groups...');
                
                setTimeout(() => {
                    showDiagramGroupAnalysis();
                    showGapAnalysis();
                    
                    // Verificar en consola tambi√©n
                    const diagramGroups = document.querySelectorAll('.diagram-group');
                    const svg = document.getElementById('main-diagram-svg');
                    const svgBounds = svg.getBoundingClientRect();
                    
                    console.log('=== AN√ÅLISIS DE DIAGRAM-GROUPS ===');
                    console.log(`Canvas: ancho=${svgBounds.width.toFixed(1)}px, borde_izq=${svgBounds.left.toFixed(1)}px`);
                    console.log(`Diagram-groups encontrados: ${diagramGroups.length}`);
                    
                    // An√°lisis de diagram-groups
                    diagramGroups.forEach((group, index) => {
                        const bounds = group.getBBox();
                        const transform = group.getAttribute('transform');
                        console.log(`Diagram-Group ${index}:`);
                        console.log(`  Bounds: x=${bounds.x.toFixed(1)}, y=${bounds.y.toFixed(1)}, w=${bounds.width.toFixed(1)}, h=${bounds.height.toFixed(1)}`);
                        console.log(`  Transform: ${transform || 'none'}`);
                    });
                    
                    // An√°lisis de gaps
                    console.log('\n=== AN√ÅLISIS DE GAPS ENTRE DIAGRAM-GROUPS ===');
                    for (let i = 0; i < diagramGroups.length - 1; i++) {
                        const group1 = diagramGroups[i];
                        const group2 = diagramGroups[i + 1];
                        const bounds1 = group1.getBBox();
                        const bounds2 = group2.getBBox();
                        
                        // Calcular posiciones reales
                        let x1 = bounds1.x;
                        let x2 = bounds2.x;
                        
                        const transform1 = group1.getAttribute('transform');
                        const transform2 = group2.getAttribute('transform');
                        
                        if (transform1) {
                            const match1 = /translate\(([-\d.]+), ?([-\d.]+)\)/.exec(transform1);
                            if (match1) {
                                x1 += parseFloat(match1[1]) || 0;
                            }
                        }
                        
                        if (transform2) {
                            const match2 = /translate\(([-\d.]+), ?([-\d.]+)\)/.exec(transform2);
                            if (match2) {
                                x2 += parseFloat(match2[1]) || 0;
                            }
                        }
                        
                        const actualGap = x2 - (x1 + bounds1.width);
                        const expectedGap = 60;
                        const gapDiff = Math.abs(actualGap - expectedGap);
                        const status = gapDiff < 5 ? '‚úÖ' : '‚ùå';
                        
                        console.log(`${status} Gap entre diagram-group ${i} y ${i+1}: ${actualGap.toFixed(1)}px (esperado: ${expectedGap}px, diff: ${gapDiff.toFixed(1)}px)`);
                        console.log(`  Diagram-Group ${i}: ancho=${bounds1.width.toFixed(1)}px, fin=${(x1 + bounds1.width).toFixed(1)}px`);
                        console.log(`  Diagram-Group ${i+1}: ancho=${bounds2.width.toFixed(1)}px, inicio=${x2.toFixed(1)}px`);
                    }
                    
                    // Verificar posici√≥n del primer diagram-group
                    if (diagramGroups.length > 0) {
                        const firstGroup = diagramGroups[0];
                        const firstBounds = firstGroup.getBBox();
                        const firstTransform = firstGroup.getAttribute('transform');
                        
                        let firstX = firstBounds.x;
                        if (firstTransform) {
                            const match = /translate\(([-\d.]+), ?([-\d.]+)\)/.exec(firstTransform);
                            if (match) {
                                firstX += parseFloat(match[1]) || 0;
                            }
                        }
                        
                        const distanceFromCanvas = firstX - svgBounds.left;
                        const expectedMargin = 50;
                        const marginDiff = Math.abs(distanceFromCanvas - expectedMargin);
                        const status = marginDiff < 10 ? '‚úÖ' : '‚ùå';
                        
                        console.log(`\n${status} Primer diagram-group: distancia desde canvas = ${distanceFromCanvas.toFixed(1)}px (esperado: ${expectedMargin}px, diff: ${marginDiff.toFixed(1)}px)`);
                    }
                    
                    updateStatus('‚úÖ An√°lisis de diagram-groups completado');
                }, 1000);
            }
        };

        // Inicializar cuando est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('üîÑ Inicializando...');
            
            if (window.initializeWhenReady) {
                window.initializeWhenReady();
            }
        });
    </script>
</body>
</html> 